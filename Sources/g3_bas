1 REMark Genealogist v3
5 REMark 1993-8 Chris Boutal
9 REMark Some Improvements by Rich Mellor
13 REMark $$asmb=win2_UTILS_RWAPTK_cde,10,62
17 REMark $$asmb=win2_UTILS_THING_ext,0,12
21 REMark $$asmb=WIN4_DIY_FZ_INARRAY_code,0,328
25 REMark $$stak=8192
29 REMark $$heap=4096
33 REMark $$chan=21
37 REMark $$buff=256
41 outlnx=512:outlny=256
45 cd$=cmd$:tree$=''
49 IF LEN(cd$)>3
53   x="x" INSTR cd$
57   x2="\" INSTR cd$
61   IF x2<x OR x2=0:IF "_net" INSTR cd$:x=0
65   IF x>1 AND x<LEN(cd$)
69     outlnx=cd$(1 TO x-1)
73     IF x2=0:outlny=cd$(x+1 TO ):ELSE outlny=cd$(x+1 TO x2-1)
77     IF '_net' INSTR cd$>x2:tree$=cd$(x2+1 TO )
81   ELSE
85     IF '_net' INSTR cd$>x2:tree$=cd$(x2+1 TO )
89   END IF
93 END IF
94 xscr=FOPEN('con'):PRINT #xscr,outlnx,outlny,tree$:PAUSE #xscr:CLOSE #xscr
97 qlg_ver$="3.26":compiler_ver$="3.36":pointer_ver$="0.14"
101 temp$=DATE$
103 exiting=0
105 con_ver$="2":this_year=INT(temp$(1 TO 4))
109 IF this_year<2000:this_year=2000
113 IF DATE<1.238E9:SDATE this_year,4,1,0,0,0
117 :
121 DEFine PROCedure initialise
125 setup_search:setup_find:exit_flag=0:user_title$='':old_file$=''
129 num_del=0:lr_col=-1:change_setup=0:max_dist=50
133 pcwx=0:pcwy=0:start_person=1:stat_length=0:max_chan=20:max_len=20:list_form=0
137 ft_chan=7:stat_chan=6:err_chan=8:res_chan=4:pr_chan=10:sub_chan=19
141 data_chan=5:menu_chan=3:eve_chan=12:ide_chan=11:tree_chan=16:table_chan=14
145 io_chan=9:back_chan=17:stick_chan=15:ft1_chan=18:head_chan=20
149 DIM order_flag%(4):hist_pos=0
151 max_history=100
153 DIM colours%(max_chan,2),history%(max_history),rank%(12)
157 DIM Spare$(1)
161 FOR i=ft_chan,ft1_chan,tree_chan,back_chan:colours%(i,0)=2:colours%(i,1)=7:colours%(i,2)=5
165 FOR i=table_chan,menu_chan,sub_chan:colours%(i,0)=0:colours%(i,1)=7:colours%(i,2)=5
169 FOR i=stat_chan,err_chan:colours%(i,0)=3:colours%(i,1)=7:colours%(i,2)=5
173 FOR i=stick_chan:colours%(i,0)=7:colours%(i,1)=0:colours%(i,2)=5
177 FOR i=pr_chan,res_chan:colours%(i,0)=0:colours%(i,1)=7:colours%(i,2)=5
181 FOR i=data_chan,eve_chan:colours%(i,0)=7:colours%(i,1)=3:colours%(i,2)=5
185 file_type=0:time_inc=1:num_recs=0:pick_field=0:pick_num=0:room=50
189 units=1.609:units$='miles':id_count=0:form=0
193 tol=5:reverse_names=0
197 age_gap=10:gen_gap=50:Spare$='':line_space=60
201 max_child=50:preamble$='':postamble$=''
205 line_space$=''
209 bar$="|":eol_char$='':eol$='':mar_char$="=":lm=5:lm$=''
213 tof$=CHR$(12)
217 norefs=1:nomarks=0
221 baud_rate=0:reverse_names$='no'
225 surnum=100:len_com=20:len_place=20:len_source=10:tree_count=0:chrisnum=100
229 placepos=0:commentpos=0:sourcepos=0
233 placenum=100:commentnum=100:sourcenum=100:tree_max=room:text_file$=''
237 recs_dev$='':image_file$=''
241 DIM fount_type$(3,1,10),page_width%(3)
245 fount_type$(2,1)=CHR$(14):fount_type$(1,1)=CHR$(15):fount_type$(2,0)=CHR$(20):fount_type$(1,0)=CHR$(18):p1=0:spell=0
249 page_width%(3)=80
253 nwidth=80:cond_width=132:page_width%(0)=75:page_width%(2)=38:page_width%(1)=122
257 max_names=100:len_chris=20:len_sur=10:top_margin=3
261 bottom_margin=3:page_length=66:slot=22
265 blanks$=FILL$(' ',slot)
269 recs_file$=''
273 print_dev$="ser1":column$='on':exp_file$=''
277 rec_edits=0:max_views=1:num_edits=0:table_edits=0
281 sort_type=20:form_type=20:to_date=this_year
285 Nxtrec=1:max_recs=100
289 after=0:dest$='scr':fount_type=4
293 screen_length=INT(outlny/10)-4
297 IF screen_length>max_child:screen_length=max_child
301 column_flag=0:current_tree=0:num_names=0
305 subject=6:spouse=7:father=3:mother=4:child=9
309 person=0:current_view=0:sort_length=1:max_size=0:min_size=0
313 surpos=0:chrispos=0:num_county=0
317 DIM surname_table$(surnum,len_sur),chris_table$(chrisnum,len_chris)
321 DIM place_table$(placenum,len_place),comment_table$(commentnum,len_com)
325 DIM source_table$(sourcenum,len_source),grid_table(placenum)
329 DIM county_table%(placenum)
333 DIM sur_id%(surnum),chris_id%(chrisnum),place_id%(placenum),com_id%(commentnum)
337 DIM source_id%(sourcenum)
341 DIM title$(max_child,7),screens%(max_views,max_child,1)
345 FOR i=0 TO max_child:title$(i)='subject'
349 title$(spouse)='spouse':title$(father)='father':title$(mother)='mother'
353 init_recs
357 END DEFine
361 :
365 initialise
369 start_pointer
373 init_menus
377 DATA '   ','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'
381 DATA '1','2','3','4','5','6','7','8','9','10','11','12'
385 DATA 10,11,1,31,0,4,15,6,8,1,12,0,7,6,1,4,0,9999,0,11,10,13,14,0,23,0,17,12,16,17,0,59,0,20,30
389 DATA 'Event   ','Birth   ','Baptism ','Marriage','Death   ','Burial  ','','Remark  ','Master  ','All     '
393 DATA 'ASF','RCI','RCM','RCD','RPA','RPM','RPU','CEN','WIL','IGA','IGM','MON','OTH','CON','IDE','FAM','GIV','PLA','COM','SOU','NOT','NET','EVE','MAR','COU','REP'
397 DATA 1.841307E6,1.85118E6,1.861207E6,1.871202E6,1.881203E6,1.891205E6
401 extended_dates$=' C+-QX'
405 DATA 'Parent','Father','Mother','Child','Son','Daughter','Sibling','Brother','Sister','Uncle/Aunt','Uncle','Aunt','Nephew/Niece','Nephew','Niece','Spouse','Husband','Wife','Cousin','Cousin (M)','Cousin (F)'
409 DATA 'Family name','Date','Record id','Columns','Lines','Given first','Family first','Normal','Condensed','Expanded','Screen'
413 DATA '','','','Menu','Map','Data','Status','Family Net','Error','','Report','','Index','','Pick','Dialogue','Tree','Genealogist','Aux Family','Submenu',''
417 DATA 'All','Heads','Parents','No Issue'
421 RESTORE 377
425 DIM clock_field%(4,6),month$(12,3),note_type$(9,8),file_type$(25,3)
429 DIM num_month$(12,2),census_date(6),char_text$(14,15),chan_title$(max_chan,11)
433 DIM parent$(2,6),child$(2,8),sibling$(2,7),uncle$(2,10),nephew$(2,12),cousin$(2,10),rel_spouse$(2,7),sorted$(2,11),format$(3,12),type$(3,9),find_stat$(3,8)
437 char$='TAMSYXF/PBEVZNQ'
441 user_char$='*>+-!?#@%&<$`^='
445 FOR i%=0 TO 14:char_text$(i%)="<no text>"
449 FOR i%=0 TO 12:READ month$(i%)
453 FOR i%=1 TO 12:READ num_month$(i%)
457 FOR i%=0 TO 4
461   FOR j%=0 TO 6
465     READ clock_field%(i%,j%)
469   END FOR j%
473 END FOR i%
477 FOR i%=0 TO 9:READ note_type$(i%)
481 FOR i%=0 TO 25:READ file_type$(i%)
485 FOR i%=0 TO 5:READ census_date(i%)
489 FOR i%=0 TO 2:READ parent$(i%)
493 FOR i%=0 TO 2:READ child$(i%)
497 FOR i%=0 TO 2:READ sibling$(i%)
501 FOR i%=0 TO 2:READ uncle$(i%)
505 FOR i%=0 TO 2:READ nephew$(i%)
509 FOR i%=0 TO 2:READ rel_spouse$(i%)
513 FOR i%=0 TO 2:READ cousin$(i%)
517 FOR i%=0 TO 2:READ sorted$(i%)
521 FOR i%=0 TO 3:READ format$(i%)
525 FOR i%=0 TO 3:READ type$(i%)
529 FOR i%=0 TO max_chan:READ chan_title$(i%)
533 FOR i%=0 TO 3:READ find_stat$(i%)
537 logo
541 qwindow back_chan
545 CLS #0:CLS #1:CLS #2
549 STOP
553 :
557 DEFine PROCedure ft
561 LOCal k,bt,poll,i,show_loop,j,m$
562 TEST_MEMORY
565 REPeat poll
569   bt=get_opt(0,5,main_menu$,6,menu_chan,'',0,1)
573   SELect ON bt
577   =0:current_view=0:i=show_family(ft1_menu$)
581   =1:records
585   =2:setup_menu
589   =3:save_recs
593   =4:m$='':IF num_edits OR rec_edits OR table_edits:m$='UNSAVED EDITS'
597     IF warn(" The Current Database will be Lost ",m$,'reLoad'):NEXT poll
601     recsdev(recs_dev$):IF NOT exit_flag:exit_flag=0:reload:num_edits=0:rec_edits=0:table_edits=0
605     exit_flag=0
609   =5:m$='':IF num_edits OR rec_edits OR table_edits:m$='UNSAVED EDITS'
613     IF NOT warn(" You are about to QUIT Genealogist",m$,'Quit'):RETurn
617   END SELect
621 END REPeat poll
625 END DEFine
629 :
633 DEFine PROCedure cenprint(pp,title)
637 IF title>DIMN(screens%,2):RETurn
641 screens%(current_view,title,0)=ABS(pp)
645 IF pp<0
649   screens%(current_view,title,1)=-1
653 ELSE
657   SELect ON title
661   =subject:screens%(current_view,title,1)=1
665   =father:screens%(current_view,title,1)=2
669   =spouse:screens%(current_view,title,1)=-1
673   =mother:screens%(current_view,title,1)=3
677   =child:screens%(current_view,title,1)=4
681   END SELect
685 END IF
689 END DEFine
693 :
697 DEFine PROCedure hard_copy
701 LOCal i,x$,title
705 eol$=eol_char$:lm$=FILL$(' ',lm):dest$=print_dev$
709 column_flag=0
713 print_heads "Family Group"
717 report_title$=''
721 set_margin
725 title=0:max=0
729 FOR i=DIMN(screens%,2) TO 0 STEP -1
733   IF screens%(current_view,i,1):max=i:EXIT i
737 END FOR i
741 title=0
745 REPeat make_menu
749   IF title>max:EXIT make_menu
753   type=screens%(current_view,title,1)
757   i=screens%(current_view,title,0)
761   IF title<max:ja=screens%(current_view,title+1,0):ELSE ja=0
765   IF i>0:IF '(System Name)' INSTR full_name$(i)=1:title=title+1:NEXT make_menu
769   IF ja>0:IF '(System Name)' INSTR full_name$(ja)=1:title=title+1:NEXT make_menu
773   IF type
777     IF NOT i
781       x$='No data available'
785     ELSE
789       SELect ON type
793       =5:x$='  '&bar$
797       =4:x$='  '&bar$&'_'&full_name$(i)
801       =3,-1:x$='  '&mar_char$&' '&full_name$(i)
805       =REMAINDER :x$=full_name$(i)
809       END SELect
813     END IF
817     printer FILL$(" ",10)&x$
821   ELSE
825     printer ""
829   END IF
833   title=title+1
837 END REPeat make_menu
841 printer '':printer '':printer ''
845 qwindow stat_chan
849 qwindow err_chan
853 eol$='':lm$=''
857 CLOSE #pr_chan
861 END DEFine
865 :
869 DEFine PROCedure store_bar(x1,y1)
873 IF y1>DIMN(screens%,2):RETurn
877 screens%(current_view,y1,1)=5
881 screens%(current_view,y1,0)=x1
885 END DEFine
889 :
893 DEFine PROCedure print_family(num)
897 LOCal i%
901 IF NOT num:RETurn
905 IF '*DELETED*' INSTR full_name$(num) OR '(System Name)' INSTR full_name$(num) OR full_name$(num)=' '
909   er 'Person Does Not Exist',''
913 ELSE
917   person=ABS(num)
921 END IF
925 DIM selected(num_names)
929 set_margin
933 FOR i%=0 TO max_child
937   screens%(current_view,i%,0)=0
941   screens%(current_view,i%,1)=0
945 END FOR i%
949 FOR i%=1,2:screens%(current_view,i%,0)=-1
953 cenprint person,subject
957 do_spouse=0
961 IF fa%(person)<0
965   do_spouse=1
969   cenprint 0,father
973 ELSE
977   cenprint fa%(person),father
981 END IF
985 IF ma%(person)<0
989   do_spouse=2
993   cenprint 0,mother
997 ELSE
1001   cenprint ma%(person),mother
1005 END IF
1009 get_children person
1013 put_children
1017 SELect ON do_spouse
1021  =1:IF NOT selected(ABS(fa%(person))):cenprint fa%(person),spouse
1025    selected(ABS(fa%(person)))=1
1029  =2:IF NOT selected(ABS(ma%(person))):cenprint ma%(person),spouse
1033    selected(ABS(ma%(person)))=1
1037 END SELect
1041 store_bar xpos,5
1045 get_spice
1049 child=9:spouse=7
1053 END DEFine
1057 :
1061 DEFine PROCedure get_children(p)
1065 LOCal i,pchild,getc_loop,xi
1069 num_child=-1:i=0
1073 pchild=attach%(p) MOD 100
1077 IF NOT pchild:RETurn
1081 DIM child_table(max_child,3)
1085 dmpos=0:xi=-1:one_family_children=0
1089 REPeat getc_loop
1093   old_i=i
1097   i=next_parent(p,dmpos)
1101   IF i<>old_i:one_family_children=0
1105   IF NOT i:EXIT getc_loop
1109   num_child=num_child+1:one_family_children=one_family_children+1
1113   SELect ON num_child
1117   =pchild: EXIT getc_loop
1121   =0 TO max_child:
1125     IF '(System Name)' INSTR full_name$(i):xi=i
1129     IF one_family_children>1 AND xi>=0
1133       ma%(xi)=0:fa%(xi)=0:num_child=num_child-1:xi=-1:NEXT getc_loop
1137     END IF
1141     child_table(num_child,1)=fa%(i):child_table(num_child,2)=ma%(i)
1145     child_table(num_child,0)=i:child_table(num_child,3)=yofb(i)
1149   =REMAINDER :
1153     er "Maximum display length exceeded",""
1157     num_child=max_child:EXIT getc_loop
1161   END SELect
1165 END REPeat getc_loop
1169 IF num_child<0:RETurn
1173 DIM sort_table%(num_child),birth_table(num_child)
1177 FOR i=0 TO num_child
1181   sort_table%(i)=i
1185   birth_table(i)=child_table(i,3)
1189 END FOR i
1193 count=num_child:do_sort birth_table
1197 END DEFine
1201 :
1205 DEFine PROCedure put_children
1209 LOCal i,k,flag,mum,dad
1213 dad=0:mum=0
1217 IF num_child<0:RETurn
1221 store_bar xpos,child-1
1225 FOR i=0 TO num_child
1229   k=sort_table%(i)
1233   flag=0
1237   IF child_table(k,1)<>dad OR child_table(k,2)<>mum
1241     dad=child_table(k,1):mum=child_table(k,2)
1245     IF person=mum:cenprint dad,spouse:selected(ABS(dad))=1
1249     IF person=dad:cenprint mum,spouse:selected(ABS(mum))=1
1253     flag=1
1257     child=spouse+2
1261   END IF
1265   IF flag:store_bar xpos,child-1
1269   cenprint child_table(k,0),child
1273   child=child+1
1277   spouse=child+2
1281 END FOR i
1285 END DEFine
1289 :
1293 DEFine FuNction dates$(k)
1297 LOCal flagb,flagd,birth$,death$
1301 birth$="    ":flagb=0
1305 IF k<0:RETurn ""
1309 IF yofb(k)>99:birth$=yofb(k):flagb=1
1313 IF INT(yofb(k))<>yofb(k):birth$="    ":flagb=0
1317 death$=-yofd%(k):flagd=1
1321 IF yofd%(k)<100:death$="-    ":flagd=0
1325 IF yofd%(k)<0:death$="":flagd=0
1329 IF flagb OR flagd:RETurn " ("&birth$&death$&")":ELSE RETurn ""
1333 END DEFine
1337 :
1341 DEFine PROCedure save_data
1345 LOCal i,j
1349 m6 "Saving Segment:"&file_type$(21)
1353 DELETE recs_dev$&file_type$(21)
1357 OPEN_NEW #io_chan,recs_dev$&file_type$(21)
1361 PRINT #io_chan,num_names;',';person
1365 FOR i=1 TO num_names
1369   PUT #io_chan,i,fa%(i),ma%(i),yofb(i),yofd%(i),ftable%(i),mark%(i),user_mark%(i),gtable%(i)
1373 END FOR i
1377 CLOSE #io_chan
1381 save_markers
1385 num_edits=0
1389 qwindow stat_chan
1393 END DEFine
1397 :
1401 DEFine PROCedure add(old)
1405 LOCal i,k,kk,flag,j,m
1409 subj=person:m=0
1413 IF NOT old
1417   IF num_names
1421     m6 'Select sex and relationship to '&full_name$(subj)
1425   ELSE
1429     m6 'Select sex of first person'
1433     set_anchor 30,30,menu_chan
1437   END IF
1441   kk=show_menu(0,'Quit','Male ½','Female ½','Unknown ½','','','','')
1445   SELect ON kk
1449     =10 : RETurn
1453     =20 : m=4
1457     =30 : m=64
1461   END SELect
1465   IF subj
1469     SELect ON kk
1473     =10:RETurn
1477     =20:k=show_menu(1,'Quit','Son','Husband','Father','Brother','None','','')
1481     =30:k=show_menu(1,'Quit','Daughter','Wife','Mother','Sister','None','','')
1485     =40:k=show_menu(1,'Quit','Child','Sibling','None','','','','')
1489       IF k>20:k=k+20
1493     END SELect
1497   ELSE
1501     k=80
1505     shut menu_chan
1509   END IF
1513   IF k=10:RETurn
1517   alter=find_slot
1521   IF alter<=0:RETurn
1525   zero_names(alter)
1529 ELSE
1533   m6 "Locate other person and hit <OK>"
1537   current_view=1:print_family subj:k=show_family(ft1_menu$):qwindow stat_chan
1541   IF k:current_view=0:RETurn
1545   set_anchor 160,30,menu_chan
1549   m6 'Relationship of '&full_name$(person)&' to '&full_name$(subj)
1553   k=show_menu(0,'Quit','Child','Spouse','Parent','sIblings','','','')
1557   IF k=10:current_view=0:RETurn
1561   alter=person
1565   IF sex%(alter)=1: m=4
1569   IF sex%(alter)=2: m=64
1573 END IF
1577 IF NOT qmark%(alter,'M'):IF NOT qmark%(alter,'F'):mark%(alter)=mark%(alter)+m
1581 SELect ON k
1585 =50:REMark Add sibling
1589   IF fa%(alter)>0:IF fa%(subj)>0:IF fa%(alter)<>fa%(subj):er 'They have different Parents','Use Change to correct errors':current_view=0:person=subj:RETurn
1593   IF ma%(alter)>0:IF ma%(subj)>0:IF ma%(alter)<>ma%(subj):er 'They have different Parents','Use Change to correct errors':current_view=0:person=subj:RETurn
1597   new_dad=fa%(subj)
1601   new_mum=ma%(subj)
1605   IF fa%(alter)<>new_dad:attach%(new_dad)=attach%(new_dad)+1
1609   IF fa%(alter)<>new_dad:attach%(new_mum)=attach%(new_mum)+1
1613   yofb(alter)=yofb(subj)+.1
1617   fa%(alter)=new_dad:ma%(alter)=new_mum
1621   ftable%(alter)=ftable%(new_dad)
1625 =40:REMark Add parent
1629    SELect ON m
1633    =4:
1637      j=find_system_child(alter,ma%(subj))
1641      IF j>0:remove_person j,1
1645      fa%(subj)=alter
1649      attach%(alter)=attach%(alter)+1
1653      ftable%(alter)=ftable%(subj)
1657      IF ma%(subj)<0:ma%(subj)=0
1661    =64:
1665      j=find_system_child(fa%(subj),alter)
1669      IF j>0:remove_person j,1
1673      ma%(subj)=alter
1677      attach%(alter)=attach%(alter)+1
1681      IF fa%(subj)<0:fa%(subj)=0
1685    END SELect
1689 =80:person=alter:subj=alter
1693 =30:REMark Add Spouse
1697   IF sex%(alter)=sex%(subj):er "They are both the same sex!":current_view=0:person=subj:RETurn
1701   IF sex%(subj)=0:er 'First please state sex of',full_name$(subj):current_view=0:person=subj:RETurn
1705   IF sex%(alter)=0:er 'First please state sex of',full_name$(alter):current_view=0:person=subj:RETurn
1709   person=alter
1713   IF add_system_child(subj,alter)=0:RETurn
1717 =20:REMark Add Child
1721   flag=0
1725   IF fa%(alter)=subj OR ma%(alter)=subj:current_view=0:person=subj:RETurn
1729   j=search_array%(fa%,0,subj)
1733   IF j>0
1737     add_child ma%(j),subj,alter
1741     flag=10
1745   ELSE
1749     j=search_array%(ma%,0,subj)
1753     IF j>0
1757       add_child fa%(j),subj,alter
1761       flag=20
1765     END IF
1769   END IF
1773   IF NOT flag:flag=sex%(subj)*10
1777   IF NOT flag:m6 "Is "&full_name$(subj)&" the Father or Mother?":set_anchor 30,30,menu_chan:flag=show_menu(0,"Father","Mother",'','','','','','')
1781   SELect ON flag
1785   =10:fa%(alter)=subj
1789     ftable%(alter)=ftable%(subj)
1793     IF ma%(alter)<0:ma%(alter)=0
1797   =20:ma%(alter)=subj
1801     IF fa%(alter)<0:fa%(alter)=0
1805   END SELect
1809   attach%(subj)=attach%(subj)+1
1813 END SELect
1817 num_edits=1
1821 IF NOT old:add_fields
1825 current_view=0:print_family alter
1829 END DEFine add
1833 :
1837 DEFine PROCedure change
1841 alter=person
1845 IF alter=0:add(0):RETurn
1849 update_fields
1853 END DEFine
1857 :
1861 DEFine PROCedure update_fields
1865 LOCal x,mumdad,a$,b$,fields,i,m,kk
1869 remove_x
1873 REPeat fields
1877   field=ft_field(alter)
1881   SELect ON field
1885     =2:yofb(alter)=stick_up$(0,'Year of Birth:',yofb(alter),7,1)
1889     =3:yofd%(alter)=stick_up$(0,'Year of Death:',yofd%(alter),4,1)
1893     =4:update_parents(alter)
1897     =5:update_spouse(alter)
1901     =6:IF qmark%(alter,'M'):mark%(alter)=mark%(alter)-4
1905        IF qmark%(alter,'F'):mark%(alter)=mark%(alter)-64
1909        kk=show_menu(0,'Male','Female','Unknown','','','','','')
1913        SELect ON kk
1917          =10:m=4
1921          =20:m=64
1925              setup_search:setup_find:exit_flag=0
1929              user_title$='':old_file$=''
1933        END SELect
1937        mark%(alter)=mark%(alter)+m
1941     =1:b$=stick_up$(1,'Family name:',family$(ftable%,alter),len_sur,2)
1945        ftable%(alter)=add_table%(surname_table$,sur_id%,b$,15)
1949     =0:a$=stick_up$(1,'Given name:',given$(gtable%,alter),len_chris,-1)
1953        gtable%(alter)=add_table%(chris_table$,chris_id%,a$,16)
1957     =-1:mumdad=0
1961         IF fa%(alter)<0:IF ma%(alter)<0:er "Invalid combination (Husband/Wife)","":mumdad=1
1965         IF fa%(alter)<0:IF ma%(alter)>0:er "Invalid combination (Husband/Mother)","":mumdad=1
1969         IF ma%(alter)<0:IF fa%(alter)>0:er "Invalid combination (Wife/Father)","":mumdad=1
1973         IF NOT mumdad:EXIT fields
1977   END SELect
1981   mumdad=0
1985   i=LEN(given$(gtable%,alter)&family$(ftable%,alter)&' ')
1989   IF i>sort_length:sort_length=i
1993 END REPeat fields
1997 num_edits=1
2001 print_family person
2005 END DEFine
2009 :
2013 DEFine PROCedure remove
2017 LOCal k
2021 IF NOT num_names:BEEP 1500,100:RETurn
2025 remove_x
2029 k=show_menu(0,'Quit','Single','Marked','Zap all','','','','','')
2033 SELect ON k
2037 =20:alter=person
2041     IF NOT warn("You are about to DELETE ",full_name$(alter),"Delete"):remove_person alter,0
2045 =30:operate_markers(60)
2049 =40:IF NOT warn("You are about to DELETE all PERSONS","","Zap"):init_names:num_names=0
2053 END SELect
2057 END DEFine
2061 :
2065 DEFine PROCedure logo
2069 LOCal k,kk,midchar%,logo$
2073 clear_screen
2077 CSIZE #back_chan,3,1
2081 wheight%=INT(outlny/10)
2085 midchar%=INT(outlnx/32)
2087 DRAW_sprt #back_chan,(outlnx/2)-15,25
2089 AT #back_chan,3,midchar%-7:PRINT #back_chan,"Genealogist 3"
2093 CSIZE #back_chan,0,0
2097 midchar%=INT(outlnx/12)
2101 AT #back_chan,wheight%-9,midchar%-(LEN(DATE$)/2):PRINT #back_chan,DATE$
2105 logo$="Version "&qlg_ver$&" 1993 Chris Boutal All Rights Reserved"
2109 AT #back_chan,wheight%-8,midchar%-LEN(logo$)/2:PRINT #back_chan,logo$
2113 logo$="Updated 1998-2000 Rich Mellor All Rights Reserved"
2117 AT #back_chan,wheight%-7,midchar%-LEN(logo$)/2:PRINT #back_chan,logo$
2121 logo$="Using Q_Liberator "&compiler_ver$&" 1993 Liberation Software"
2125 AT #back_chan,wheight%-6,midchar%-LEN(logo$)/2:PRINT #back_chan,logo$
2129 logo$="and Pointer Toolkit "&pointer_ver$&" 1988 Qjump Ltd"
2133 AT #back_chan,wheight%-5,midchar%-LEN(logo$)/2:PRINT #back_chan,logo$
2137 REPeat Load_initial_file
2141   recsdev (DATAD$)
2145   IF exit_flag:IF NOT warn('You are About to Leave G3','No Filename chosen for Family Tree','Quit'):STOP
2149   IF NOT exit_flag:EXIT Load_initial_file
2153 END REPeat Load_initial_file
2157 reload
2161 clear_screen
2165 ft
2169 END DEFine
2173 :
2177 DEFine PROCedure get_spice
2181 LOCal i,j,flag%,pchild
2185 IF attach%(person)<100:RETurn
2189 pchild=attach%(person) DIV 100
2193 flag%=0:j=0:dmpos=0
2197 REPeat gets_loop%
2201   i=next_parent(-person,dmpos)
2205   IF NOT i:EXIT gets_loop%
2209   IF NOT selected(i)
2213     IF flag%:spouse=child
2217     j=j+1
2221     cenprint i,spouse
2225     selected(i)=1
2229     flag%=1
2233     child=spouse+2
2237   END IF
2241   IF j=pchild:EXIT gets_loop%
2245 END REPeat gets_loop%
2249 END DEFine
2253 :
2257 DEFine PROCedure get_field(field_len,chan,row,col,num_only,x$)
2261 LOCal dot,dash,oldlen,j,k,pos,moved
2265 LOCal space,nc,k$,field_loop,final$(0,field_len),new_field$(0,field_len)
2269 next_field=1:exit_flag=0:next_record=0:next_page=0:pick_field=0
2273 new_field$(0)=x$:pos=1:moved=0:dot=0:dash=0:space=0
2277 IF after:pos=2:moved=1
2281 final$(0)=new_field$(0)&FILL$(' ',field_len-LEN(x$))
2285 REPeat field_loop
2289   AT #chan,row,col:PRINT #chan,final$(0)
2293   OVER #chan,-1
2297   BLOCK #chan,6,10,(col+pos-1)*6,row*10,colours%(chan,2)
2301   k$=INKEY$(-1):k=CODE(k$)
2305   BLOCK #chan,6,10,(col+pos-1)*6,row*10,colours%(chan,2)
2309   OVER #chan,0
2313   IF pos=1:space=1
2317   SELect ON k
2321     =192:pos=pos-1:moved=1:IF pos<1:pos=field_len
2325     =193,196:pos=1:moved=1
2329     =200:pos=pos+1:moved=1:IF pos>field_len:pos=1
2333     =201,204:moved=1
2337              FOR pos=field_len TO 1 STEP -1:IF final$(0,pos)<>" ":EXIT pos
2341              IF pos<field_len:pos=pos+1
2345     =194,195,202
2349       nc=1:IF k=195:nc=pos-1:pos=1
2353       IF nc<1:nc=1
2357       IF k=194:pos=pos-1:IF pos<1:pos=1
2361       moved=1
2365       FOR j=pos TO field_len-nc:final$(0,j)=final$(0,j+nc)
2369       FOR j=field_len-nc+1 TO field_len:final$(0,j)=" "
2373       IF pos=1:IF num_only=1 OR num_only=10:final$(0,1)="0":moved=0
2377     =203:FOR j=pos TO field_len:final$(0,j)=" ":moved=1
2381       IF pos=1:IF num_only=1 OR num_only=10:final$(0,1)="0":moved=0
2385     =27,9,10,253,208,216,212,220,240
2389       IF num_only=6
2393         IF final$(0)='' OR final$(0)='-':final$(0)="0":BEEP 1500,100:NEXT field_loop
2397         IF final$(0)=FILL$(' ',LEN(final$(0))):final$(0)='0':BEEP 1500,100:NEXT field_loop
2401         IF final$(0,1) INSTR '-0123456789'=0:final$(0)='0':BEEP 1500,100:NEXT field_loop
2405         IF field_len>1
2409           IF final$(0,1)='-':IF final$(0,2) INSTR '0123456789'=0:final$(0)="0"
2413         END IF
2417         IF ABS(final$(0))>num_names:BEEP 1500,100:NEXT field_loop
2421       END IF
2425       new_field$(0)=final$(0)
2429       SELect ON k
2433         =253:next_field=-1
2437         =208:next_field=-1:next_record=-1
2441         =212:next_field=-1:next_page=-1
2445         =216:next_record=1
2449         =220:next_page=1
2453         =27:exit_flag=1
2457         =240:pick_field=chan:AT #chan,row,col:EXIT field_loop
2461       END SELect
2465       EXIT field_loop
2469     =1:IF num_only=0 OR num_only=2 OR num_only=5 OR num_only=-1
2473          k=CODE(final$(0,pos))
2477          IF (k>=97 AND k<=122)
2481            k=k-32
2485          ELSE
2489            IF k>=65:IF k<=90:k=k+32
2493          END IF
2497          final$(0,pos)=CHR$(k)
2501        END IF
2505     =REMAINDER
2509      IF ((num_only=1 OR num_only=6 OR num_only=10) AND ((k>=48 AND k<=57) OR (pos=1 AND dash=0 AND k=45) OR (dot=0 AND k=46))) OR (num_only<>1 AND num_only<>6 AND num_only<>10)
2513        IF k$='"':k$="'"
2517        IF num_only=2:IF k>=97:IF k<=122:k=k-32:k$=CHR$(k)
2521        IF num_only=5 OR num_only=-1:IF space:IF k>=97:IF k<=122:k=k-32:k$=CHR$(k)
2525        IF num_only=-1:IF NOT space:IF k>=65:IF k<=90:k=k+32:k$=CHR$(k)
2529        IF moved=0
2533          final$(0)=FILL$(" ",field_len)
2537        ELSE
2541          FOR j=field_len TO (pos+1) STEP -1:final$(0,j)=final$(0,j-1)
2545        END IF
2549        moved=1
2553        final$(0,pos)=k$:pos=pos+1:IF pos>field_len:pos=field_len
2557      ELSE
2561        BEEP 1500,100
2565      END IF
2569      IF k=45:dash=1
2573      IF k=46:dot=1
2577      IF k=32:space=1
2581   END SELect
2585   IF k<>32:space=0
2589 END REPeat field_loop
2593 oldlen=1
2597 FOR j=field_len TO 1 STEP -1:IF new_field$(0,j)<>" ":oldlen=j:EXIT j
2601 IF oldlen=1:IF num_only=1 OR num_only=6 OR num_len=10:IF new_field$(0,1)="-" OR new_field$(0,1)=".":new_field$(0,1)="0"
2605 new_field$(0,0)=oldlen
2609 x$=new_field$(0)
2613 IF num_only=4:x$=month$(check_clock(new_field$(0)))
2617 IF num_only=10:IF x$<100:x$=INT(this_year/100)*100+x$
2621 IF NOT pick_field:AT #chan,row,col:PRINT #chan,x$;:PRINT #chan,FILL$(' ',field_len-oldlen)
2625 RETurn
2629 END DEFine
2633 :
2637 DEFine FuNction spc
2641 s=1:IF fa%(alter)<0 OR ma%(alter)<0:s=100
2645 RETurn s
2649 END DEFine
2653 :
2657 DEFine PROCedure pedigree
2661 LOCal i,j
2665 pedigree_spacer=show_menu(1,'Spacers','No spacers','','','','','','')/10-1
2669 IF report_setup(0):RETurn
2673 name_length=sort_length+13
2677 parents
2681 IF maxpow>9:maxpow=9
2685 maxpow=numgens(maxpow)
2689 maxped=2^(maxpow+1)-2
2693 DIM alpha_sort(maxped)
2697 print_heads "Pedigree"
2701 report_title$="Pedigree for "&full_name$(person)
2705 printer report_title$
2709 FOR i=1 TO num_names
2713   IF qmark%(i,'/'):selected(i)=0
2717   IF selected(i)<=maxped:IF selected(i)<>0:alpha_sort(selected(i))=i
2721 END FOR i
2725 FOR i=1 TO maxped
2729   FOR j=1 TO maxpow
2733     IF i=(2^j)-1
2737       printer " "
2741       printer relate$(0,j,0)&"s:":EXIT j
2745     ELSE
2749       IF 2^j>i:EXIT j
2753     END IF
2757   END FOR j
2761   IF alpha_sort(i)
2765     ahnt=selected(alpha_sort(i))+1:ahnt$='A'&ahnt
2769     printer pad$(alpha_sort(i),ahnt$,form)
2773   ELSE
2777     IF NOT pedigree_spacer:printer "----"
2781   END IF
2785   IF exit_flag:EXIT i
2789 END FOR i
2793 selected(person)=-1
2797 add_marker('P')
2801 print_tails
2805 END DEFine
2809 :
2813 DEFine PROCedure parents
2817 LOCal i,np,flag%,j
2821 longest=0:maxped=0
2825 np=fa%(person)
2829 IF np>0:IF np<num_names:selected(np)=1:maxped=1:longest=longest+1
2833 np=ma%(person)
2837 IF np>0:IF np<num_names:selected(np)=2:maxped=2:longest=longest+1
2841 REPeat parent_loop%
2845   flag%=0
2849   FOR j=num_names TO 1 STEP -1
2853     IF selected(j)
2857       FOR i=1,2
2861         SELect ON i
2865         =1:np=fa%(j)
2869         =2:np=ma%(j)
2873         END SELect
2877         IF np>0 AND np<=num_names
2881           IF selected(np)=0 OR selected(np)>selected(j)*2+i
2885             selected(np)=selected(j)*2+i
2889             longest=longest+1
2893             IF maxped<selected(np):maxped=selected(np)
2897             flag%=1
2901           END IF
2905         END IF
2909       END FOR i
2913     END IF
2917  END FOR j
2921  IF NOT flag%:EXIT parent_loop%
2925 END REPeat parent_loop%
2929 j=maxped:maxpow=1
2933 REPeat gen_loop%
2937   j=j-2^maxpow
2941   IF j<=0:EXIT gen_loop%
2945   maxpow=maxpow+1
2949 END REPeat gen_loop%
2953 END DEFine
2957 :
2961 DEFine FuNction relate$(l1,l2,sex)
2965 LOCal i,level1,level2
2969 level1=l1:level2=l2
2973 diflev=ABS(level2-level1)
2977 IF level2<level1:level1=level2
2981 rel$=''
2985 SELect ON level1
2989    =0:SELect ON diflev
2993           =0:rel$="The same person!"
2997           =1:rel$=parent$(sex)
3001           =2:rel$="Grand"&parent$(sex)
3005           =3:rel$="Great Grand"&parent$(sex)
3009           =4:rel$="Great Great Grand"&parent$(sex)
3013           =REMAINDER :i=diflev-2
3017                       rel$="Great ("&i&" times) Grand"&parent$(sex)
3021       END SELect
3025    =1:SELect ON diflev
3029           =0:rel$=sibling$(sex)
3033           =1:rel$=uncle$(sex)
3037           =2:rel$="Great "&uncle$(sex)
3041           =3:rel$="Great Great "&uncle$(sex)
3045           =REMAINDER :i=diflev-2
3049                       rel$="Great ("&i&" times) "&uncle$(sex)
3053       END SELect
3057    =2:rel$="First Cousin"
3061    =3:rel$="Second Cousin"
3065    =4:rel$="Third Cousin"
3069    =REMAINDER :i=level1-1
3073                rel$=i&"th Cousin"
3077 END SELect
3081 IF level1>1
3085    SELect ON diflev
3089       =0:
3093       =1:rel$=rel$&" Once Removed"
3097       =2:rel$=rel$&" Twice Removed"
3101       =REMAINDER :rel$=rel$&" "&diflev&" Times Removed"
3105    END SELect
3109 END IF
3113 RETurn rel$
3117 END DEFine relate$
3121 :
3125 DEFine PROCedure relate(num)
3129 LOCal found,i,ped1,ped2,ped3,ped4,found1,found2,q,j
3133 LOCal level_loop,level2_loop
3137 pwait
3141 SELect ON num
3145   =1:DIM selected(num_names),selected2(num_names)
3149     remove_x:p1=person
3153     parents
3157     FOR i=1 TO num_names:selected2(i)=selected(i)
3161     selected2(p1)=-1
3165     mark p1,5
3169     qwindow err_chan:RETurn
3173   =2:IF NOT p1:RETurn
3177     DIM selected(num_names)
3181     parents
3185     selected(person)=-1
3189     found1=0:found2=0:ped1=0:ped2=0:found=0
3193     FOR i=1 TO num_names
3197       IF selected(i) AND selected2(i)
3201         IF NOT ped1 OR selected(i)<ped1 OR selected2(i)<ped2
3205           found1=i:ped1=selected(i):ped2=selected2(i):found=1
3209         END IF
3213       END IF
3217     END FOR i
3221     IF INT(ped1/2)<>ped1
3225       ped3=ped1+1:ped4=ped2+1
3229       FOR i=1 TO num_names
3233         IF selected(i)=ped3:IF selected2(i)=ped4:found2=i:EXIT i
3237       END FOR i
3241     END IF
3245     level1=1:level2=1
3249     IF found
3253       REPeat level_loop
3257         IF ped1<2^(level1+1)-1:EXIT level_loop
3261         level1=level1+1
3265       END REPeat level_loop
3269       REPeat level2_loop
3273         IF ped2<2^(level2+1)-1:EXIT level2_loop
3277         level2=level2+1
3281       END REPeat level2_loop
3285     END IF
3289     IF ped1=-1:level1=0
3293     IF ped2=-1:level2=0
3297 END SELect
3301 qwindow err_chan
3305 half$="Half ":IF found2 OR NOT level1 OR NOT level2:half$=""
3309 q=p1:p=person
3313 IF level1<level2:q=p:p=p1
3317 IF found
3321   rel$="is the "&half$&relate$(level1,level2,sex%(q))&" of:"
3325   IF NOT level1:IF NOT level2:rel$="is the same person as:":found=0
3329 ELSE
3333   rel$="is NOT related to:"
3337 END IF
3341 i=25
3345 IF LEN(rel$)>i:i=LEN(rel$)
3349 IF sort_length+13>i:i=sort_length+13
3353 point_window -1,-1,data_chan,i*6+4,72
3357 PRINT #data_chan,full_name$(q)
3361 PRINT #data_chan,rel$
3365 PRINT #data_chan,full_name$(p)
3369 IF found
3373   IF LEN(rel$)<71:PRINT #data_chan
3377   PRINT #data_chan,"Nearest Common Ancestors:"
3381   PRINT #data_chan,full_name$(found1)
3385   IF found2:PRINT #data_chan,full_name$(found2)
3389 END IF
3393 resume
3397 qwindow data_chan
3401 END DEFine
3405 :
3409 DEFine FuNction tree
3413 LOCal k,l,i,j
3417 exit_flag=0
3421 level
3425 IF max_level<2:er "There are no descendants for this person","":RETurn 1
3429 max_level=numgens(max_level)
3433 IF max_level<2 OR exit_flag:nomarks=0:norefs=1:RETurn 1
3437 FOR j=1 TO num_names
3441   IF qmark%(j,'T')=1:mark%(j)=mark%(j)-2^0
3445 END FOR j
3449 tree_count=0
3453 size
3457 make_grid
3461 current_tree=person
3465 mark current_tree,0
3469 qwindow err_chan
3473 RETurn 0
3477 END DEFine
3481 :
3485 DEFine PROCedure print_tree
3489 LOCal iters,j,k,l,num_slots
3493 LOCal a,b,c,attach,oldyoung,old_flag
3497 m6 'Print markers and/or network numbers on tree?'
3501 attach=show_menu(0,'Neither ½','Markers ½','Ref nos ½','Both ½','','','','')
3505 oldyoung=show_menu(1,'Eldest first','Youngest first','','','','','','')
3509 SELect ON oldyoung
3513   =10:a=min_size:b=max_size:c=1
3517   =20:b=min_size:a=max_size:c=-1
3521 END SELect
3525 nomarks=0:IF attach=10 OR attach=30:nomarks=1
3529 norefs=1:IF attach=30 OR attach=40:norefs=0
3533 IF pcw(3):RETurn
3537 old_flag=column_flag:column_flag=0
3541 print_heads "Family Tree"
3545 report_title$="Descendants of "&full_name$(person)
3549 printer report_title$:printer ''
3553 num_slots=INT(page_width%(1)/slot)
3557 iters=max_level/num_slots
3561 IF iters<>INT(iters):iters=INT(iters+1)
3565 FOR k=1 TO iters
3569   FOR j=a TO b STEP c
3573     record$=''
3577     l=k*num_slots:IF l>max_level:l=max_level
3581     FOR i=1+(k-1)*num_slots TO l
3585       record$=record$&slot$(i,j,c)
3589     END FOR i
3593     PRINT #pr_chan,lm$&record$&eol$:num_lines=num_lines+1
3597     IF CODE(INKEY$(0))=27:EXIT k
3601   END FOR j
3605   IF num_lines MOD page_length:PRINT #pr_chan;tof$
3609   num_lines=0:FOR j=1 TO 5:printer ''
3613 END FOR k
3617 IF NOT nomarks
3621   printer ''
3625   printer 'KEY to MARKERS':printer ''
3629   FOR i=0 TO 14
3633     IF char_text$(i)<>'<no text>':printer user_char$(i+1)&' '&char_text$(i)
3637   END FOR i
3641 END IF
3645 norefs=1:nomarks=0
3649 print_tails
3653 column_flag=old_flag
3657 END DEFine
3661 :
3665 DEFine PROCedure show_tree
3669 LOCal out_loop,i,j,k,xx,num_slots
3673 LOCal tx,ty
3677 tx=INT(outlnx/108)
3681 IF tx>6:tx=6
3685 ty=screen_length-1
3689 num_slots=tx*ty-1
3693 start=INT((max_size-screen_length)/2)+2
3697 top=start
3701 left=1:right=tx:bot=top+screen_length-2
3705 tree_options
3709 REPeat out_loop
3713   set_anchor -1,-1,tree_chan
3717   k=get_opt(1,num_slots,options$,-tx,tree_chan,tree_menu$,1,1)
3721   SELect ON k
3725   =0 TO num_slots:i=INT(k/tx)+1:j=k-i*tx+tx+1
3729     left=left+j-2:top=top+i-10
3733   =-9:EXIT out_loop
3737   =-6:edit_tree left+1,top+9
3741   =-7:save_tree
3745   =-8:print_tree
3749   =-3:left=1
3753   =-2:top=max_size-screen_length+4
3757   =-4:left=max_level-3
3761   =-1:top=min_size
3765   =-5:count=2:xx=0
3769     find_name(2):xx=person
3773     IF xx>0 AND xx<=num_names
3777       FOR i=min_size TO max_size
3781         FOR j=0 TO max_level
3785           IF grid%(j,i,0)=xx
3789             left=j-1:top=i-10:EXIT i
3793           END IF
3797         END FOR j
3801       END FOR i
3805     END IF
3809   END SELect
3813   right=left+tx-1:bot=top+screen_length-2
3817   tree_options
3821   FOR i=0 TO num_slots:CH_ITEM wdefs(tree_chan),0,i,-1,'',options$(i)
3825 END REPeat out_loop
3829 shut tree_chan
3833 END DEFine
3837 :
3841 DEFine PROCedure tree_options
3845 LOCal i,j,k
3849 k=0
3853 DIM options$(num_slots,18)
3857 FOR i=top TO bot
3861   FOR j=left TO right
3865     options$(k)=slot$(j,i,1)
3869     k=k+1
3873     IF k>DIMN(options$):EXIT i
3877   END FOR j
3881 END FOR i
3885 END DEFine
3889 :
3893 DEFine FuNction slot$(i,j,c)
3897 LOCal record$,dash$,h,m$,x,x$,dash2$
3901 IF i>max_level OR i<0:RETurn blanks$
3905 IF j>max_size OR j<min_size:RETurn blanks$
3909 SELect ON c
3913 =1:dash$=" ":IF grid%(i,j,0)<0 AND i<>1:dash$="_"
3917   dash2$=" "
3921 =-1:dash2$=" ":IF grid%(i,j-1,0)<0 AND i<>1:dash2$="_"
3925   dash$=" "
3929 END SELect
3933 g=ABS(grid%(i,j,0))
3937 h=grid%(i,j,1)
3941 REMark SELect ON h:=3,4,8,9,13,14:IF i<max_level:IF grid%(i,j+1,0)=0:h=0
3945 SELect ON h
3949 =0 TO 4:record$=" "
3953 =5 TO 9:record$=bar$
3957 =10 TO 14:record$="."
3961 =15:record$=''
3965 =REMAINDER :record$="*"
3969 END SELect
3973 SELect ON h
3977 =0,5,10:record$=record$&blanks$(1 TO slot-1)
3981 =3,8,13:record$=record$&"      "&mar_char$&FILL$("-",slot-8)
3985   IF i=max_level:record$(slot)=">"
3989 =1,6,11:x$=markers$(g,8):IF x$<>'':x$=x$&' '
3993   IF g>0:m$=dash$&x$&given$(gtable%,g)&blanks$
3997   IF g=0:m$=dash$&x$&'Unknown'&blanks$
4001   IF LEN(x$&given$(gtable%,g))>slot-2:m$(slot-1)="."
4005   record$=record$&m$(1 TO slot-1)
4009   IF '(System Name)' INSTR full_name$(g):record$=blanks$
4013 =2,7,12
4017   m$=dash2$&family$(ftable%,g)&blanks$
4021   x=LEN(family$(ftable%,g))+2:IF x>slot-12:x=slot-12
4025   d$=dates$(g):ld=LEN(d$)
4029   IF ld:m$(x TO x+11)=d$
4033   IF LEN(family$(ftable%,g))>slot-ld-2:m$(slot-ld)='.'
4037   record$=record$&m$(1 TO slot-1)
4041   IF '(System Name)' INSTR full_name$(g):record$=blanks$
4045 =4,9,14:record$=record$&"      "&mar_char$&blanks$(1 TO slot-8)
4049 =15:record$=tree_edit$(g)&FILL$(' ',slot-LEN(tree_edit$(g)))
4053 =REMAINDER :record$=record$&FILL$("*",slot-1)
4057 END SELect
4061 RETurn record$
4065 END DEFine
4069 :
4073 DEFine PROCedure level
4077 LOCal i,j,count,flag,pchild
4081 LOCal level_loop,getl_loop
4085 p1=0
4089 DIM selected(num_names),selected2(num_names)
4093 max_level=1:selected(person)=1:selected2(person)=1:descend=1
4097 REPeat level_loop
4101    flag=1
4105    FOR j=person TO num_names,1 TO person
4109       IF selected2(j) AND attach%(j) MOD 100
4113          count=0:dmpos=0:pchild=attach%(j) MOD 100
4117          REPeat getl_loop
4121             i=next_parent(j,dmpos)
4125             IF NOT i:EXIT getl_loop
4129             selected(i)=selected(j)+1
4133             IF selected(i)>max_level:max_level=selected(i)
4137             selected2(i)=1:flag=0
4141             count=count+1:descend=descend+1
4145             IF count=pchild:EXIT getl_loop
4149          END REPeat getl_loop
4153       END IF
4157       selected2(j)=0
4161    END FOR j
4165    IF flag:EXIT level_loop
4169 END REPeat level_loop
4173 add_marker('T')
4177 END DEFine level
4181 :
4185 DEFine PROCedure size
4189 LOCal i,j,k,x
4193 DIM selected2(num_names)
4197 FOR i=max_level TO 1 STEP -1
4201   FOR j=1 TO num_names
4205     IF selected(j)=i
4209       IF NOT (attach%(j) MOD 100):selected2(j)=5
4213       IF selected2(j)<2+6*INT(attach%(j)/100)
4217         selected2(j)=2+6*INT(attach%(j)/100)
4221       END IF
4225       IF i=max_level
4229         selected2(j)=3+3*INT(attach%(j)/100)
4233         IF attach%(j) MOD 100:selected2(j)=selected2(j)+4
4237       END IF
4241       x=ABS(fa%(j))
4245       IF selected(x):selected2(x)=selected2(x)+selected2(j)+1
4249       x=ABS(ma%(j))
4253       IF selected(x):selected2(x)=selected2(x)+selected2(j)+1
4257     END IF
4261   END FOR j
4265 END FOR i
4269 END DEFine
4273 :
4277 DEFine PROCedure make_grid
4281 LOCal i,j,k,l,a,z,filling
4285 LOCal last,pos,g,sp,m,pchild
4289 LOCal getg_loop,ms,m$
4293 max_size=selected2(person)+10
4297 ms=max_size-min_size
4301 m6 "Lines:"&ms
4305 DIM grid%(max_level,max_size,1)
4309 pos=max_size/2
4313 grid%(1,pos,0)=-person:grid%(1,pos,1)=1
4317 grid%(1,pos+1,0)=person:grid%(1,pos+1,1)=2
4321 grid%(1,pos+2,1)=3
4325 FOR i=2 TO max_level+1
4329   FOR j=max_size TO 0 STEP -1
4333     g=-grid%(i-1,j,0)
4337     IF g>=1
4341       DIM selected(num_names)
4345       get_children g
4349       last=j-INT(selected2(g)/2+.5)
4353       next_sp=j+3
4357       IF num_child>=0
4361         FOR m=0 TO num_child
4365           k=sort_table%(m)
4369           pos=last+INT(selected2(child_table(k,0))/2+.5)+1
4373           IF i<=max_level
4377             grid%(i,pos,0)=-child_table(k,0):grid%(i,pos,1)=1
4381             grid%(i,pos+1,0)=child_table(k,0):grid%(i,pos+1,1)=2
4385             IF grid%(i,pos+1,0)>0:mark grid%(i,pos+1,0),0
4389             IF attach%(child_table(k,0)) MOD 100:grid%(i,pos+2,1)=3
4393             IF attach%(child_table(k,0)) MOD 100=1
4397               chid1%=search_array%(fa%,0,child_table(k,0))
4401               IF chid1%<0:chid1%=search_array%(ma%,0,child_table(k,0))
4405               IF chid1%>=0:IF '(System Name)' INSTR full_name$(chid1%):grid%(i,pos+2,1)=4
4409             END IF
4413           END IF
4417           SELect ON m
4421           =0:IF child_table(k,1)=g:sp=2:ELSE sp=1
4425             spic=child_table(k,sp)
4429             a=0:z=pos:filling=0
4433             IF m=num_child
4437               a=pos:z=j+2:filling=5
4441               IF '(System Name)' INSTR full_name$(child_table(k,0)):filling=0:IF i<=max_level:grid%(i,pos,1)=0:grid%(i,pos+1,1)=0
4445             END IF
4449             i1=i-1:add_spouse
4453           =REMAINDER
4457             filling=5
4461             IF '(System Name)' INSTR full_name$(child_table(k,0)):filling=0:IF i<=max_level:grid%(i,pos,1)=0:grid%(i,pos+1,1)=0
4465             IF spic<>child_table(k,sp)
4469               spic=child_table(k,sp)
4473               IF filling:filling=10
4477               i1=i-1:add_spouse
4481             END IF
4485             z=pos
4489             IF m=num_child:IF z<j+2:z=j+2
4493           END SELect
4497           last=last+selected2(child_table(k,0))+1
4501           IF i>max_level:filling=0
4505           IF filling:FOR l=a+1 TO z:grid%(i,l,1)=grid%(i,l,1)+filling
4509           a=z
4513         END FOR m
4517       END IF
4521       count=0:dmpos=0:pchild=attach%(g) DIV 100
4525       REPeat getg_loop
4529         m=next_parent(-g,dmpos)
4533         IF NOT m:EXIT getg_loop
4537         IF NOT selected(m)
4541           count=count+1
4545           spic=m:i1=i-1
4549           IF next_sp=j+3:grid%(i1,j+2,1)=grid%(i1,j+2,1)+4
4553           add_spouse
4557         END IF
4561         IF count=pchild:EXIT getg_loop
4565       END REPeat getg_loop
4569     END IF
4573   END FOR j
4577 END FOR i
4581 min_size=0
4585 FOR i=0 TO max_size
4589   FOR j=1 TO max_level
4593     IF slot$(j,i,1)<>blanks$:min_size=i:EXIT i
4597   END FOR j
4601 END FOR i
4605 IF min_size:min_size=min_size-1
4609 FOR i=max_size TO min_size STEP -1
4613   FOR j=1 TO max_level
4617     IF slot$(j,i,1)<>blanks$:max_size=i:EXIT i
4621   END FOR j
4625 END FOR i
4629 qwindow stat_chan
4633 END DEFine
4637 :
4641 DEFine PROCedure index
4645 LOCal i,j,k,start,fin,temp,start$
4649 LOCal fin$,range_loop,new_init,kk
4653 kk=show_menu(0,'Quit','List By Name','List By Network ID','','','','','')
4657 IF kk=10:RETurn
4661 unk=show_menu(0,'Quit','Include Unknowns','Exclude Unknowns','','','','','')
4665 IF unk=10:RETurn
4669 IF report_setup(0):RETurn
4673 IF kk=30:start$='1':fin$=num_names:ELSE :start$='A':fin$='Z'
4677 REPeat range_loop
4681    IF kk=20:DIM options$(1,6):ELSE DIM options$(1,11)
4685    options$(0)='From:'&start$:options$(1)='To  :'&fin$
4689    k=get_opt(0,1,options$,1,menu_chan,ok_menu$,1,1)
4693    SELect ON k
4697      =-1:EXIT range_loop
4701      =0:IF kk=20:start$=stick_up$(0,'From:',start$,1,2)
4705         IF kk=30:start$=stick_up$(0,'From:',start$,6,6)
4709      =1:IF kk=20:fin$=stick_up$(0,'To:',fin$,1,2)
4713         IF kk=30:fin$=stick_up$(0,'To:',fin$,6,6)
4717    END SELect
4721 END REPeat range_loop
4725 IF kk=20
4729   start=CODE(start$)
4733   fin=CODE(fin$)
4737 ELSE
4741   start=start$:fin=fin$
4745 END IF
4749 IF start>fin:temp=start:start=fin:fin=temp
4753 sort_type=10
4757 pwait
4761 name_length=sort_length+13
4765 IF form:name_length=len_sur+len_chris+13
4769 IF column$=='on':column_flag=1:column_width=name_length+6
4773 FOR i=1 TO num_names
4777    IF NOT qmark%(i,'/'):selected(i)=1
4781    a$=family$(ftable%,i)
4785    IF LEN(a$)
4789      IF '*DELETED*' INSTR a$:selected(i)=0
4793      j=CODE(a$(1))
4797      IF j<65 OR j>122
4801        IF unk=30:selected(i)=0
4805      ELSE
4809        IF kk=20:IF j<start OR j>fin :selected(i)=0
4813        IF kk=30:IF i<start OR i>fin :selected(i)=0
4817      END IF
4821    ELSE
4825      IF unk=30:selected(i)=0
4829    END IF
4833 END FOR i
4837 longest=num_names
4841 IF kk=20:sort_alpha
4845 qwindow err_chan
4849 IF kk=20:print_heads "Alphabetical Index":ELSE print_heads "Network Number Index"
4853 IF kk=20:report_title$="Alphabetical Index":ELSE report_title$="Network Number Index"
4857 IF count>=0
4861   IF kk=30
4865     list_persons
4869   ELSE
4873     old_init=0
4877     FOR j=0 TO count
4881       k=sort_table%(j)
4885         a$=family$(ftable%,k)
4889         IF LEN(a$):new_init=CODE(a$(1)):ELSE new_init=1
4893         a$=pad$(k,k,form)
4897         IF old_init<>new_init
4901           old_init=new_init
4905           printer ''
4909           IF new_init>64 AND new_init<123:printer CHR$(new_init):ELSE printer "Unknown families"
4913           IF exit_flag:EXIT j
4917        END IF
4921        IF fprinter(a$):EXIT j
4925     END FOR j
4929   END IF
4933 END IF
4937 print_tails
4941 END DEFine
4945 :
4949 DEFine PROCedure print_tails
4953 IF dest$="":RETurn
4957 IF dest$='scr'
4961    IF NOT exit_flag:resume
4965 END IF
4969 IF dest$=print_dev$
4973    IF column_flag
4977       dump_cols
4981       IF btm:bottom_margin=0
4985    END IF
4989    IF num_lines>=top_margin:PRINT #pr_chan,tof$;
4993    PRINT #pr_chan,postamble$;
4997 END IF
5001 PRINT #pr_chan,fount_type$(fount_type-1,0);
5005 qwindow stat_chan:qwindow pr_chan
5009 eol$='':lm$=''
5013 IF dest$<>'scr':qwindow err_chan
5017 END DEFine
5021 :
5025 DEFine PROCedure print_heads(heading$)
5029 LOCal i,temp$
5033 num_lines=0:page_num=1
5037 IF dest$="":RETurn
5041 IF dest$<>'scr':pwait
5045 IF dest$=print_dev$
5049   m6 "<ESC>=ABORT print"
5053   OPEN #pr_chan,dest$
5057   PRINT #pr_chan,preamble$;
5061   IF LEN(line_space$)>2:IF line_space>0:line_space$=line_space$(1 TO 2)&CHR$(line_space)
5065   PRINT #pr_chan,line_space$;
5069   FOR i=1 TO top_margin:PRINT #pr_chan,eol$
5073   num_lines=top_margin
5077 END IF
5081 IF dest$='scr'
5085   point_window -1,-1,pr_chan,496,212
5089 END IF
5093 IF dest$<>'scr' AND dest$<>print_dev$
5097   DELETE dest$
5101   OPEN_NEW #pr_chan,dest$
5105 END IF
5109 IF heading$<>""
5113   IF dest$=print_dev$:PRINT #pr_chan,lm$&fount_type$(2,1);
5117   PRINT #pr_chan;"GENEALOGIST 3 -"!heading$&eol$
5121   IF dest$=print_dev$:PRINT #pr_chan,fount_type$(2,0);
5125   temp$=DATE$
5129   PRINT #pr_chan,lm$&"V"&qlg_ver$&" "&DAY$&" "&temp$(10 TO 12)&temp$(6 TO 9)&temp$(1 TO 5)&temp$(13 TO 17)&eol$
5133   IF dest$<>'scr':PRINT #pr_chan,eol$:ELSE PRINT #pr_chan
5137   num_lines=num_lines+3
5141 END IF
5145 IF user_title$<>'':PRINT #pr_chan,user_title$:num_lines=num_lines+1
5149 IF dest$=print_dev$:PRINT #pr_chan,fount_type$(fount_type-1,1);line_space$;
5153 IF dest$=print_dev$ AND column_flag
5157   btm=0
5161   IF NOT top_margin:IF NOT bottom_margin:bottom_margin=1:btm=1
5165   column_length=page_length-bottom_margin-1
5169   max_cols=INT(page_width%(fount_type-1)/(column_width+1))-1
5173   col_num=num_lines:column=0
5177   DIM page_array$(column_length,max_cols,column_width)
5181 END IF
5185 END DEFine
5189 :
5193 DEFine FuNction fprinter(line$)
5197 printer line$
5201 RETurn exit_flag
5205 END DEFine
5209 :
5213 DEFine PROCedure printer(line$)
5217 LOCal t,i,ll,bt
5221 exit_flag=0
5225 IF CODE(INKEY$(0))=27:exit_flag=1
5229 IF dest$="":RETurn
5233 IF dest$=print_dev$ AND column_flag
5237   page_array$(col_num,column)=line$&FILL$(' ',column_width+1)
5241   col_num=col_num+1
5245   IF col_num>column_length:column=column+1:col_num=num_lines
5249   IF column>max_cols:dump_cols
5253 ELSE
5257   PRINT #pr_chan,lm$&line$&eol$
5261   num_lines=num_lines+1
5265 END IF
5269 IF (num_lines+bottom_margin)>=page_length AND dest$=print_dev$
5273   num_lines=top_margin+2:page_num=page_num+1
5277   col_num=num_lines
5281   IF bottom_margin:PRINT #pr_chan,tof$;
5285   FOR i=1 TO top_margin:PRINT #pr_chan,eol$
5289   PRINT #pr_chan,lm$&'Page ';page_num;' '&report_title$&eol$:PRINT #pr_chan,eol$
5293 END IF
5297 IF dest$='scr'
5301   ll=INT(LEN(lm$&line$&eol$)/72)
5305   num_lines=num_lines+ll
5309   IF num_lines>=screen_length
5313     bt=get_opt(0,3,print_menu$,4,menu_chan,'',0,1)
5317     SELect ON bt
5321       =3:exit_flag=1
5325       =1:num_lines=0:CLS #pr_chan
5329       =2:num_lines=num_lines-1
5333       =0:num_lines=0
5337     END SELect
5341   END IF
5345 END IF
5349 END DEFine
5353 :
5357 DEFine PROCedure print_today
5361 LOCal i,temp$
5365 field=0
5369 temp$=DATE$
5373 FOR i=0,2 TO 4:clock_field%(i,4)=temp$(clock_field%(i,0) TO clock_field%(i,1))
5377 FOR i=1 TO 12
5381   IF month$(i)=temp$(6 TO 8):clock_field%(1,4)=i:EXIT i
5385 END FOR i
5389 AT #stick_chan,0,19:PRINT #stick_chan,":":AT #stick_chan,0,10
5393 FOR i=0,2 TO 4:AT #stick_chan,0,clock_field%(i,5):PRINT #stick_chan,clock_field%(i,4)
5397 AT #stick_chan,0,clock_field%(1,5):PRINT #stick_chan,month$(clock_field%(1,4))
5401 END DEFine
5405 :
5409 DEFine PROCedure change_clock
5413 LOCal field,clock_loop
5417 field=0
5421 print_today
5425 REPeat clock_loop
5429   SDATE clock_field%(2,4),clock_field%(1,4),clock_field%(0,4),clock_field%(3,4),clock_field%(4,4),0
5433   this_year=clock_field%(2,4)
5437   IF field>4 OR exit_flag:EXIT clock_loop
5441   AT #stick_chan,0,0:PRINT #stick_chan,DAY$
5445   d$=month$(clock_field%(1,4))
5449   SELect ON field
5453     =0:get_field 2,stick_chan,0,clock_field%(0,5),1,clock_field%(0,4)
5457     =1:get_field 3,stick_chan,0,clock_field%(1,5),4,d$:clock_field%(1,4)=check_clock(d$)
5461     =2:get_field 4,stick_chan,0,clock_field%(2,5),1,clock_field%(2,4)
5465     =3:get_field 2,stick_chan,0,clock_field%(3,5),1,clock_field%(3,4)
5469     =4:get_field 2,stick_chan,0,clock_field%(4,5),1,clock_field%(4,4)
5473   END SELect
5477   IF clock_field%(field,4)<clock_field%(field,2):clock_field%(field,4)=clock_field%(field,3):AT #stick_chan,0,clock_field%(field,5):PRINT #stick_chan,clock_field%(field,4)
5481   IF clock_field%(field,4)>clock_field%(field,3):clock_field%(field,4)=clock_field%(field,2):AT #stick_chan,0,clock_field%(field,5):PRINT #stick_chan,clock_field%(field,4)
5485   field=field+1
5489 END REPeat clock_loop
5493 END DEFine
5497 :
5501 DEFine PROCedure sort_alpha
5505 LOCal i
5509 IF sort_type=10:sort_name_tables(15):sort_name_tables(16)
5513 count=0
5517 DIM sort_table%(longest)
5521 SELect ON sort_type
5525    =20:DIM birth_table(longest)
5529        FOR i=1 TO num_names
5533           IF selected(i)
5537              sort_table%(count)=i
5541              birth_table(count)=yofb(i)
5545              count=count+1
5549           END IF
5553        END FOR i
5557        count=count-1
5561        do_sort birth_table
5565    =30:FOR i=1 TO num_names
5569           IF selected(i)
5573              sort_table%(count)=i
5577              count=count+1
5581           END IF
5585        END FOR i
5589        count=count-1
5593    =10:IF chrispos*surpos/2<=1E7
5597           DIM birth_table(longest)
5601           FOR i=1 TO num_names
5605              IF selected(i)
5609                 sort_table%(count)=i
5613                  birth_table(count)=search_array%(sorted_sur%,0,search_array%(sur_id%,0,ftable%(i)))*(chrispos+1)+search_array%(sorted_chris%,0,search_array%(chris_id%,0,gtable%(i)))-1E7
5617                 count=count+1
5621              END IF
5625           END FOR i
5629           count=count-1
5633           do_sort birth_table
5637        ELSE
5641           er 'Sort space exhausted',''
5645        END IF
5649 END SELect
5653 END DEFine sort_alpha
5657 :
5661 DEFine PROCedure sort_name_tables(sort_flag)
5665 LOCal i
5669    pwait
5673    SELect ON sort_flag
5677       =15:DIM sorted_sur%(surpos)
5681           table_sort 15,surname_table$,surpos,len_sur
5685           FOR i=0 TO surpos:sorted_sur%(i)=sort_table%(i)
5689           order_flag%(0)=1
5693       =16:DIM sorted_chris%(chrispos)
5697           table_sort 16,chris_table$,chrispos,len_chris
5701           FOR i=0 TO chrispos:sorted_chris%(i)=sort_table%(i)
5705           order_flag%(1)=1
5709    END SELect
5713    qwindow err_chan
5717 END DEFine
5721 :
5725 DEFine PROCedure do_sort(table)
5729 LOCal i,d,e,b,temp,j
5733 LOCal sl1,sl2,sl3
5737 i=1
5741 REPeat sl1
5745   IF 2^i>count+1:EXIT sl1
5749   i=i+1
5753 END REPeat sl1
5757 j=2^i-1
5761 REPeat sl2
5765    j=INT(j/2)
5769    IF NOT j:EXIT sl2
5773    b=1:d=count-j+1:i=b
5777    REPeat sl3
5781       e=i+j-1
5785       IF table(i-1)>table(e)
5789          temp=table(e):table(e)=table(i-1)
5793          table(i-1)=temp
5797          temp=sort_table%(e):sort_table%(e)=sort_table%(i-1)
5801          sort_table%(i-1)=temp
5805          i=i-j
5809          IF i<1
5813             b=b+1
5817             IF b>d:EXIT sl3
5821             i=b
5825          END IF
5829          NEXT sl3
5833       END IF
5837       b=b+1
5841       IF b>d:EXIT sl3
5845       i=b
5849    END REPeat sl3
5853 END REPeat sl2
5857 END DEFine
5861 :
5865 DEFine PROCedure dim_param
5869 LOCal k,lc,ls
5873 k=show_menu(1,'Quit','Family Names','Given Names','Places','Comments','Sources','','')
5877 lc=len_chris:ls=len_sur
5881 SELect ON k
5885    =10:RETurn
5889    =20:ls=stick_up$(0,'Family name field:',ls,2,1)
5893    =30:lc=stick_up$(0,'Given name field:',lc,2,1)
5897    =40:len_place=stick_up$(0,'Place name field:',len_place,2,1)
5901        IF len_place>max_len:max_len=len_place
5905    =50:len_com=stick_up$(0,'Comment field:',len_com,2,1)
5909        IF len_com>max_len:max_len=len_com
5913    =60:len_source=stick_up$(0,'Source ref field:',len_source,2,1)
5917        IF len_source>max_len:max_len=len_source
5921 END SELect
5925 IF (lc+ls)>50
5929     er "Length of (family+given names) exceeds 50",""
5933 ELSE
5937    len_chris=lc:len_sur=ls
5941 END IF
5945 IF len_chris>max_len:max_len=len_chris
5949 IF len_sur>max_len:max_len=len_sur
5953 IF len_sur<1:len_sur=1
5957 IF len_chris<1:len_chris=1
5961 IF len_com<1:len_com=1
5965 IF len_place<1:len_place=1
5969 IF len_source<1:len_source=1
5973 IF len_com>50:len_com=50
5977 IF len_place>50:len_place=50
5981 IF len_source>50:len_source=50
5985 order_flag%(k/10-2)=0
5989 SELect ON k
5993    =20:save_table surname_table$,sur_id%,surpos,15
5997    =30:save_table chris_table$,chris_id%,chrispos,16
6001    =40:save_table place_table$,place_id%,placepos,17
6005    =50:save_table comment_table$,com_id%,commentpos,18
6009    =60:save_table source_table$,source_id%,sourcepos,19
6013 END SELect
6017 END DEFine dim_param
6021 :
6025 DEFine PROCedure screen_param(winds)
6029 LOCal k,tc,bc,hi,cw
6033 IF NOT winds
6037    k=show_menu(1,'Quit','Status','Data','Report','Errors','Map','','')
6041    SELect ON k
6045       =10:RETurn
6049       =20:winds=stat_chan
6053       =60:winds=res_chan
6057       =40:winds=pr_chan
6061       =30:winds=data_chan
6065       =50:winds=err_chan
6069    END SELect
6073 END IF
6077    shut sub_chan
6081    RESTORE 6085
6085    DATA 'Quit','A Red-white','B Green-black','C Black-white','D White-red','E Black-green','F White-black','G Green-white','H White-green','I Red-black','J Black-red','K Red-Green','L Green-red'
6089 DIM col_options$(12,13)
6093    FOR cw=0 TO 12:READ col_options$(cw)
6097    cw=get_opt(0,12,col_options$,1,sub_chan,'',0,1)
6101    SELect ON cw
6105       =0:RETurn
6109       =1:bc=3:tc=7:hi=5
6113       =2:bc=5:tc=0:hi=3
6117       =3:bc=0:tc=7:hi=3
6121       =4:bc=7:tc=3:hi=5
6125       =5:bc=0:tc=5:hi=3
6129       =6:bc=7:tc=0:hi=3
6133       =7:bc=5:tc=7:hi=3
6137       =8:bc=7:tc=5:hi=3
6141       =9:bc=3:tc=0:hi=7
6145       =10:bc=0:tc=3:hi=7
6149       =11:bc=3:tc=5:hi=7
6153       =12:bc=5:tc=3:hi=7
6157    END SELect
6161    IF cw
6165       colours%(winds,0)=bc:colours%(winds,1)=tc
6169       colours%(winds,2)=hi
6173    END IF
6177    shut menu_chan:shut sub_chan
6181 END DEFine
6185 :
6189 DEFine PROCedure print_param
6193 LOCal k,kk
6197 k=show_menu(1,'Quit','Length of Page','Line Spacing','Margins','Normal Width','Condensed Width','Multiple Columns','')
6201 SELect ON k
6205    =20:page_length=stick_up$(0,'Page length:',page_length,3,1)
6209       IF page_length<screen_length:page_length=screen_length
6213    =30:line_space=stick_up$(0,'Line Spacing:',line_space,3,1)
6217    =40
6221       kk=show_menu(0,'Quit','Top Margin','Bottom Margin','Left Margin','','','','')
6225       SELect ON kk
6229         =20:top_margin=stick_up$(0,'Top margin:',top_margin,3,1)
6233         =30:bottom_margin=stick_up$(0,'Bottom margin:',bottom_margin,3,1)
6237         =40:lm=stick_up$(0,'Left margin:',lm,2,1)
6241       END SELect
6245    =50:nwidth=stick_up$(0,'Normal width:',nwidth,3,1)
6249    =60:cond_width=stick_up$(0,'Condensed width:',cond_width,3,1)
6253    =70:column$=stick_up$(0,'Columns:',column$,3,0)
6257 END SELect
6261 page_width%(0)=nwidth-lm
6265 page_width%(1)=INT(cond_width-lm/2)
6269 page_width%(2)=INT(nwidth/2-lm*2)
6273 END DEFine
6277 :
6281 DEFine PROCedure save_params
6285 LOCal i,j
6289 DELETE recs_dev$&'CON'
6293 OPEN_NEW #io_chan,recs_dev$&'CON'
6297 PRINT #io_chan,con_ver$
6301 PRINT #io_chan,units
6305 PRINT #io_chan,nwidth
6309 PRINT #io_chan,cond_width
6313 PRINT #io_chan,slot
6317 PRINT #io_chan,page_length
6321 PRINT #io_chan,top_margin
6325 PRINT #io_chan,bottom_margin
6329 PRINT #io_chan,column$
6333 PRINT #io_chan,print_dev$
6337 PRINT #io_chan,lm
6341 PRINT #io_chan,baud_rate
6345 PRINT #io_chan,tol
6349 PRINT #io_chan,reverse_names
6353 PRINT #io_chan,start_person
6357 PRINT #io_chan,fount_type$(1,1)
6361 PRINT #io_chan,fount_type$(1,0)
6365 PRINT #io_chan,fount_type$(2,1)
6369 PRINT #io_chan,fount_type$(2,0)
6373 PRINT #io_chan,preamble$
6377 PRINT #io_chan,postamble$
6381 PRINT #io_chan,tof$
6385 PRINT #io_chan,eol_char$
6389 PRINT #io_chan,mar_char$
6393 PRINT #io_chan,bar$
6397 PRINT #io_chan,lr_col
6401 FOR i=0 TO max_chan
6405    FOR j=0 TO 2:PRINT #io_chan,colours%(i,j)
6409 END FOR i
6413 FOR i=0 TO 12:PRINT #io_chan,rank%(i)
6417 PRINT #io_chan,user_title$
6421 PRINT #io_chan,age_gap
6425 PRINT #io_chan,gen_gap
6429 PRINT #io_chan,line_space$
6433 PRINT #io_chan,line_space
6437 PRINT #io_chan,Spare$\Spare$\Spare$\Spare$\Spare$
6441 CLOSE #io_chan
6445 change_setup=0
6449 END DEFine
6453 :
6457 DEFine PROCedure get_params
6461 LOCal i,j
6465 IF NOT exists%(13):RETurn
6469 m6 "Loading Segment:CON"
6473 OPEN_IN #io_chan,recs_dev$&'CON'
6477 IF EOF(#io_chan):er 'The parameter file contains no information.  Please re-assign your paramaters':qwindow stat_chan:CLOSE #io_chan:RETurn
6481 INPUT #io_chan,i
6485 IF i<>con_ver$:er 'Your parameter file is too old and cannot be read','by this version. Please re-assign your parameters':qwindow stat_chan:CLOSE #io_chan:RETurn
6489 INPUT #io_chan,units
6493 INPUT #io_chan,nwidth
6497 INPUT #io_chan,cond_width
6501 INPUT #io_chan,slot
6505 blanks$=FILL$(' ',slot)
6509 INPUT #io_chan,page_length
6513 INPUT #io_chan,top_margin
6517 INPUT #io_chan,bottom_margin
6521 INPUT #io_chan,column$
6525 INPUT #io_chan,print_dev$
6529 INPUT #io_chan,lm
6533 INPUT #io_chan,baud_rate
6537 INPUT #io_chan,tol
6541 INPUT #io_chan,reverse_names:IF reverse_names:reverse_names$='yes'
6545 INPUT #io_chan,start_person
6549 INPUT #io_chan,fount_type$(1,1)
6553 INPUT #io_chan,fount_type$(1,0)
6557 INPUT #io_chan,fount_type$(2,1)
6561 INPUT #io_chan,fount_type$(2,0)
6565 INPUT #io_chan,preamble$
6569 INPUT #io_chan,postamble$
6573 INPUT #io_chan,tof$
6577 INPUT #io_chan,eol_char$
6581 INPUT #io_chan,mar_char$
6585 INPUT #io_chan,bar$
6589 INPUT #io_chan,lr_col
6593 FOR i=0 TO max_chan
6597    FOR j=0 TO 2:INPUT #io_chan,colours%(i,j)
6601 END FOR i
6605 FOR i=0 TO 12:INPUT #io_chan,rank%(i)
6609 INPUT #io_chan,user_title$
6613 IF NOT EOF(#io_chan)
6617   INPUT #io_chan,age_gap
6621   INPUT #io_chan,gen_gap
6625   INPUT #io_chan,line_space$
6629   INPUT #io_chan,line_space
6633   INPUT #io_chan,Spare$
6637   INPUT #io_chan,Spare$
6641   INPUT #io_chan,Spare$
6645   INPUT #io_chan,Spare$
6649   INPUT #io_chan,Spare$
6653 END IF
6657 units$='miles':IF units=1:units$='km'
6661 page_width%(0)=nwidth-lm
6665 page_width%(1)=INT(cond_width-lm/2)
6669 page_width%(2)=INT(nwidth/2-lm*2)
6673 IF baud_rate:BAUD baud_rate
6677 CLOSE #io_chan
6681 qwindow stat_chan
6685 END DEFine
6689 :
6693 DEFine PROCedure find_name(array_flag)
6697 LOCal c$,s$,field,i,j,flag,si$
6701 LOCal k,find_loop
6705 LOCal print_flag,flag
6709 print_flag=0:total_count=0
6713 set_anchor 0,0,menu_chan
6717 DIM found_names$(num_names,sort_length+13)
6721 REPeat find_loop
6725   DIM options$(4,max_len+14)
6729   options$(0)='Given name  :'&find_chris$
6733   options$(1)='Family name :'&find_sur$
6737   options$(2)='Year        :'&find_year
6741   options$(3)='Markers     :'&find_mark$
6745   options$(4)='Status      :'&find_stat$(find_stat)
6749   k=get_opt(1,4,options$,1,menu_chan,select_menu$,1,1)
6753   SELect ON k
6757   =0:find_chris$=stick_up$(1,'Given name:',find_chris$,len_chris,5)
6761     IF pick_field:find_chris$=PICK_table$(chris_table$,len_chris,chrispos,find_chris$)
6765   =1:find_sur$=stick_up$(1,'Family name:',find_sur$,len_sur,2)
6769     IF pick_field:find_sur$=PICK_table$(surname_table$,len_sur,surpos,find_sur$)
6773   =2:find_year=stick_up$(1,'Year:',find_year,4,1)
6777   =3:shut menu_chan:find_mark$=input_mark$
6781   =4:find_stat=find_stat+1:IF find_stat>3:find_stat=0
6785   =-1:EXIT find_loop
6789   =-2:shut menu_chan:IF NOT report_setup(2):print_flag=1:EXIT find_loop
6793   =-3:shut menu_chan:RETurn
6797   END SELect
6801   shut menu_chan
6805 END REPeat find_loop
6809 shut menu_chan
6813 DIM selected(num_names)
6817 search_table chris_table$,chris_id%,chrispos,gtable%,find_chris$,16
6821 search_table surname_table$,sur_id%,surpos,ftable%,find_sur$,15
6825 spelling_check ftable%,find_sur$,0
6829 maiden_names 0,find_sur$
6833 status_check
6837 IF find_mark$<>''
6841    DIM selected2(num_names)
6845    IF NOT set_markers(selected2):find_mark$=''
6849    FOR i=1 TO num_names:IF selected2(i):selected(i)=selected(i)+32
6853    total_count=total_count+32
6857 END IF
6861 count=0
6865 FOR i=1 TO num_names
6869   flag=0
6873   IF selected(i)=total_count
6877     births_deaths i,tol
6881     IF NOT find_year OR (find_year>=birth AND find_year<=death)
6885       IF NOT qmark%(i,'/')
6889         IF NOT array_flag OR qmark%(i,'T')
6893           j=i
6897           IF '(System Name)' INSTR full_name$(i)=0 AND '*DELETED' INSTR full_name$(i)=0
6901             count=count+1:selected(i)=count:flag=1
6905             IF find_year:mark i,4
6909           END IF
6913         END IF
6917       END IF
6921     END IF
6925   END IF
6929   IF NOT flag:selected(i)=0
6933 END FOR i
6937 IF count=0:er 'No matches found','':RETurn
6941 longest=count:sort_type=10
6945 IF count>1:sort_alpha:ELSE count=count-1
6949 IF print_flag:print_out:RETurn
6953 IF count>0
6957    FOR i=0 TO count:found_names$(i)=full_name$(sort_table%(i))
6961    set_anchor 30,30,table_chan
6965    a$=PICK_table$(found_names$,sort_length+13,count,'')
6969    j=0:IF pick_num>=0:j=sort_table%(pick_num)
6973 END IF
6977 print_family j
6981 END DEFine
6985 :
6989 DEFine PROCedure display_file(opt,dpfile$)
6993 LOCal record$,a$,a,display,count
6997 record$=''
7001 IF THING('FileInfo II extensions')=0
7005   IF FI2_FCALL(dpfile$,0)=0
7009     IF NOT warn('Use FileInfo II to Display File?','','FI2'):FEX dpfile$:RETurn
7013   END IF
7017 END IF
7021 IF opt
7025   IF get_file("Reading: File>",dpfile$,1):RETurn
7029 END IF
7033 dest$=get_dest$
7037 IF dest$==dpfile$:RETurn
7041 OPEN_IN #io_chan,dpfile$
7045 print_heads ""
7049 report_title$=''
7053 count=0
7057 REPeat display
7061   IF EOF(#io_chan):EXIT display
7065   a$=INKEY$(#io_chan,0)
7069   a=CODE(a$)
7073   SELect ON a
7077     =10:count=page_width%(fount_type-1)
7081     =0 TO 8,11 TO 31,192 TO 255: IF dest$<>'scr':record$=record$&a$
7085     =REMAINDER :record$=record$&a$:count=count+1
7089   END SELect
7093   IF count=page_width%(fount_type-1)
7097     IF fprinter(record$):EXIT display
7101     record$='':count=0
7105   END IF
7109 END REPeat display
7113 print_tails
7117 CLOSE #io_chan
7121 END DEFine
7125 :
7129 DEFine PROCedure ancestors
7133 LOCal i,j,k,m$
7137 IF report_setup(1):RETurn
7141 print_heads "Ancestors"
7145 report_title$="Ancestors of "&full_name$(person)
7149 printer report_title$:printer ""
7153 parents
7157 FOR i=1 TO num_names
7161    IF qmark%(i,'/'):selected(i)=0
7165    IF selected(i):get_name_length i,form
7169 END FOR i
7173 sort_alpha
7177 IF count>=0
7181    FOR j=0 TO count
7185       k=sort_table%(j)
7189       FOR i=2 TO maxpow+1
7193          IF selected(k)<(2^i)-1:EXIT i
7197       END FOR i
7201       ahnt=selected(k)+1:ahnt$='A'&ahnt
7205       IF fprinter(pad$(k,ahnt$&' '&relate$(0,i-1,0),form)):EXIT j
7209    END FOR j
7213 END IF
7217 selected(person)=-1
7221 add_marker('A')
7225 print_tails
7229 END DEFine
7233 :
7237 DEFine FuNction check_dir(file_name$,io,message)
7241 LOCal x,record$,win,check_win,check_loop
7245 found=0
7249 OPEN_IN #io_chan,recs_dev$&'tmp'
7253 REPeat check_win
7257    IF EOF(#io_chan):EXIT check_win
7261    INPUT #io_chan,record$
7265    REPeat check_loop
7269       IF EOF(#io_chan):EXIT check_loop
7273       INPUT #io_chan,record$
7277       win='->' INSTR record$
7281       IF win>=3
7285          IF record$(1 TO win-2) INSTR file$=1
7289             dir$=dir$&record$(1 TO win-2)&'_'
7293             CLOSE #io_chan
7297             get_directory recs_dev$
7301             OPEN_IN #io_chan,recs_dev$&'tmp'
7305             NEXT check_win
7309          END IF
7313       END IF
7317       IF LEN(dir$)>8:IF dir$(1)=='n':record$=record$(6 TO)
7321       IF record$==file_name$:found=1:EXIT check_win
7325    END REPeat check_loop
7329    EXIT check_win
7333 END REPeat check_win
7337 CLOSE #io_chan
7341 IF NOT message:RETurn found
7345 SELect ON io
7349    =0:SELect ON found
7353          =0:err_code=0
7357          =1:err_code=-warn('File exists',file_name$,'Overwrite')
7361       END SELect
7365    =1:SELect ON found
7369          =0:err_code=1:er "File not found",""
7373          =1:err_code=0
7377       END SELect
7381 END SELect
7385 RETurn err_code
7389 END DEFine
7393 :
7397 DEFine FuNction get_file(message$,x$,num)
7401 LOCal a$,dir_loop
7405 REPeat dir_loop
7409   exit_flag=0
7413   x$=stick_up$(2,message$,x$,40,0)
7417   IF exit_flag:EXIT dir_loop
7421   get_device(x$)
7425   get_directory x$
7429   IF NOT check_dir(file$,num,1):EXIT dir_loop
7433 END REPeat dir_loop
7437 DELETE recs_dev$&"tmp"
7441 RETurn exit_flag
7445 END DEFine
7449 :
7453 DEFine PROCedure add_spouse
7457 IF '*DELETED*' INSTR full_name$(spic):RETurn
7461 IF next_sp>max_size:next_sp=max_size
7465 grid%(i1,next_sp,0)=spic:grid%(i1,next_sp,1)=1+grid%(i1,next_sp,1)
7469 selected(spic)=1
7473 mark spic,0
7477 next_sp=next_sp+1
7481 IF next_sp>max_size:next_sp=max_size
7485 grid%(i1,next_sp,0)=spic:grid%(i1,next_sp,1)=2+grid%(i1,next_sp,1)
7489 next_sp=next_sp+1
7493 END DEFine
7497 :
7501 DEFine FuNction note_menu
7505 LOCal k,i,q$,j,count_notes
7509 load_records 22,0
7513 IF NOT num_recs OR exit_flag:RETurn -2
7517 link_events(person)
7521 i=point%(person)
7525 IF NOT i:RETurn -2
7529 k=0:num_events=0
7533 REPeat count_notes
7537    IF NOT rec_event%(i):EXIT count_notes
7541    num_events=num_events+1
7545    j=i:i=rec_event%(i)
7549    IF j=i:EXIT count_notes
7553 END REPeat count_notes
7557 DIM doc_table%(num_events)
7561 i=point%(person):gotdocs=0
7565 FOR k=0 TO num_events
7569    doc_table%(gotdocs)=i:gotdocs=gotdocs+1
7573    i=rec_event%(i)
7577 END FOR k
7581 gotdocs=gotdocs-1
7585 RETurn list_recs(0,doc_table%,gotdocs,eve_menu$,1)
7589 END DEFine
7593 :
7597 DEFine FuNction condat$(qual,num)
7601 LOCal m,dash1$,dash2$
7605 con_y=INT(num/1000)
7609 m=INT((num-con_y*1000)/50)
7613 con_d=num-con_y*1000-m*50
7617 SELect ON con_d
7621    =0:con_d$='  '
7625    =1 TO 9:con_d$=' '&con_d
7629    =10 TO 99:con_d$=con_d
7633 END SELect
7637 con_d$=extended_dates$(qual+1)&con_d$
7641 IF qual=4:con_d$=extended_dates$(5)&'  '
7645 con_m$='   ':y$='    '
7649 IF m<13 AND m>0:con_m$=month$(m)
7653 IF con_y>99:y$=con_y
7657 IF LEN(y$)=3:y$=y$&' '
7661 dash1$='-':dash2$='-'
7665 IF con_d$='   ':dash1$=' '
7669 IF con_m$='   ':dash2$=' '
7673 RETurn con_d$&dash1$&con_m$&dash2$&y$
7677 END DEFine
7681 :
7685 DEFine PROCedure dump_cols
7689 LOCal record$,i,j
7693 FOR i=num_lines TO column_length
7697    record$=''
7701    FOR j=0 TO max_cols:record$=record$&page_array$(i,j)&' '
7705    PRINT #pr_chan,lm$&record$&eol$
7709    num_lines=num_lines+1
7713 END FOR i
7717 column=0
7721 DIM page_array$(column_length,max_cols,column_width)
7725 END DEFine
7729 :
7733 DEFine FuNction check_clock(d$)
7737 FOR i=0 TO 12:IF month$(i)==d$:RETurn i
7741 FOR i=1 TO 12:IF num_month$(i)==d$:RETurn i
7745 RETurn 0
7749 END DEFine
7753 :
7757 DEFine FuNction pad$(k,num$,form)
7761 LOCal f$,m$,n$
7765 f$='':n$=num$
7769 IF n$<>'':f$=FILL$('.',name_length)
7773 SELect ON form
7777    =0:m$=given$(gtable%,k)&' '&family$(ftable%,k)&dates$(k)&f$
7781    =1:m$=family$(ftable%,k)&FILL$(' ',len_sur-LEN(family$(ftable%,k))+1)&given$(gtable%,k)&dates$(k)&f$
7785 END SELect
7789 RETurn m$(1 TO name_length)&' {'&n$&'}'
7793 END DEFine
7797 :
7801 DEFine PROCedure records
7805 LOCal k,kkk,recm_loop,search_loop
7809 LOCal acd_loop,page_loop,rep_loop,in_rep,i
7813 od=0:op$='':osou$=''
7817 DATA 'Update '&file_type$(file_type),'Reports','Create EVE','New segment','Statistics','Quit'
7821 DATA 'Open segment','Reports','Create EVE','Statistics','Quit'
7825 REPeat recm_loop
7829    DIM options$(5,12)
7833    SELect ON file_type
7837       =1 TO 12,20:RESTORE 7817
7841                   FOR i=0 TO 5:READ options$(i)
7845                   k=get_opt(0,5,options$,6,menu_chan,'',0,1)
7849       =REMAINDER :RESTORE 7821
7853                   FOR i=0 TO 4:READ options$(i)
7857                   k=get_opt(0,4,options$,5,menu_chan,'',0,1)
7861                   IF k>2:k=k+1
7865                   IF k=0:k=3
7869    END SELect
7873    SELect ON k
7877     =5:EXIT recm_loop
7881     =4:rec_stats
7885     =1:REPeat search_loop
7889            IF NOT num_recs OR file_type<>25:IF select_load:EXIT search_loop
7893            REPeat rep_loop
7897               i=select_files(1)
7901               SELect ON i
7905                  =1:EXIT search_loop
7909                  =2:num_recs=0:EXIT rep_loop
7913               END SELect
7917               IF select_docs:EXIT rep_loop
7921               REPeat in_rep
7925                  i=list_recs(1,doc_table%,gotdocs,report_menu$,list_form)
7929                  SELect ON i
7933                     =0 TO gotdocs:recid=doc_table%(i)
7937                                   REPeat page_loop
7941                                   kkk=show_page(-1,-1,recid,rep_menu$,1)
7945                                   SELect ON kkk
7949                                      =0:current_view=1
7953                                         IF rec_ref%(recid):print_family(rec_ref%(recid)):ELSE er 'Record has not been linked to the network','':print_family person
7957                                         i=show_family(ft_res$)
7961                                      =1:show_text recid
7965                                      =2:search_sur$=family$(rec_ftable%,recid)
7969                                         search_chris$=given$(rec_gtable%,recid)
7973                                         search_place$=place$(rec_ptable%,recid)
7977                                         shut eve_chan:EXIT in_rep
7981                                      =3:EXIT page_loop
7985                                   END SELect
7989                                   END REPeat page_loop
7993                     =-1:print_recs(1)
7997                     =-2:get_distance
8001                     =-3:draw_map(0)
8005                     =-4:IF time_dist:draw_map(1)
8009                     =-5:IF time_dist:time_matrix
8013                     =-6:display_file 1,list_file$
8017                     =-7:shut eve_chan:list_form=4:order_cols
8021                     =-8:save_segment:check_files
8025                         IF exists%(25):recs_file$='':load_records 25,0
8029                         shut eve_chan
8033                         IF select_docs:EXIT in_loop
8037                     =-9:shut eve_chan:lr_col=-lr_col
8041                     =-10:shut eve_chan:EXIT in_rep
8045                  END SELect
8049               END REPeat in_rep
8053            END REPeat rep_loop
8057         END REPeat search_loop
8061     =0,3:IF k=3:old_file$=recs_file$:recs_file$='':i=loadin_segment
8065          IF i OR NOT k
8069             REPeat acd_loop
8073                IF num_recs
8077                   IF update_recs:EXIT acd_loop
8081                ELSE
8085                   add_recs
8089                   IF NOT num_recs:EXIT acd_loop
8093                END IF
8097             END REPeat acd_loop
8101          END IF
8105       =2:make_notes
8109     END SELect
8113 END REPeat recm_loop
8117 END DEFine
8121 :
8125 DEFine FuNction select_files(l_or_p)
8129 LOCal i,st$,rec_sel_loop,k
8133 IF l_or_p:mr=num_recs:ELSE mr=100:max_recs=mr
8137 IF NOT mr:er 'No records in memory','':RETurn 1
8141 st$=note_type$(search_type)
8145 IF search_type1<>search_type:st$=st$&'/'&note_type$(search_type1)
8149 REPeat rec_sel_loop
8153    i=sel_field(l_or_p)
8157    set_anchor -1,-1,stick_chan
8161    set_anchor -1,-1,table_chan
8165    SELect ON i
8169    =0:search_type=get_search_type(9*l_or_p)
8173       st$=note_type$(search_type)
8177    =1:search_chris$=stick_up$(1,'Given name:',search_chris$,len_chris,5)
8181       IF pick_field:search_chris$=PICK_table$(chris_table$,len_chris,chrispos,search_chris$)
8185    =2:search_sur$=stick_up$(1,'Family name:',search_sur$,len_sur,2)
8189       IF pick_field:search_sur$=PICK_table$(surname_table$,len_sur,surpos,search_sur$)
8193    =6:from_date=stick_up$(0,'From:',from_date,4,1)
8197    =7:to_date=stick_up$(0,'To:',to_date,4,1)
8201    =3:search_place$=stick_up$(1,'Place:',search_place$,len_place,5)
8205       IF pick_field:search_place$=PICK_table$(place_table$,len_place,placepos,search_place$)
8209       search_radius=0:search_origin=0
8213    =4:shut menu_chan:draw_map(0):IF search_origin AND search_radius:search_place$=place_table$(search_origin)
8217    =5:x$=PICK_table$(county$,3,num_county,'')
8221       IF pick_num>-1 AND num_county
8225          search_county$=county$(pick_num)
8229          search_county=search_array%(county_table%,1,pick_num)
8233          IF search_county>0:search_county=place_id%(search_county):ELSE search_county=-1
8237       ELSE
8241          search_county=-1:search_county$=''
8245       END IF
8249    =8:mr=stick_up$(0,'Max records:',mr,5,1):max_recs=mr
8253    =10:search_com$=stick_up$(1,'Comment:',search_com$,len_com,5)
8257       IF pick_field:search_com$=PICK_table$(comment_table$,len_com,commentpos,search_com$)
8261    =11:search_source$=stick_up$(1,'Source:',search_source$,len_source,5)
8265       IF pick_field:search_source$=PICK_table$(source_table$,len_source,sourcepos,search_source$)
8269    =9:search_sex=search_sex+1
8273       IF search_sex>2:search_sex=0
8277    =12:d$=condat$(0,0):k=stick_date(0,12)
8281         search_stamp$=condat$(0,k)(2 TO)&']'
8285         IF search_stamp$(1)=' ':search_stamp$(1)=0
8289    =-1:k=0:EXIT rec_sel_loop
8293    =-2:setup_search
8297    =-3:k=l_or_p+1:EXIT rec_sel_loop
8301    =-4:k=1:EXIT rec_sel_loop
8305    END SELect
8309    shut menu_chan
8313 END REPeat rec_sel_loop
8317 shut menu_chan:qwindow stat_chan
8321 RETurn k
8325 END DEFine
8329 :
8333 DEFine FuNction get_search_type(num)
8337 LOCal i
8341 shut menu_chan
8345 set_anchor -1,-1,menu_chan
8349 IF num=9 OR NOT num
8353    i=show_menu(0,"Quit","Birth/Baptism"\"Marriage"\"Death/Burial"\"Other",'All','maSters','')
8357    SELect ON i
8361    =10:RETurn 0
8365    =60:search_type=9:search_type1=9
8369    =20:search_type=1:search_type1=2
8373    =30:search_type=3:search_type1=3
8377    =40:search_type=4:search_type1=5
8381    =50:search_type=0:search_type1=0
8385    =70:search_type=8:search_type1=8
8389    END SELect
8393 ELSE
8397    er 'Cannot reduce Event type search criteria','without reloading'
8401 END IF
8405 RETurn search_type
8409 END DEFine get_search_type
8413 :
8417 DEFine FuNction select_load
8421 LOCal i
8425 make_table
8429 IF select_files(0):RETurn 1
8433 init_recs
8437 exit_flag=0
8441 start_search
8445 FOR i=1 TO 12,20
8449    IF get_limits(i):load_records i,1
8453    IF exit_flag:EXIT i
8457 END FOR i
8461 recs_file$=recs_dev$&file_type$(25):rec_edits=1
8465 RETurn 0
8469 END DEFine select_load
8473 :
8477 DEFine PROCedure init_recs
8481 LOCal i
8485 DIM rec_id%(max_recs),rec_file%(max_recs),rec_date(max_recs),rec_link%(max_recs),rec_stamp(max_recs),rec_type%(max_recs),rec_ref%(max_recs),rec_gtable%(max_recs),rec_ftable%(max_recs),rec_ptable%(max_recs),rec_stable%(max_recs),rec_ctable%(max_recs),rec_exdate%(max_recs),rec_event%(max_recs),rec_relate%(max_recs)
8489 num_recs=0:rec_edits=0:Nxtrec=1
8493 DIM col_names$(11,12)
8497 DATA "Event type","Record id","Date"
8501 DATA "Given name","Family name","Place","County"
8505 DATA "Comment","Source ref","Update Stamp"
8509 DATA "Network no","Relationship"
8513 RESTORE 8497
8517 FOR i=0 TO 11:READ col_names$(i)
8521 END DEFine
8525 :
8529 DEFine PROCedure load_records(num,selective)
8533 LOCal count_refs,ic,x,a$
8537 LOCal i,j,ii,m,d,file$,count
8541 exit_flag=0:pick_field=0
8545 IF NOT num:RETurn
8549 file$=recs_dev$&file_type$(num)
8553 IF file$=recs_file$ AND num=file_type AND NOT selective:RETurn
8557 SELect ON file_type
8561    =1 TO 12,20:IF rec_edits
8565                   IF warn('Edits to segment '&file_type$(file_type)&' have not been saved','','Destroy')
8569                      exit_flag=1:recs_file$=old_file$
8573                      RETurn
8577                   END IF
8581                END IF
8585 END SELect
8589 IF NOT exists%(num)
8593    IF selective:RETurn
8597    IF num=22:init_recs:recs_file$=recs_dev$&file_type$(22):file_type=22:RETurn
8601    IF NOT warn('Segment '&file_type$(num)&' does not exist','creating new one','OK'):init_recs:file_type=num:recs_file$=recs_dev$&file_type$(file_type):ELSE exit_flag=1
8605    RETurn
8609 END IF
8613 num_del=0:recs_file$=file$
8617 redraw_flag=1
8621 OPEN_IN #io_chan,recs_file$
8625 IF EOF(#io_chan):CLOSE #io_chan:RETurn
8629 INPUT #io_chan,record$
8633 INPUT #io_chan,record$
8637 ic=',' INSTR record$
8641 count=record$(1 TO ic-1)
8645 IF NOT selective
8649    max_recs=room+count
8653    init_recs
8657 END IF
8661 i=',' INSTR record$(ic+1 TO)+ic
8665 num_refs=record$(i+1 TO)
8669 count_refs=0
8673 IF selective>=2 AND num_refs<1:CLOSE #io_chan:RETurn
8677 FOR i=0 TO 5:INPUT #io_chan,record$
8681 m6 "Loading Segment:"&file_type$(num)&' ('&(num_recs-num_del)&' records loaded)'
8685 DIM in_list%(13):fposition=1
8689 IF selective
8693    SELect ON selective
8697       =1:file_type=25
8701          FOR ii=1 TO count
8705             get_inlist
8709             IF INT(in_date/1000)>to_date:EXIT ii
8713             IF in_list%(13)=208
8717                IF in_list%(5)=3 AND in_list%(3)
8721                   j=search_array%(rec_id%,0,in_list%(3))
8725                   IF j>0
8729                      IF rec_file%(j)=in_list%(1)
8733                         num_recs=num_recs+1
8737                         IF set_rec(num_recs):EXIT ii
8741                         NEXT ii:EXIT ii
8745                      END IF
8749                   END IF
8753                END IF
8757             END IF
8761             IF 1&&selected(in_list%(7))
8765                IF 2&&selected(in_list%(11))
8769                   IF 4&&selected(in_list%(9))
8773                      IF 8&&selected(in_list%(10))
8777                         IF 16&&selected(in_list%(8))
8781                            IF INT(in_date/1000)>=from_date OR NOT in_date
8785                               IF search_county=in_list%(9) OR search_county=-1
8789                                  IF search_sex=INT(in_list%(13)/100) OR NOT search_sex
8793                                     IF search_type=in_list%(5) OR search_type1=in_list%(5) OR search_type=9 OR (search_type=8 AND NOT in_list%(3))
8797                                         IF search_stamp$=']' OR (search_stamp$ INSTR stamp$(in_stamp))
8801                                           num_recs=num_recs+1
8805                                           IF set_rec(num_recs):num_recs=max_recs:exit_flag=1:EXIT ii
8809                                         END IF
8813                                      END IF
8817                                   END IF
8821                                END IF
8825                             END IF
8829                          END IF
8833                       END IF
8837                    END IF
8841                 END IF
8845              END IF
8849          END FOR ii
8853    =2:file_type=22
8857       FOR ii=1 TO count
8861          get_inlist
8865          IF in_list%(6) AND in_list%(0) AND in_list%(5)<>7
8869             num_recs=num_recs+1
8873             IF set_rec(num_recs):EXIT ii
8877             count_refs=count_refs+1
8881             IF count_refs=num_refs:EXIT ii
8885          END IF
8889       END FOR ii
8893    END SELect
8897 ELSE
8901    file_type=num
8905    num_recs=count:Nxtrec=0:rec_edits=0
8909    FOR i=1 TO num_recs
8913       get_inlist
8917       IF set_rec(i):EXIT i
8921       IF rec_id%(i)>Nxtrec:Nxtrec=rec_id%(i)
8925       length=LEN(surname_table$(rec_ftable%(i)))+LEN(chris_table$(rec_gtable%(i)))
8929       IF length>sort_length:sort_length=length
8933    END FOR i
8937    Nxtrec=Nxtrec+1:sort_length=sort_length+1
8941 END IF
8945 CLOSE #io_chan
8949 IF file_type=22:mark_events(10):DIM point%(max_names),rec_event%(max_recs)
8953 IF file_type=20:mark_events(13)
8957 qwindow stat_chan
8961 END DEFine
8965 :
8969 DEFine PROCedure get_inlist
8973 GET #io_chan,fposition,in_list%(0),in_list%(1),in_date,in_list%(3),in_stamp,in_list%(5),in_list%(6),in_list%(7),in_list%(8),in_list%(9),in_list%(10),in_list%(11),in_list%(12),in_list%(13)
8977 END DEFine
8981 :
8985 DEFine PROCedure sort_recs
8989 LOCal i
8993 IF sort_type=10:sort_name_tables(15):sort_name_tables(16)
8997 count=0
9001 DIM sort_table%(num_recs),birth_table(num_recs)
9005 SELect ON sort_type
9009    =10:FOR i=1 TO num_recs
9013            IF selected(i)
9017               sort_table%(count)=i
9021               birth_table(count)=search_array%(sorted_sur%,0,search_array%(sur_id%,0,rec_ftable%(i)))*(chrispos+1)+search_array%(sorted_chris%,0,search_array%(chris_id%,0,rec_gtable%(i)))-1E7
9025               count=count+1
9029            END IF
9033        END FOR i
9037    =20:FOR i=1 TO num_recs
9041           IF selected(i)
9045              sort_table%(count)=i
9049              birth_table(count)=rec_date(i)
9053              count=count+1
9057           END IF
9061        END FOR i
9065     =30:FOR i=1 TO num_recs
9069           IF selected(i)
9073              sort_table%(count)=i
9077              birth_table(count)=num_recs*rec_file%(i)+rec_id%(i)
9081              count=count+1
9085           END IF
9089        END FOR i
9093 END SELect
9097 count=count-1
9101 do_sort birth_table
9105 END DEFine
9109 :
9113 DEFine PROCedure print_recs(selective)
9117 LOCal i,j,k,l,c,d,k$,m$
9121 LOCal f$,t$,trunc,ii,ik,r$
9125 IF NOT num_recs:er "No records are loaded for printing","":RETurn
9129 DIM selected(num_recs)
9133 f$=from_date:t$=to_date
9137 SELect ON selective
9141    =1:count=check_rec
9145       IF NOT count:RETurn
9149       count=count-1
9153       report_title$=search_title$
9157  =0:count=num_recs-1
9161    FOR ii=1 TO num_recs:IF rec_id%(ii):selected(ii)=1
9165    report_title$="Segment "&file_type$(file_type)&" - All Records"
9169  =2:count=get_doc(recnum)
9173     IF count<0:RETurn
9177     report_title$="Document "&file_type$(file_type)&recnum
9181  =3:count=0
9185     FOR ii=1 TO num_recs:IF ABS(rec_ref%(ii))=person:selected(ii)=1:count=count+1
9189     report_title$="Segment "&file_type$(file_type)&" - "&full_name$(person)
9193  =4:count=gotdocs
9197       report_title$=search_title$
9201    FOR ii=0 TO count:selected(doc_table%(ii))=1
9205 END SELect
9209 IF pcw(2):RETurn
9213 sort_recs
9217 exit_flag=0:k=0
9221 trunc=0
9225 print_heads "Research Data"
9229 printer report_title$:printer ''
9233 SELect ON form_type
9237    =20:FOR i=0 TO count
9241          j=sort_table%(i)
9245          k$=file_type$(rec_file%(j))&rec_id%(j)
9249          IF rec_relate%(j) MOD 100:r$=' ('&relationship$(rec_relate%(j))&')':ELSE r$=''
9253          a$=k$&' '&condat$(rec_exdate%(j),rec_date(j))&' '&rec_name$(j)&' {'&rec_ref%(j)&'}'&r$
9257          pl$=place$(rec_ptable%,j)&' '&get_county$(j):REMark IF pl$<>' ':pl$='at '&pl$
9261          IF comment$(rec_ctable%,j)<>'' AND source$(rec_stable%,j)<>'':cs$=comment$(rec_ctable%,j)&'/'&source$(rec_stable%,j):ELSE cs$=comment$(rec_ctable%,j)&source$(rec_stable%,j)
9265          IF cs$<>'':cs$=' ('&cs$&')'
9269          b$=note_type$(rec_type%(j))&' '&pl$&cs$&stamp$(rec_stamp(j))
9273          IF dest$<>'scr' AND LEN(a$&b$)<page_width%(fount_type-1)
9277             IF fprinter(a$&' '&b$):EXIT i
9281          ELSE
9285             IF fprinter(a$):EXIT i
9289             IF fprinter(b$):EXIT i
9293             IF fprinter(' '):EXIT i
9297          END IF
9301       END FOR i
9305     =10:res_length
9309         FOR i=0 TO count
9313           j=sort_table%(i)
9317           c=0:m$=''
9321           FOR ik=1 TO DIMN(rank%)
9325              a$=get_rank$(ik,j)
9329              IF NOT d:EXIT ik
9333              IF c+d>page_width%(fount_type-1)
9337                 IF NOT trunc
9341                    IF warn("Lines truncated, continue listing?","Current column:"&a$,"List"):printer '':EXIT i
9345                 END IF
9349                 trunc=1
9353                 EXIT ik
9357              END IF
9361              m$=m$&a$&FILL$(' ',d-LEN(a$)+1)
9365              c=LEN(m$)
9369           END FOR ik
9373           IF fprinter(m$):EXIT i
9377        END FOR i
9381 END SELect
9385 print_tails
9389 END DEFine
9393 :
9397 DEFine FuNction stamp$(num)
9401 LOCal temp$
9405 temp$=DATE$(num)
9409 RETurn '['&temp$(10 TO 11)&'-'&temp$(6 TO 8)&'-'&temp$(1 TO 4)&']'
9413 END DEFine
9417 :
9421 DEFine FuNction get_limits(num)
9425 LOCal i
9429 flag=0
9433 FOR i=0 TO len_table
9437    IF limit_table(i,3)=num AND (limit_table(i,0)=search_type OR limit_table(i,0)=search_type1 OR search_type>7)
9441       flag=1
9445       IF (to_date+1)*1000<limit_table(i,1):flag=0
9449       IF from_date*1000>limit_table(i,2):flag=0
9453    END IF
9457    IF flag=1:EXIT i
9461 END FOR i
9465 RETurn flag
9469 END DEFine
9473 :
9477 DEFine FuNction update_recs
9481 LOCal i,gotdocs,page_loop,j
9485 LOCal out_loop,did_loop,top_loop
9489 REPeat out_loop
9493    IF NOT num_recs:RETurn 1
9497    recnum=0
9501    REPeat top_loop
9505       exit_flag=0
9509       DIM options$(0,18)
9513       options$(0)='Record id:'&file_type$(file_type)&recnum
9517       m6 (num_recs-num_del)&' records loaded'
9521       set_anchor 120,112,menu_chan
9525       i=get_opt(0,0,options$,1,menu_chan,getrec_menu$,1,1)
9529       qwindow stat_chan
9533       SELect ON i
9537          =0:set_anchor -1,-1,stick_chan
9541             recnum=stick_up$(2,file_type$(file_type),recnum,5,1)
9545             gotdocs=1:DIM doc_table%(1):doc_table%(1)=rec_pos(recnum)
9549             i=update_doc(rec_pos(recnum))
9553          =-1:IF NOT select_files(1):EXIT top_loop
9557          =-2:add_recs
9561          =-3:id_menu(0)
9565          =-4:print_recs(0)
9569          =-5:RETurn 1
9573       END SELect
9577    END REPeat top_loop
9581    REPeat page_loop
9585       IF select_docs:EXIT page_loop
9589       exit_flag=0
9593       REPeat did_loop
9597          recid=list_recs(1,doc_table%,gotdocs,upd_menu$,list_form)
9601          set_anchor 0,0,menu_chan
9605          SELect ON recid
9609             =0 TO gotdocs:recid=doc_table%(recid)
9613                           IF update_doc(recid):EXIT did_loop
9617             =-1:add_recs
9621             =-2:id_menu(0)
9625             =-3:print_recs(4)
9629             =-4:shut eve_chan:list_form=4:order_cols
9633             =-5:shut eve_chan:lr_col=-lr_col
9637             =-6:save_recs
9641             =-7:EXIT page_loop
9645          END SELect
9649       END REPeat did_loop
9653       shut eve_chan
9657    END REPeat page_loop
9661    shut eve_chan
9665 END REPeat out_loop
9669 RETurn 0
9673 END DEFine
9677 :
9681 DEFine FuNction update_doc(kc)
9685 LOCal ka,i,field,a$,x$,d$,upd_loop
9689 IF NOT kc:er 'Nothing found with specified recordid','':RETurn 0
9693 REPeat upd_loop
9697 ka=show_page(-1,-1,kc,page_list$,1)
9701 SELect ON ka
9705    =0:current_view=1:IF rec_ref%(kc):print_family(rec_ref%(kc)):ELSE er 'Record has not been linked to the network','':print_family person
9709       i=show_family(ft_res$):current_view=0:print_family person
9713    =4:recnum=rec_id%(kc):print_recs(2)
9717    =5:flag=get_text(kc)
9721    =6:shut data_chan:EXIT upd_loop
9725    =3:put_note(kc)
9729    =2:IF rec_link%(kc)
9733          IF NOT warn ("You are about to DELETE this RECORD","","Delete")
9737             DIM in_list%(13):in_date=0:in_stamp=0
9741             num_del=num_del+1
9745             j=set_rec(kc):rec_edits=1:RETurn 1
9749          END IF
9753       ELSE
9757          IF NOT warn("This is the Master Record","ALL records in this document will be DELETED","Delete")
9761             DIM in_list%(13):in_date=0:in_stamp=0
9765             FOR i=1 TO num_recs:IF rec_link%(i)=rec_id%(kc):j=set_rec(i):num_del=num_del+1
9769             j=set_rec(kc):rec_edits=1:num_del=num_del+1
9773             shut data_chan:RETurn 1
9777          END IF
9781       END IF
9785     =1:field=rec_field(kc):rec_edits=1
9789        rec_stamp(kc)=DATE
9793        d$=condat$(rec_exdate%(kc),rec_date(kc))
9797        SELect ON field
9801           =0:rec_date(kc)=stick_date(rec_date(kc),12):rec_exdate%(kc)=qual
9805           =4:rec_ref%(kc)=stick_up$(0,'Net no:',rec_ref%(kc),6,6)
9809           =2:a$=stick_up$(1,'Given name:',given$(rec_gtable%,kc),len_chris,-1)
9813              rec_gtable%(kc)=add_table%(chris_table$,chris_id%,a$,16)
9817           =3:a$=stick_up$(1,'Family name:',family$(rec_ftable%,kc),len_sur,2)
9821              rec_ftable%(kc)=add_table%(surname_table$,sur_id%,a$,15)
9825           =5:a$=stick_up$(1,'Place:',place$(rec_ptable%,kc),len_place,5)
9829              rec_ptable%(kc)=add_table%(place_table$,place_id%,a$,17)
9833           =6:a$=stick_up$(1,'Comment:',comment$(rec_ctable%,kc),len_com,0)
9837              rec_ctable%(kc)=add_table%(comment_table$,com_id%,a$,18)
9841           =7:a$=stick_up$(1,'Source ref:',source$(rec_stable%,kc),len_source,0)
9845              rec_stable%(kc)=add_table%(source_table$,source_id%,a$,19)
9849           =8,9:rec_relate%(kc)=get_relate(kc)
9853           =1:i=get_note_type:IF i<0:EXIT upd_loop
9857              rec_type%(kc)=i
9861           =10:i=stick_up$(1,'Document number:',rec_link%(kc),5,1)
9865               IF i<Nxtrec AND i>=0
9869                  IF NOT i
9873                     rec_relate%(kc)=1+INT(rec_relate%(kc)/100)*100
9877                  ELSE
9881                     IF rec_relate%(kc) MOD 100=1:rec_relate%(kc)=rec_relate%(kc)-1
9885                  END IF
9889                  rec_link%(kc)=i
9893               ELSE
9897                  er 'Number out of range',''
9901               END IF
9905        END SELect
9909     END SELect
9913 END REPeat upd_loop
9917 RETurn 0
9921 END DEFine
9925 :
9929 DEFine PROCedure save_recs
9933 IF status:RETurn
9937 save_table surname_table$,sur_id%,surpos,15
9941 save_table chris_table$,chris_id%,chrispos,16
9945 save_table place_table$,place_id%,placepos,17
9949 save_table comment_table$,com_id%,commentpos,18
9953 save_table source_table$,source_id%,sourcepos,19
9957 table_edits=0
9961 save_data
9965 save_segment
9969 END DEFine
9973 :
9977 DEFine PROCedure save_segment
9981 LOCal i,count,j
9985 LOCal from_year(5),to_year(5)
9989 IF file_type
9993    FOR i=0 TO 5:from_year(i)=1E7
9997    count=0
10001    m6 "Saving Segment:"&file_type$(file_type)
10005    file$=recs_file$
10009    IF file$='':file$=recs_dev$&file_type$(file_type)
10013    DELETE file$
10017    OPEN_NEW #io_chan,file$
10021    ref_count=0
10025    FOR i=1 TO num_recs
10029       IF rec_id%(i)
10033          IF rec_ref%(i):ref_count=ref_count+1
10037          j=rec_type%(i)
10041          IF rec_date(i)<from_year(j) AND rec_date(i)<>0:from_year(j)=rec_date(i)
10045          IF rec_date(i)>to_year(j):to_year(j)=rec_date(i)
10049          count=count+1
10053       END IF
10057    END FOR i
10061    PRINT #io_chan,'"limits"'
10065    PRINT #io_chan,count;',';file_type;',';ref_count
10069    FOR i=0 TO 5
10073       PRINT #io_chan,i;',';from_year(i);',';to_year(i)
10077    END FOR i
10081    chron_sort:fposition=1
10085    FOR i=0 TO count
10089       j=sort_table%(i)
10093       IF rec_id%(j)
10097          PUT #io_chan,fposition,rec_id%(j),rec_file%(j),rec_date(j),rec_link%(j),rec_stamp(j),rec_type%(j),rec_ref%(j),rec_ftable%(j),rec_stable%(j),rec_ptable%(j),rec_ctable%(j),rec_gtable%(j),rec_exdate%(j),rec_relate%(j)
10101       END IF
10105    END FOR i
10109    CLOSE #io_chan
10113    rec_edits=0
10117 END IF
10121 qwindow stat_chan
10125 END DEFine
10129 :
10133 DEFine PROCedure check_files
10137 LOCal ki
10141 DIM exists%(25)
10145 get_device(recs_dev$)
10149 get_directory recs_dev$
10153 FOR ki=0 TO 25:exists%(ki)=check_dir(file$&file_type$(ki),1,0)
10157 DELETE recs_dev$&"tmp"
10161 END DEFine
10165 :
10169 DEFine PROCedure make_table
10173 LOCal count,record$,i,j,ki,ic,ib
10177 check_files
10181 DIM limit_table(36,3),comma(7)
10185 count=-1:max_refs=0
10189 FOR ki=1 TO 12,20
10193    IF exists%(ki)
10197       OPEN_IN #io_chan,recs_dev$&file_type$(ki)
10201       IF EOF(#io_chan):CLOSE #io_chan:NEXT ki:EXIT ki
10205       INPUT #io_chan,record$:IF record$<>'"limits"':CLOSE #io_chan:NEXT ki:EXIT ki
10209       INPUT #io_chan,record$:ic=',' INSTR record$:ib=',' INSTR record$(ic+1 TO)+ic
10213       max_refs=max_refs+record$(ib+1 TO)
10217       FOR i=0 TO 5
10220          IF EOF(#io_chan):EXIT i
10221          INPUT #io_chan,record$
10225          IF record$<>i&',9.999999E6,0' AND record$<>i&',1E7,0'
10229             comma(1)=',' INSTR record$
10233             FOR j=1 TO 2
10237               comma(j)="," INSTR record$(comma(j-1)+1 TO)+comma(j-1)
10241             END FOR j
10245             comma(3)=LEN(record$)+1
10249             count=count+1
10253             IF count>DIMN(limit_table,1):CLOSE #io_chan:EXIT ki
10257             limit_table(count,0)=record$(1 TO comma(1)-1)
10261             FOR j=1 TO 2:limit_table(count,j)=record$(comma(j)+1 TO comma(j+1)-1)
10265             limit_table(count,3)=ki
10269          END IF
10273       END FOR i
10277       CLOSE #io_chan
10281    END IF
10285 END FOR ki
10289 len_table=count
10293 END DEFine
10297 :
10301 DEFine FuNction show_page(x%,y%,si,menu_list$,read_ptr)
10305 LOCal a$,ii,i,q$
10309 ii=max_len+16
10313 point_window x%,y%,data_chan,ii*6+4,102
10317 PRINT #data_chan,file_type$(rec_file%(si))&rec_id%(si)
10321 PRINT #data_chan,condat$(rec_exdate%(si),rec_date(si))
10325 i=rec_ref%(si):q$=''
10329 IF i<0:q$=' {Maybe'&rec_ref%(si)&'?}'
10333 IF i>0:q$=' {'&rec_ref%(si)&'}'
10337 STRIP #data_chan,colours%(data_chan,1):INK #data_chan,colours%(data_chan,0)
10341 a$=rec_name$(si)&q$
10345 AT #data_chan,2,(ii-LEN(a$))/2:PRINT #data_chan,a$
10349 AT #data_chan,4,0
10353 PRINT #data_chan,note_type$(rec_type%(si));
10357 STRIP #data_chan,colours%(data_chan,0):INK #data_chan,colours%(data_chan,1)
10361 a$=place$(rec_ptable%,si)
10365 IF a$=''
10369    PRINT #data_chan
10373 ELSE
10377    PRINT #data_chan,' at '&a$&' '&get_county$(si)
10381 END IF
10385 PRINT #data_chan,"Comment: "&comment$(rec_ctable%,si)
10389 PRINT #data_chan,"Source : "&source$(rec_stable%,si)
10393 a$=''
10397 IF rec_file%(si)<13:a$=segments$(rec_file%(si)-1)
10401 IF rec_file%(si)=20:a$=segments$(12)
10405 PRINT #data_chan,"Segment: "&a$
10409 a$=''
10413 IF file_type<>22 AND file_type<>25:a$=' of '&rec_name$(rec_pos(rec_link%(si)))
10417 k=rec_link%(si)
10421 SELect ON k
10425    =0:PRINT #data_chan,'Master Record';
10429    =REMAINDER :IF rec_relate%(si) MOD 100:PRINT #data_chan,relationship$(rec_relate%(si))&a$;
10433 END SELect
10437 IF (rec_relate%(si) MOD 10)<2:PRINT #data_chan,' ('&sex$(rec_relate%(si))&')'
10441 AT #data_chan,9,ii-14:PRINT #data_chan,stamp$(rec_stamp(si))
10445 IF NOT DIMN(menu_list$):RETurn 0
10449 k=get_opt(0,DIMN(menu_list$),menu_list$,DIMN(menu_list$)+1,menu_chan,'',0,1)
10453 shut data_chan
10457 RETurn k
10461 END DEFine
10465 :
10469 DEFine PROCedure add_recs
10473 LOCal s1$,s2$,mon_count,i,k,c1$,c2$
10477 LOCal wit_loop,mon_loop,oth_loop,next_rel
10481 LOCal grec,brec,gage,bage,j
10485 SELect ON file_type
10489    =1:put_rec 1,1,"Details of BABY",'','':c1$="Birth of "&given$(rec_gtable%,num_recs)
10493       s1$=family$(rec_ftable%,num_recs)
10497       REPeat wit_loop
10501          k=get_opt(0,4,baby_menu$,5,menu_chan,'',0,1)
10505          SELect ON k
10509             =0:put_rec 102,0,"FATHER's Details",c1$,s1$
10513             =1:put_rec 202,0,"MOTHER's Details",c1$,s1$
10517             =2:put_rec 0,0,"INFORMANT's Details",c1$,''
10521             =3:put_rec 0,0,"OTHER PERSON's Details",c1$&' '&s1$,''
10525             =4:EXIT wit_loop
10529          END SELect
10533       END REPeat wit_loop
10537    =2,5:put_rec 101,3,"GROOM's Details",'','':s1$=family$(rec_ftable%,num_recs)
10541         c1$=given$(rec_gtable%,num_recs):gage=age:grec=num_recs
10545         IF c1$<>''
10549            next_rel=208
10553            c1$="Mar of "&c1$
10557         ELSE
10561            next_rel=201:num_recs=num_recs-1
10565            Nxtrec=Nxtrec-1
10569         END IF
10573         put_rec next_rel,3,"BRIDE's Details",mar_char$&s1$,'':s2$=family$(rec_ftable%,num_recs)
10577         c2$=given$(rec_gtable%,num_recs):bage=age:brec=num_recs
10581         IF c2$<>''
10585            c2$="Mar of "&c2$
10589            update_groom
10593         ELSE
10597            num_recs=num_recs-1:Nxtrec=Nxtrec-1
10601         END IF
10605         IF c1$<>'' OR c2$<>''
10609            REPeat wit_loop
10613               k=get_opt(0,4,wedding_menu$,5,menu_chan,'',0,1)
10617                SELect ON k
10621                =0:put_rec 102,0,"GROOM's FATHER's Details",c1$,s1$
10625                =1:put_rec -101,0,"BRIDE's FATHER's Details",c2$,s2$
10629                =2:put_rec 0,0,"WITNESS's Details","Wit "&s1$&mar_char$&s2$,''
10633                =3:put_rec 0,0,"OTHER PERSON's Details","Ref "&s1$&mar_char$&s2$,''
10637                =4:EXIT wit_loop
10641                END SELect
10645             END REPeat wit_loop
10649          END IF
10653          age=gage:add_age '',num_recs-grec+1
10657          age=bage:add_age '',num_recs-brec+1
10661    =10:put_rec 101,3,"GROOM's Details",'','':s1$=family$(rec_ftable%,num_recs)
10665        c1$=given$(rec_gtable%,num_recs)
10669        next_rel=208
10673        IF c1$='':next_rel=201:num_recs=num_recs-1:Nxtrec=Nxtrec-1
10677        put_rec next_rel,3,"BRIDE's Details",mar_char$&s1$,''
10681        c2$=given$(rec_gtable%,num_recs)
10685        IF c2$=''
10689           num_recs=num_recs-1:Nxtrec=Nxtrec-1
10693        ELSE
10697           s2$=family$(rec_ftable%,num_recs):update_groom
10701        END IF
10705    =3:put_rec 1,4,"Details of DECEASED",'','':add_age '',1
10709       i=num_recs
10713       REPeat wit_loop
10717           k=get_opt(0,1,inform_menu$,2,menu_chan,'',0,1)
10721           SELect ON k
10725             =0:put_rec 0,0,"INFORMANT's Details",'Ref '&rec_name$(i),''
10729             =1:EXIT wit_loop
10733           END SELect
10737       END REPeat wit_loop
10741    =4,9:put_rec 1,2,"Details of BAPTISED",'','':c1$='Bap of '&given$(rec_gtable%,num_recs)
10745        s1$=family$(rec_ftable%,num_recs)
10749        REPeat wit_loop
10753           k=get_opt(0,2,bap_menu$,3,menu_chan,'',0,1)
10757           SELect ON k
10761              =0:put_rec 102,0,"FATHER's Details",c1$,s1$
10765              =1:put_rec 202,0,"MOTHER's Details",c1$,s1$
10769              =2:EXIT wit_loop
10773           END SELect
10777        END REPeat wit_loop
10781    =6:put_rec 1,5,"Details of DECEASED",'','':xref=recnum:add_age '',1
10785    =7:put_cen
10789    =8:put_rec 1,0,"TESTATOR's Details",'Will',''
10793       s1$=family$(rec_ftable%,num_recs)
10797       i=num_recs
10801       REPeat wit_loop
10805          IF next_person:EXIT wit_loop
10809          put_rec 0,0,"NEXT PERSON's Details","Will of "&rec_name$(i),s1$
10813       END REPeat wit_loop
10817    =11:DIM mon_age(10)
10821        put_rec 1,5,"MAIN DECEASED's Details",'Monument','':mon_count=1:mon_age(1)=age
10825       s1$=family$(rec_ftable%,num_recs)
10829       i=num_recs
10833       REPeat mon_loop
10837          IF next_person:EXIT mon_loop
10841          put_rec 0,5,"OTHER DECEASED's Details","Ref "&rec_name$(i),s1$:mon_count=mon_count+1:mon_age(mon_count)=age
10845          IF mon_count>10:EXIT mon_loop
10849       END REPeat mon_loop
10853       j=mon_count
10857       FOR i=1 TO mon_count
10861          age=mon_age(i)
10865          add_age '',j
10869          IF age=0:j=j-1
10873       END FOR i
10877    =12:put_rec 1,get_note_type,"FIRST PERSON's Details",'',''
10881       s1$=family$(rec_ftable%,num_recs)
10885       i=num_recs
10889       REPeat oth_loop
10893          IF next_person:EXIT oth_loop
10897          put_rec 0,get_note_type,"NEXT PERSON's Details","",s1$
10901       END REPeat oth_loop
10905    =20:IF NOT num_names
10909           er 'Cannot add notes as no network is loaded',''
10913           file_type=0:recs_file$=''
10917        ELSE
10921           m6 "Locate person and hit <OK>"
10925           current_view=1:print_family person:k=show_family(ft1_menu$):qwindow stat_chan
10929           IF k:current_view=0:RETurn
10933           put_note(0)
10937        END IF
10941 END SELect
10945 END DEFine
10949 :
10953 DEFine PROCedure put_rec(master,type,h$,m$,s$)
10957 LOCal x$,field,max_field,pr_loop
10961 IF NOT get_recnum:RETurn
10965 IF type<0:RETurn
10969 point_window -1,-1,data_chan,(max_len+23)*6+4,102
10973 IF master MOD 100=1
10977    xref=recnum:rec_link%(num_recs)=0
10981    rec_date(num_recs)=0:od=0:qual=0
10985 ELSE
10989    rec_link%(num_recs)=xref
10993    rec_date(num_recs)=od
10997 END IF
11001 pick_field=0:rec_exdate%(num_recs)=qual:rec_edits=1
11005 rec_ftable%(num_recs)=add_table%(surname_table$,sur_id%,s$,15)
11009 rec_ptable%(num_recs)=add_table%(place_table$,place_id%,op$,17)
11013 rec_stable%(num_recs)=add_table%(source_table$,source_id%,osou$,19)
11017 rec_id%(num_recs)=recnum:rec_file%(num_recs)=file_type
11021 rec_stamp(num_recs)=DATE:rec_type%(num_recs)=type
11025 field=1:max_field=9:age=0
11029 IF (NOT rec_link%(num_recs) AND file_type=3) OR file_type=6 OR file_type=11 OR ((file_type=2 OR file_type=5) AND type=3):max_field=10
11033 rec_ctable%(num_recs)=add_table%(comment_table$,com_id%,m$,18)
11037 show_rec max_field,recnum,h$
11041 set_anchor outlnx/2-(3*(max_len+23)+2),77,table_chan
11045 new_details
11049 REPeat pr_loop
11053    d$=condat$(rec_exdate%(num_recs),rec_date(num_recs))
11057    SELect ON field
11061    =1:a$=given$(rec_gtable%,num_recs)
11065       get_field len_chris,data_chan,2,19,-1,a$
11069       rec_gtable%(num_recs)=add_table%(chris_table$,chris_id%,a$,16)
11073    =2:a$=family$(rec_ftable%,num_recs)
11077       get_field len_sur,data_chan,3,19,2,a$
11081       rec_ftable%(num_recs)=add_table%(surname_table$,sur_id%,a$,15)
11085    =3:a$=place$(rec_ptable%,num_recs)
11089       get_field len_place,data_chan,4,19,5,a$
11093       rec_ptable%(num_recs)=add_table%(place_table$,place_id%,a$,17)
11097       AT #data_chan,4,20+LEN(a$):PRINT #data_chan,get_county$(num_recs)
11101    =4:a$=comment$(rec_ctable%,num_recs)
11105       get_field len_com,data_chan,5,19,0,a$
11109       rec_ctable%(num_recs)=add_table%(comment_table$,com_id%,a$,18)
11113    =5:a$=source$(rec_stable%,num_recs)
11117       get_field len_source,data_chan,6,19,0,a$
11121       rec_stable%(num_recs)=add_table%(source_table$,source_id%,a$,19)
11125    =6,7,8:rec_date(num_recs)=get_date(data_chan,7,19,field)
11129           rec_exdate%(num_recs)=qual
11133    =9:REPeat refchk
11137          get_field 6,data_chan,8,19,1,rec_ref%(num_recs)
11141          IF ABS(rec_ref%(num_recs))<=num_names:print_family(rec_ref%(num_recs)):EXIT refchk
11145          BEEP 1500,100:rec_ref%(num_recs)=0
11149       END REPeat refchk
11153    =10:get_field 3,data_chan,9,19,1,age
11157    END SELect
11161    IF exit_flag
11165       od=rec_date(num_recs):op$=place$(rec_ptable%,num_recs)
11169       osou$=source$(rec_stable%,num_recs)
11173       EXIT pr_loop
11177    END IF
11181    field=upfield(field,1,max_field)
11185 END REPeat pr_loop
11189 qwindow stat_chan
11193 IF LEN(rec_name$(num_recs))>sort_length:sort_length=LEN(rec_name$(num_recs))
11197 IF master=0 OR master=1:master=get_relate(num_recs)
11201 rec_relate%(num_recs)=master
11205 qwindow data_chan
11209 END DEFine
11213 :
11217 DEFine PROCedure add_age(pob$,ba)
11221 LOCal a$,year
11225 IF NOT age:RETurn
11229 IF NOT get_recnum:RETurn
11233 copy_rec num_recs-ba,recnum
11237 a$=pob$
11241 rec_ptable%(num_recs)=add_table%(place_table$,place_id%,a$,17)
11245 year=INT(rec_date(num_recs-ba)/1000)
11249 a$="Aged "&age
11253 rec_ctable%(num_recs)=add_table%(comment_table$,com_id%,a$,18)
11257 rec_file%(num_recs)=file_type
11261 rec_date(num_recs)=(year-age)*1000
11265 rec_link%(num_recs)=xref
11269 rec_type%(num_recs)=1
11273 rec_exdate%(num_recs)=1
11277 END DEFine add_age
11281 :
11285 DEFine PROCedure put_cen
11289 LOCal year,k,field,max_field,occ$,co$,con$
11293 LOCal a$,com$,house_loop,ans$,count,i
11297 LOCal person_loop,cen_loop
11301 pick_field=0
11305 set_anchor 20,30,menu_chan
11309 year=show_menu(0\"A. 1841"\"B. 1851"\"C. 1861"\"D. 1871"\"E. 1881"\"F. 1891",'Other','Quit')
11313 IF year=80 THEN
11317    qwindow stat_chan
11321    RETurn
11325 END IF
11329 IF year=70
11333    next_field=1
11337    m6 'Enter census date'
11341    d$=condat$(0,0):census_date(6)=stick_date(0,12)
11345    qwindow stat_chan
11349 END IF
11353 ans$='':co$=''
11357 point_window -1,-1,data_chan,(max_len+23)*6+4,142
11361 set_anchor outlnx/2-(3*(max_len+23)+2),62,table_chan
11365 REPeat house_loop
11369    occ$='':con$='':pob$=''
11373    IF NOT get_recnum:EXIT house_loop
11377    max_field=9
11381    IF year<>10:max_field=10:con$=""
11385    rec_link%(num_recs)=0:xref=recnum:age=0
11389    count=0
11393    REPeat person_loop
11397       new_details
11401       com$=FILL$(' ',20)
11405       age=0:field=1
11409       rec_date(num_recs)=census_date(year/10-1)
11413       rec_id%(num_recs)=recnum:rec_file%(num_recs)=file_type
11417       rec_stamp(num_recs)=DATE
11421       show_cen(count)
11425       REPeat cen_loop
11429          SELect ON field
11433       =1:a$=place$(rec_ptable%,num_recs)
11437          get_field len_place,data_chan,3,19,5,a$
11441          rec_ptable%(num_recs)=add_table%(place_table$,place_id%,a$,17)
11445          co$=get_county$(num_recs)
11449          AT #data_chan,3,20+LEN(a$):PRINT #data_chan,co$
11453       =2:get_field INT(2*(len_com-3)/3),data_chan,4,19,5,ans$
11457       =3:a$=source$(rec_stable%,num_recs)
11461          get_field len_source,data_chan,5,19,0,a$
11465          rec_stable%(num_recs)=add_table%(source_table$,source_id%,a$,19)
11469       =4:a$=given$(rec_gtable%,num_recs)
11473          get_field len_chris,data_chan,6,19,-1,a$
11477          rec_gtable%(num_recs)=add_table%(chris_table$,chris_id%,a$,16)
11481       =5:a$=family$(rec_ftable%,num_recs)
11485          get_field len_sur,data_chan,7,19,2,a$
11489          rec_ftable%(num_recs)=add_table%(surname_table$,sur_id%,a$,15)
11493       =6:get_field 3,data_chan,8,19,1,age
11497       =7:get_field INT((len_com-3)/3),data_chan,9,19,5,occ$
11501       =8:get_field 6,data_chan,10,19,6,rec_ref%(num_recs)
11505       =9:get_field len_place,data_chan,11,19,5,pob$
11509          i=add_table%(place_table$,place_id%,pob$,17)
11513       =10:get_field 1,data_chan,12,19,2,con$
11517          END SELect
11521          IF exit_flag:EXIT cen_loop
11525          field=upfield(field,1,max_field)
11529       END REPeat cen_loop
11533       qwindow stat_chan
11537       rec_relate%(num_recs)=get_relate(num_recs)
11541       IF ans$=' ':ans$=''
11545       IF occ$=' ':occ$='':IF con$=' ':con$=''
11549       a$=ans$
11553       IF LEN(a$) AND LEN(occ$):a$=a$&"/"
11557       a$=a$&occ$
11561       IF LEN(a$) AND LEN(con$):a$=a$&"/"
11565       a$=a$&con$
11569       occ$=''
11573       rec_ctable%(num_recs)=add_table%(comment_table$,com_id%,a$,18)
11577       IF LEN(rec_name$(num_recs))>sort_length:sort_length=LEN(rec_name$(num_recs))
11581       old_source=rec_stable%(num_recs):old_place=rec_ptable%(num_recs)
11585       IF age:add_age pob$,1
11589       k=get_opt(0,2,census_menu$,3,menu_chan,'',0,1)
11593       SELect ON k
11597          =2:EXIT house_loop
11601          =1:EXIT person_loop
11605       END SELect
11609       IF NOT get_recnum:EXIT house_loop
11613       rec_link%(num_recs)=xref:rec_ftable%(num_recs)=rec_ftable%(num_recs-1)
11617       rec_stable%(num_recs)=old_source:rec_ptable%(num_recs)=old_place
11621       count=1
11625    END REPeat person_loop
11629 END REPeat house_loop
11633 rec_edits=1
11637 qwindow data_chan:qwindow stat_chan
11641 END DEFine
11645 :
11649 DEFine PROCedure identify(p)
11653 LOCal recnum,start,fin,pc,pc$
11657 IF NOT num_names:RETurn
11661 IF NOT file_type OR file_type=20:RETurn
11665 recnum=1:REMark recnum=0:recpoint=0
11669 set_anchor -1,-1,stick_chan
11673 pwait
11677 DELETE recs_dev$&'IDE'
11681 OPEN_NEW #ide_chan,recs_dev$&'IDE'
11685 exit_flag=0:id_count=0
11689 IF p:start=p:fin=p:ELSE start=1:fin=num_names
11693 pc=100/(num_recs-recnum+1)
11697 FOR ii=recnum TO num_recs
11701    pc$=INT((ii-recnum+1)*pc):m6 pc$&'%'
11705    IF rec_type%(ii)<>7
11709       IF rec_ref%(ii)<=0 AND rec_id%(ii)
11713          total_count=0:DIM selected(num_names)
11717          search_table chris_table$,chris_id%,chrispos,gtable%,given$(rec_gtable%,ii),16
11721          search_table surname_table$,sur_id%,surpos,ftable%,family$(rec_ftable%,ii),15
11725          spelling_check ftable%,family$(rec_ftable%,ii),0
11729          maiden_names 0,family$(rec_ftable%,ii)
11733          FOR jj=start TO fin
11737             IF match(ii,jj):PRINT #ide_chan,ii;',';jj:id_count=id_count+1
11741          END FOR jj
11745       END IF
11749    END IF
11753 END FOR ii
11757 CLOSE #ide_chan
11761 IF NOT id_count:DELETE recs_dev$&'IDE'
11765 qwindow stat_chan
11769 qwindow err_chan
11773 END DEFine
11777 :
11781 DEFine FuNction match(ii,jj)
11785 REMark LOCal ma$,mb$,year,birth,death,type,ymin,ymax
11789 LOCal rel
11793 IF rec_relate%(ii)<100 OR INT(rec_relate%(ii)/100)=sex%(jj) OR NOT sex%(jj)
11797    IF selected(jj)=total_count
11801       births_deaths jj,tol
11805       type=rec_type%(ii)
11809       IF (yofb(jj)<100 AND type<3) OR (yofd%(jj)<100 AND type>3):type=0
11813       SELect ON type
11817          =1,2:ymin=birth-tol:ymax=birth+tol
11821          =0,3:ymin=birth-tol:ymax=death+tol
11825          =4,5:ymin=death-tol:ymax=death+tol
11829       END SELect
11833       IF ymax<100:ymax=this_year
11837       year=INT(rec_date(ii)/1000)
11841       IF year<ymin OR year>ymax:RETurn 0
11845       rel=rec_relate%(ii)
11849       IF 3+INT(rel/100)*100=rel
11853          par=rec_pos(rec_link%(ii))
11857          IF rec_gtable%(par)=gtable%(fa%(jj)):RETurn 1
11861          IF rec_gtable%(par)=gtable%(ma%(jj)):RETurn 1
11865          RETurn 0
11869       END IF
11873       RETurn 1
11877    END IF
11881 END IF
11885 RETurn 0
11889 END DEFine
11893 :
11897 DEFine PROCedure show_match
11901 LOCal k,i,ks,rept,sml,iii,skip
11905 LOCal orig_val
11909 check_files
11913 IF NOT exists%(14):er 'No records to match','':RETurn
11917 IF (num_recs-num_del)=0:er "No research records loaded",'':RETurn
11921 IF NOT num_names:RETurn
11925 current_view=1
11929 OPEN_IN #ide_chan,recs_dev$&'IDE'
11933 rept=1:skip=0
11937 REPeat sml
11941    IF rept
11945       IF EOF(#ide_chan):EXIT sml
11949       INPUT #ide_chan,record$
11953    END IF
11957    rept=1
11961    iii=record$(1 TO ',' INSTR record$-1):jj=record$(',' INSTR record$+1 TO)
11965    IF iii=skip:NEXT sml
11969    skip=0
11973    IF rec_ref%(iii)<=0 OR rec_ref%(iii)=jj
11977       orig_val=rec_ref%(iii)
11981       set_anchor 0,30,data_chan
11985       print_family jj
11989       ks=show_page(0,440,iii,'',0)
11993       REPeat in_sml
11997          m6 "Is this the same person?"
12001          i=show_family(match_menu$)
12005          SELect ON i
12009          =-1:EXIT in_sml
12013          =-2:rec_ref%(iii)=jj:rec_edits=1:EXIT in_sml
12017          =-3:rec_ref%(iii)=-jj:rec_edits=1:EXIT in_sml
12021          =-4:recnum=rec_id%(iii):print_recs(2)
12025          =-5:find_name(0)
12029          =-6:shut ft1_chan:qwindow stat_chan:shut data_chan:EXIT sml
12033          =1 TO max_child-1:print_family screens%(1,i+1,0)
12037          END SELect
12041       END REPeat in_sml
12045       rec_edits=1
12049       set_anchor outlnx/2-(18*i),40,menu_chan
12053       k=get_opt(0,4,ident_menu$,1,menu_chan,'',0,1)
12057       shut ft1_chan:qwindow stat_chan:shut data_chan
12061       SELect ON k
12065          =1:rept=0:rec_ref%(iii)=orig_val
12069          =2:skip=iii
12073          =3:save_recs
12077          =4:EXIT sml
12081       END SELect
12085    END IF
12089 END REPeat sml
12093 CLOSE #ide_chan
12097 DELETE recs_dev$&'IDE':id_count=0
12101 current_view=0
12105 person=screens%(0,subject,0)
12109 END DEFine
12113 :
12117 DEFine PROCedure make_notes
12121 LOCal i,j,nids,ic,record$,old_recs
12125 IF rec_edits:x=warn('Edits to segment have not been saved','UNSAVED EDITS',''):RETurn
12129 make_table:old_recs=max_recs:max_recs=0
12133 FOR i=1 TO 12,20
12137    IF exists%(i)
12141       OPEN_IN #io_chan,recs_dev$&file_type$(i)
12145       IF EOF(#io_chan):CLOSE #io_chan:NEXT i:EXIT i
12149       INPUT #io_chan,record$:INPUT #io_chan,record$
12153       ic=',' INSTR record$
12157       j=',' INSTR record$(ic+1 TO)+ic:nids=record$(j+1 TO)
12161       max_recs=max_recs+nids
12165    END IF
12169 END FOR i
12173 CLOSE #io_chan
12177 IF max_recs=0:max_recs=old_recs
12181 init_recs
12185 FOR i=1 TO 12,20:load_records i,2
12189 IF num_recs AND NOT exit_flag
12193    rec_edits=1
12197    file_type=22:recs_file$=recs_dev$&file_type$(file_type)
12201    save_recs
12205 END IF
12209 check_files
12213 file_type=0:recs_file$='':REMark must be reloaded to be in chron order
12217 END DEFine
12221 :
12225 DEFine PROCedure load_spell
12229 LOCal j,i
12233 IF NOT exists%(0):spell=0:DIM spelling%(0):RETurn
12237 m6 "Loading Segment:ASF"
12241 OPEN_IN #io_chan,recs_dev$&'ASF'
12245 IF EOF(#io_chan):CLOSE #io_chan:RETurn
12249 INPUT #io_chan,maxpage
12253 DIM spelling%(10*(5+maxpage))
12257 FOR i=0 TO (maxpage-1)*10 STEP 10
12261    FOR j=1 TO 11
12265       IF EOF(#io_chan):EXIT j
12269       IF j>11:EXIT j
12273       INPUT #io_chan,record$
12277       IF record$='*':EXIT j
12281       spelling%(i+j)=add_table%(surname_table$,sur_id%,record$,15)
12285       IF spelling%(i+j)=0:EXIT i
12289    END FOR j
12293 END FOR i
12297 CLOSE #io_chan
12301 spell=maxpage*10
12305 qwindow stat_chan
12309 END DEFine
12313 :
12317 DEFine PROCedure asf
12321 LOCal page,oldspell,i,j,field,spelling$
12325 LOCal page_asf,asf_loop
12329 page=1
12333 IF NOT exists%(0):maxpage=5:DIM spelling%(50)
12337 m6 "<TAB>:next FIELD      <SHIFT>¾¿:next PAGE       (ESC):Save and Exit"
12341 REPeat page_asf
12345    oldspell=(page-1)*10:field=1
12349    point_window -1,-1,data_chan,len_sur*6+4,112
12353    AT #data_chan,0,0:PRINT #data_chan,"Page "&page
12357    FOR i=1 TO 10:PRINT #data_chan,family$(spelling%,oldspell+i)
12361    REPeat asf_loop
12365       spell=oldspell+field
12369       spelling$=family$(spelling%,spell)
12373       get_field len_sur,data_chan,field,0,2,spelling$
12377       IF spelling$=' ':spelling$=''
12381       IF spelling$<>''
12385          spelling%(spell)=add_table%(surname_table$,sur_id%,spelling$,15)
12389          IF spelling%(spell)=0:EXIT page_asf
12393       END IF
12397       IF exit_flag:EXIT page_asf
12401       IF next_page:EXIT asf_loop
12405       field=upfield(field,1,10)
12409    END REPeat asf_loop
12413    page=page+next_page
12417    IF page<1:page=maxpage
12421    IF page>maxpage:page=1
12425    CLS #data_chan
12429 END REPeat page_asf
12433 FOR i=maxpage*10 TO 1 STEP -1
12437    IF spelling%(i)<>0:maxpage=INT(i/10)+1:EXIT i
12441 END FOR i
12445 qwindow data_chan
12449 DELETE recs_dev$&'ASF'
12453 OPEN_NEW #io_chan,recs_dev$&'ASF'
12457 PRINT #io_chan,maxpage
12461 FOR i=0 TO (maxpage-1)*10 STEP 10
12465    FOR j=1 TO 10
12469       IF spelling%(i+j)=0:EXIT j
12473       PRINT #io_chan,family$(spelling%,i+j)
12477    END FOR j
12481    PRINT #io_chan,'*'
12485 END FOR i
12489 CLOSE #io_chan:spell=maxpage*10
12493 qwindow stat_chan
12497 exists%(0)=1
12501 END DEFine
12505 :
12509 DEFine FuNction get_recnum
12513 LOCal gr
12517 IF num_recs>=max_recs
12521    er "No more space to add records","SAVE and RELOAD to increase space available"
12525    RETurn 0
12529 END IF
12533 recnum=Nxtrec
12537 Nxtrec=Nxtrec+1
12541 num_recs=num_recs+1
12545 RETurn recnum
12549 END DEFine
12553 :
12557 DEFine FuNction add_table%(table_name$,id%,name$,sort_flag)
12561 LOCal i
12565 set_table(sort_flag)
12569 IF pick_field
12573    name$=PICK_table$(table_name$,table_len,table_pos,name$)
12577    IF chan_stat%(pick_field,2)=2:PRINT #pick_field,name$
12581 END IF
12585 IF name$='' OR name$=' ':RETurn 0
12589 IF LEN(name$)>table_len:name$=name$(1 TO table_len)
12593 i=search_array%(table_name$,0,name$)
12597 IF i>-1:RETurn id%(i)
12601 i=search_array%(table_name$,0,'*UNUSED*')
12605 IF i>0
12609    table_name$(i)=name$
12613    order_flag%(sort_flag-15)=0
12617    IF num_county AND sort_flag=17 AND name$<>'*MISSING*'
12621       x$=PICK_table$(county$,3,num_county,'')
12625       IF pick_num>0:county_table%(i)=pick_num
12629    END IF
12633    RETurn id%(i)
12637 END IF
12641 table_pos=table_pos+1
12645 IF table_pos>table_max THEN
12649    er " Table is full","SAVE and RELOAD to increase"
12653    table_edits=1:table_pos=table_max:RETurn 0
12657 END IF
12661 SELect ON sort_flag
12665    =15:surpos=table_pos
12669    =16:chrispos=table_pos
12673    =17:placepos=table_pos
12677        IF num_county AND name$<>'*MISSING*'
12681           x$=PICK_table$(county$,3,num_county,'')
12685           IF pick_num>0:county_table%(table_pos)=pick_num
12689        END IF
12693    =18:commentpos=table_pos
12697    =19:sourcepos=table_pos
12701 END SELect
12705 table_name$(table_pos)=name$
12709 id%(table_pos)=table_pos
12713 order_flag%(sort_flag-15)=0
12717 RETurn table_pos
12721 END DEFine
12725 :
12729 DEFine FuNction lookup_table$(table_name$,sort_flag,id%,table%,num)
12733 LOCal pos
12737 set_table(sort_flag)
12741 IF num<1:RETurn ''
12745 pos=search_array%(id%,0,table%(num))
12749 IF pos<1:RETurn ''
12753 IF pos>table_pos:RETurn ''
12757 RETurn table_name$(pos)
12761 END DEFine
12765 :
12769 DEFine PROCedure recsdev(d$)
12773 REMark We should check if QMenu is present and use this if possible
12777 REMark to select files ending in _net
12781 :
12785 IF tree$=''
12789   noQmenu=THING('Menus'):REMark Test for Qmenu
12793   IF noQmenu=0
12797     device$=FILE_SELECT$("Database Name",,d$,"_net",,,1,1)
12801     IF device$='':exit_flag=1
12805   ELSE
12809     set_anchor outlnx/2-162,130,stick_chan
12813     device$=stick_up$(2,'Database name:',d$,40,0)
12817   END IF
12821   IF exit_flag:RETurn
12825   IF "_net" INSTR device$:device$=device$(1 TO '_net' INSTR device$)
12829 ELSE
12833   device$=tree$(1 TO '_net' INSTR tree$)
12837 END IF
12841 tree$=''
12845 IF device$(LEN(device$))<>"_":device$=device$&"_"
12849 recs_dev$=device$
12853 get_device(recs_dev$)
12857 tree_file$=dir$&'tree'
12861 list_file$=dir$&'list'
12865 END DEFine
12869 :
12873 DEFine PROCedure m6(text$)
12877 LOCal length
12881 set_anchor 0,0,menu_chan
12885 length=LEN(text$)
12889 IF length<>stat_length:shut stat_chan
12893 IF length>82:length=82
12897 stat_length=length
12901 point_window -1,outlny-16,stat_chan,length*6+4,12
12905 set_colours stat_chan,1
12909 PRINT #stat_chan,text$(1 TO length)
12913 END DEFine
12917 :
12921 DEFine FuNction warn(text1$,text2$,text3$)
12925 LOCal wk
12929 wk=LEN(text3$):IF wk<6:wk=6
12933 DIM options$(1,wk)
12937 qwindow err_chan
12941 point_window -1,-1,err_chan,328,32
12945 AT #err_chan,0,20:PRINT #err_chan,">>WARNING<<"
12949 AT #err_chan,1,(50-LEN(text1$))/2:PRINT #err_chan,text1$
12953 AT #err_chan,2,(50-LEN(text2$))/2:PRINT #err_chan,text2$
12957 options$(1)='Cancel':options$(0)=text3$
12961 no_opts=1:IF text3$='':no_opts=0:options$(0)='OK'
12965 wk=get_opt(0,no_opts,options$,no_opts+1,menu_chan,'',0,1)
12969 qwindow err_chan:RETurn wk
12973 END DEFine
12977 :
12981 DEFine PROCedure er(text1$,text2$)
12985 qwindow err_chan
12989 point_window -1,-1,err_chan,328,32
12993 AT #err_chan,0,20:PRINT #err_chan,">>>ERROR<<<"
12997 AT #err_chan,1,(50-LEN(text1$))/2:PRINT #err_chan,text1$
13001 AT #err_chan,2,(50-LEN(text2$))/2:PRINT #err_chan,text2$
13005 BEEP 1500,100:resume:qwindow err_chan:RETurn
13009 END DEFine
13013 :
13017 DEFine PROCedure resume
13021 LOCal k
13025 k=get_opt(0,0,ok_menu$,1,menu_chan,'',0,1)
13029 END DEFine
13033 :
13037 DEFine FuNction next_person
13041 RETurn get_opt(0,1,another$,2,menu_chan,'',0,1)
13045 END DEFine
13049 :
13053 DEFine PROCedure new_details
13057 m6 "Change field:<TAB> or <SHIFT TAB>        Pick:<F3>         Exit:<ESC>"
13061 exit_flag=0
13065 END DEFine
13069 :
13073 DEFine PROCedure rec_stats
13077 LOCal i,j,k,l,m,ic,icc,pc%,toticc,totj
13081 make_table
13085 totj=0:toticc=0
13089 point_window -1,-1,data_chan,450,172
13093 PRINT #data_chan,"Segment      Records     Linked      Percent     From         To":PRINT #data_chan
13097 FOR i=1 TO 12,20
13101    IF exists%(i)
13105       OPEN_IN #io_chan,recs_dev$&file_type$(i)
13109       IF EOF(#io_chan):CLOSE #io_chan:NEXT i:EXIT i
13113       INPUT #io_chan,record$
13117       IF record$='"limits"'
13121          INPUT #io_chan,record$
13125          ic=',' INSTR record$:icc=record$(1 TO ic-1)
13129          j=',' INSTR record$(ic+1 TO)+ic:j=record$(j+1 TO)
13133          pc%=0:k=1E7:l=0
13137          FOR m=0 TO len_table
13141             IF limit_table(m,3)=i
13145                IF k>limit_table(m,1) AND limit_table(m,1)<>0:k=limit_table(m,1)
13149                IF l<limit_table(m,2) AND limit_table(m,2)<>1E7:l=limit_table(m,2)
13153             END IF
13157          END FOR m
13161          IF k>(this_year+1)*1000 OR k<1E6:k=0
13165          IF l>(this_year+1)*1000 OR l<1E6:l=0
13169          IF icc:pc%=j*100/icc
13173          PRINT #data_chan,file_type$(i);TO 13;icc;TO 25;j;TO 37;pc%;"%";TO 49;condat$(0,k);" ";condat$(0,l)
13177          toticc=toticc+icc:totj=totj+j
13181       END IF
13185       CLOSE #io_chan
13189    END IF
13193 END FOR i
13197 pc%=0
13201 IF toticc:pc%=totj*100/toticc
13205 PRINT #data_chan:PRINT #data_chan,"Total";TO 13;toticc;TO 25;totj;TO 37;pc%;"%"
13209 FOR i=1 TO 4:BLOCK #data_chan,1,170,72*i,0,colours%(data_chan,2)
13213 BLOCK #data_chan,1,170,369,0,colours%(data_chan,2)
13217 resume:qwindow data_chan
13221 END DEFine
13225 :
13229 DEFine PROCedure order_cols
13233 LOCal i,j,field,col_ord,num_col
13237 FOR i=DIMN(rank%) TO 0 STEP -1:IF rank%(i):EXIT i
13241 point_window -1,-1,pr_chan,DIMN(col_names$,2)*6+22,(i+1)*10+2
13245 set_colours pr_chan,1
13249 FOR j=1 TO i:PRINT #pr_chan,j!col_names$(rank%(j)-1)
13253 PRINT #pr_chan,'>'
13257 num_col=1:exit_flag=0
13261 REPeat col_ord
13265    m6 'Select column number '&num_col
13269    set_anchor 100,52,menu_chan
13273    field=get_opt(0,DIMN(col_names$),col_names$,1,menu_chan,stick2_menu$,1,1)+1
13277    IF num_col=1 AND field>0:DIM rank%(12):CLS #pr_chan
13281    SELect ON field
13285       =0:EXIT col_ord
13289       =-1:exit_flag=1:EXIT col_ord
13293       =1 TO 12:rank%(num_col)=field
13297                num_col=num_col+1
13301                IF num_col>DIMN(rank%):EXIT col_ord
13305                qwindow pr_chan
13309                point_window -1,-1,pr_chan,DIMN(col_names$,2)*6+22,num_col*10+2
13313                FOR i=1 TO num_col-1:PRINT #pr_chan,i!col_names$(rank%(i)-1)
13317                PRINT #pr_chan,'>'
13321     END SELect
13325 END REPeat col_ord
13329 qwindow stat_chan
13333 qwindow pr_chan
13337 END DEFine
13341 :
13345 DEFine PROCedure get_name_length(i,form)
13349 LOCal k
13353 SELect ON form
13357    =0:k=LEN(full_name$(i))
13361    =1:k=LEN(given$(gtable%,i))+len_sur+14
13365 END SELect
13369 IF k>name_length:name_length=k
13373 END DEFine
13377 :
13381 DEFine FuNction report_setup(sorted)
13385 pcwx=anchor%(0):pcwy=anchor%(1)
13389 IF pcw(sorted):RETurn 1
13393 pcwx=-1:pcwy=-1
13397 DIM selected(num_names)
13401 name_length=0
13405 longest=0
13409 RETurn 0
13413 END DEFine
13417 :
13421 DEFine FuNction get_note_type
13425 LOCal i
13429 DIM options$(6,8)
13433 DATA "bIrth","bAptism","Marriage","Death","bUrial","Other","Quit"
13437 RESTORE 13433
13441 FOR i=0 TO 6:READ options$(i)
13445 note_type=get_opt(0,6,options$,7,menu_chan,'',0,1)+1
13449 IF note_type=6:RETurn 0
13453 IF note_type=7:RETurn -1
13457 RETurn note_type
13461 END DEFine
13465 :
13469 DEFine FuNction get_segment
13473 LOCal num
13477 set_anchor 180,57,table_chan
13481 num=get_opt(0,12,segments$,1,table_chan,pick_menu$,1,1)+1
13485 IF num=13:num=20
13489 RETurn num
13493 END DEFine get_segment
13497 :
13501 DEFine PROCedure id_menu(p)
13505 LOCal k
13509 IF file_type>12:er 'Segment '&file_type$(file_type)&' cannot be linked to network','':RETurn
13513 check_files
13517 IF exists%(14)
13521    k=get_opt(0,2,ide_menu$,3,menu_chan,'',0,1)
13525 ELSE
13529    k=0
13533 END IF
13537 SELect ON k
13541    =2:RETurn
13545    =0:identify(p):show_match
13549    =1:show_match
13553 END SELect
13557 END DEFine
13561 :
13565 DEFine PROCedure res_length
13569 LOCal i,j
13573 m_sur=1:m_chris=1:m_place=1:m_source=1:m_com=1
13577 IF NOT num_recs:RETurn
13581 pwait
13585 FOR i=1 TO num_recs
13589    j=LEN(family$(rec_ftable%,i))
13593    IF m_sur<j:m_sur=j
13597    j=LEN(given$(rec_gtable%,i))
13601    IF m_chris<j:m_chris=j
13605    j=LEN(place$(rec_ptable%,i))
13609    IF m_place<j:m_place=j
13613    j=LEN(source$(rec_stable%,i))
13617    IF m_source<j:m_source=j
13621    j=LEN(comment$(rec_ctable%,i))
13625    IF m_com<j:m_com=j
13629 END FOR i
13633 m_sur=m_sur+1:m_chris=m_chris+1:m_place=m_place+1:m_source=m_source+1:m_com=m_com+1
13637 m_total=m_sur+m_chris+m_place+m_source+m_com
13641 qwindow err_chan
13645 END DEFine
13649 :
13653 DEFine FuNction markers$(p,q)
13657 LOCal ii,jj,count
13661 mark$=''
13665 IF NOT q
13669    jj=mark%(p)
13673    IF jj AND NOT nomarks
13677       FOR ii=0 TO 14:IF 2^ii&&jj:mark$=mark$&char$(ii+1)
13681    END IF
13685 END IF
13689 jj=user_mark%(p)
13693 IF jj AND NOT nomarks
13697    FOR ii=0 TO 14:IF 2^ii&&jj:mark$=mark$&user_char$(ii+1)
13701 END IF
13705 IF NOT norefs:mark$=p&mark$
13709 RETurn mark$
13713 END DEFine
13717 :
13721 DEFine PROCedure add_marker(a$)
13725 LOCal i,num
13729 num=(a$ INSTR char$)-1
13733 FOR i=1 TO num_names
13737    IF selected(i) AND NOT qmark%(i,a$):mark%(i)=mark%(i)+2^num
13741 END FOR i
13745 END DEFine
13749 :
13753 DEFine PROCedure put_marker(opt)
13757 LOCal j,num,charr$(14,17)
13761 FOR j=0 TO 14:charr$(j)=user_char$(j+1)&' '&char_text$(j)
13765 num=get_opt(0,14,charr$,1,menu_chan,'',0,1)
13769 SELect ON opt
13773    =0:j=2^num
13777       IF qmark%(person,user_char$(num+1)):j=-j
13781       user_mark%(person)=user_mark%(person)+j
13785    =1:char_text$(num)=stick_up$(0,"Text:",char_text$(num),15,0)
13789       show_markers
13793    =2:a$=user_char$(num+1)
13797 END SELect
13801 END DEFine
13805 :
13809 DEFine PROCedure clear_markers
13813 LOCal i,j,k
13817 a$=input_mark$
13821 IF a$='':RETurn
13825 k=show_menu(0,'Quit','Single','Zap all','','','','','','')
13829 IF k=10:RETurn
13833 IF k=30:IF warn("You are about to REMOVE all '"&a$&"' markers","","Remove"):RETurn
13837 IF LEN(a$)=1
13841   i=(a$ INSTR char$)-1
13845   IF i>=0
13849     IF k=30
13853       FOR j=1 TO num_names
13857         IF qmark%(j,a$)=1:mark%(j)=mark%(j)-2^i
13861       END FOR j
13865     ELSE
13869       IF qmark%(person,a$)=1:mark%(person)=mark%(person)-2^i
13873     END IF
13877   ELSE
13881     i=(a$ INSTR user_char$)-1
13885     IF i>=0
13889       IF k=30
13893         FOR j=1 TO num_names
13897           IF qmark%(j,a$)=2:user_mark%(j)=user_mark%(j)-2^i
13901         END FOR j
13905       ELSE
13909         IF qmark%(person,a$)=2:user_mark%(person)=user_mark%(person)-2^i
13913       END IF
13917     END IF
13921   END IF
13925 ELSE
13929   DIM selected2(num_names):j=set_markers(selected2)
13933   FOR j=1 TO num_names
13937     IF k=30 OR j=person
13941       IF selected2(j)=1 OR selected2(j)=3:mark%(j)=mark%(j)-marker_list%
13945       IF selected2(j)=2 OR selected2(j)=3:user_mark%(j)=user_mark%(j)-user_marker_list%
13949     END IF
13953   END FOR j
13957 END IF
13961 END DEFine
13965 :
13969 DEFine PROCedure marker_menu
13973 LOCal k,kk,num
13977 k=show_menu(0,"Quit","Mark","Clear","Key","Describe","Sex","Ignore ½","")
13981 SELect ON k
13985   =10:RETurn
13989   =20:put_marker(0)
13993   =30:clear_markers
13997   =40:show_markers:RETurn
14001   =50:put_marker(1)
14005   =60:add_gender(1)
14009   =70:kk=show_menu(1,'Quit','Reports','Verification','','','','','')
14013       SELect ON kk
14017         =10:RETurn
14021         =20:num=7
14025         =30:num=12
14029       END SELect
14033       IF 2^num&&mark%(person):num=-2^num:ELSE num=2^num
14037       mark%(person)=mark%(person)+num
14041 END SELect
14045 num_edits=1
14049 END DEFine
14053 :
14057 DEFine PROCedure show_markers
14061 LOCal i
14065 point_window -1,-1,data_chan,250,154
14069 FOR i=0 TO 14:PRINT #data_chan,TO 2;user_char$(i+1);TO 6;char_text$(i)
14073 resume
14077 qwindow data_chan
14081 END DEFine
14085 :
14089 DEFine PROCedure get_markers
14093 LOCal i
14097 IF NOT exists%(23):RETurn
14101 IF NOT num_names:RETurn
14105 m6 "Loading Segment:MAR"
14109 mark_file$=recs_dev$&"MAR"
14113 OPEN_IN #io_chan,mark_file$
14117 FOR i=0 TO 14:IF NOT EOF(#io_chan):INPUT #io_chan,char_text$(i)
14121 CLOSE #io_chan
14125 qwindow stat_chan
14129 END DEFine
14133 :
14137 DEFine PROCedure save_markers
14141 LOCal i
14145 mark_file$=recs_dev$&'MAR'
14149 DELETE mark_file$
14153 OPEN_NEW #io_chan,mark_file$
14157 FOR i=0 TO 14:PRINT #io_chan,char_text$(i)
14161 CLOSE #io_chan
14165 END DEFine
14169 :
14173 DEFine FuNction loadin_segment
14177 LOCal num
14181 make_table
14185 num=get_segment:IF NOT num:RETurn 0
14189 load_records num,0
14193 IF exit_flag:RETurn 0
14197 RETurn 1
14201 END DEFine
14205 :
14209 DEFine PROCedure edit_table(table_name$,sort_flag)
14213 LOCal main_et,a$,k,i,b$
14217 set_table sort_flag
14221 IF NOT table_pos:shut menu_chan:er 'No entries in this table','':exit_flag=1:RETurn
14225 exit_flag=0:a$=''
14229 REPeat main_et
14233   set_anchor 30,30,menu_chan
14237   IF sort_flag=17:k=show_menu(1,'Quit','Print','change Name','change County','change Grid ref','','',''):ELSE k=show_menu(0,'Quit','Print','Change','','','','','')
14241   IF k=10:EXIT main_et
14245   IF k=20:list_tables table_name$,sort_flag:NEXT main_et
14249   a$=PICK_table$(table_name$,table_len,table_pos,'')
14253   IF pick_num<1:NEXT main_et
14257   a$=table_name$(pick_num)
14261   IF '(System Name)' INSTR a$:er 'You cannot moodify this','':NEXT main_et
14265   SELect ON k
14269   =30:table_name$(pick_num)=stick_up$(0,'Modify name:',a$,table_len,0)
14273     order_flag%(sort_flag-15)=0
14277   =40:i=pick_num:b$=PICK_table$(county$,3,num_county,'')
14281     IF pick_num>0:county_table%(i)=pick_num
14285   =50:i=update_grid(pick_num)
14289   END SELect
14293   table_edits=1
14297 END REPeat main_et
14301 END DEFine
14305 :
14309 DEFine FuNction get_tree
14313 LOCal a$,i,j,k,l,record$,gtree
14317 IF get_file("Loading: Tree file>",tree_file$,1):RETurn 1
14321 OPEN_IN #io_chan,tree_file$
14325 IF EOF(#io_chan):CLOSE #io_chan:RETurn 0
14329 INPUT #io_chan,current_tree
14333 INPUT #io_chan,record$
14337 IF record$<>recs_dev$:IF warn('Tree file was created from a different database','','Load tree'):CLOSE #io_chan:RETurn 1
14341 INPUT #io_chan,slot
14345 blanks$=FILL$(' ',slot)
14349 INPUT #io_chan,min_size
14353 INPUT #io_chan,max_size
14357 INPUT #io_chan,max_level
14361 INPUT #io_chan,tree_count
14365 tree_max=tree_count+room
14369 IF tree_count:DIM tree_edit$(tree_max,slot):FOR i=0 TO tree_count:INPUT #io_chan,tree_edit$(i)
14373 DIM grid%(max_level,max_size,1)
14377 REPeat gtree
14381   IF EOF(#io_chan):EXIT gtree
14385   INPUT #io_chan,l:INPUT #io_chan,k:INPUT #io_chan,j:INPUT #io_chan,i
14389   grid%(k,j,i)=l
14393 END REPeat gtree
14397 CLOSE #io_chan
14401 RETurn 0
14405 END DEFine
14409 :
14413 DEFine PROCedure save_tree
14417 LOCal i,j,k,l
14421 IF get_file("Saving: Tree file>",tree_file$,0):RETurn
14425 DELETE tree_file$
14429 OPEN_NEW #io_chan,tree_file$
14433 PRINT #io_chan,current_tree
14437 PRINT #io_chan,recs_dev$
14441 PRINT #io_chan,slot
14445 PRINT #io_chan,min_size
14449 PRINT #io_chan,max_size
14453 PRINT #io_chan,max_level
14457 PRINT #io_chan,tree_count
14461 IF tree_count:FOR i=0 TO tree_count:PRINT #io_chan,tree_edit$(i)
14465 FOR i=0,1
14469   FOR j=min_size TO max_size
14473     FOR k=0 TO max_level
14477       l=grid%(k,j,i)
14481       IF l:PRINT #io_chan,l:PRINT #io_chan,k:PRINT #io_chan,j:PRINT #io_chan,i
14485     END FOR k
14489   END FOR j
14493 END FOR i
14497 CLOSE #io_chan
14501 END DEFine
14505 :
14509 DEFine PROCedure edit_tree(u,v)
14513 IF u>max_level OR u<0 OR v>max_size OR v<min_size:er 'Cannot add text in this position','': RETurn
14517 IF NOT tree_count:DIM tree_edit$(tree_max,slot)
14521 IF tree_count=tree_max
14525    er 'Cannot add another tree annotation, use RELOAD to increase space',''
14529 ELSE
14533    m6 'Enter text to annotate tree'
14537    tree_count=tree_count+1
14541    tree_edit$(tree_count)=stick_up$(0,'',slot$(u,v,1),slot,0)
14545    grid%(u,v,1)=15
14549    grid%(u,v,0)=tree_count
14553    qwindow stat_chan
14557 END IF
14561 END DEFine edit_tree
14565 :
14569 DEFine PROCedure operate_markers(om)
14573 LOCal a$,p,kk
14577 current_view=1
14581 a$=input_mark$:IF a$='':RETurn
14585 DIM selected2(num_names):p=set_markers(selected2)
14589 kk=0
14593 FOR p=1 TO num_names
14597    IF selected2(p)
14601       print_family p
14605       IF kk<>-3:kk=show_family(ft_mark$)
14609       IF kk=-4:EXIT p
14613       IF kk=-1 OR kk=-3
14617          SELect ON om
14621             =20:hard_copy
14625             =60:remove_person p,0
14629          END SELect
14633       END IF
14637    END IF
14641 END FOR p
14645 shut ft1_chan
14649 current_view=0
14653 END DEFine operate_markers
14657 :
14661 DEFine PROCedure remove_person(alter,systemperson)
14665 LOCal i%,j,sp1,sp2,tmp$(40)
14669 sp1=fa%(alter):sp2=ma%(alter)
14673 zero_names(alter)
14677 mark alter,7
14681 pick_field=0
14685 ftable%(alter)=add_table%(surname_table$,sur_id%,"*DELETED*",15)
14689 gtable%(alter)=add_table%(chris_table$,chris_id%,"",16)
14693 FOR i%=1 TO num_names
14697   IF '(System Name)' INSTR full_name$(i%)
14701     IF fa%(i%)=alter:attach%(ma%(i%))=attach%(ma%(i%))-101:IF attach%(ma%(i%))<0:attach%(ma%(i%))=attach%(ma%(i%))+100
14705     IF ma%(i%)=alter:attach%(fa%(i%))=attach%(fa%(i%))-101:IF attach%(fa%(i%))<0:attach%(fa%(i%))=attach%(fa%(i%))+100
14709     IF ma%(i%)=alter OR fa%(i%)=alter:gtable%(i%)=add_table%(chris_table$,chris_id%,'',16):ftable%(i%)=add_table%(surname_table$,sur_id%,"*DELETED*",15):zero_names(i%)
14713   ELSE
14717     IF ABS(fa%(i%))=alter:fa%(i%)=0
14721     IF ABS(ma%(i%))=alter:ma%(i%)=0
14725   END IF
14729 END FOR i%
14733 IF systemperson:RETurn
14737 IF sp1>0:IF sp2>0:pch=add_system_child(sp1,sp2)
14741 IF sp1<>0:print_family ABS(sp1):RETurn
14745 IF sp2<>0:print_family ABS(sp2):RETurn
14749 j=search_array%(fa%,0,alter):IF j>0:print_family(j):RETurn
14753 j=search_array%(fa%,0,-alter):IF j>0:print_family(j):RETurn
14757 j=search_array%(ma%,0,alter):IF j>0:print_family(j):RETurn
14761 j=search_array%(ma%,0,-alter):IF j>0:print_family(j):RETurn
14765 FOR i%=num_names TO 1 STEP -1
14769   tmp$=full_name$(i%)
14773   IF "*DELETED*" INSTR tmp$:NEXT i%:EXIT i%
14777   IF "(System Name)" INSTR tmp$:NEXT i%:EXIT i%
14781   FOR j=1 TO LEN(tmp$)
14785     IF tmp$(j) INSTR '0123456789':NEXT i%:EXIT i%
14789     IF tmp$(j) INSTR 'abcdefghijklmnopqrstuvwxyz':EXIT i%
14793   END FOR j
14797 END FOR i%
14801 print_family i%
14805 END DEFine
14809 :
14813 DEFine PROCedure integrity
14817 LOCal i,j,k,l,l$,count,x$,yob,yod
14821 LOCal yobf,yodf,yobm,yodm,f,m,f$,m$
14825 IF NOT num_names:RETurn
14829 DIM selected(num_names):count=0
14833 dest$=get_dest$
14837 print_heads 'Integrity Check'
14841 report_title$=''
14845 FOR i=1 TO num_names
14849   IF qmark%(i,'V')=1:mark%(i)=mark%(i)-2^11
14853   IF '*DELETED*' INSTR full_name$(i):NEXT i:EXIT i
14857   IF '(System Name)' INSTR full_name$(i):NEXT i:EXIT i
14861   l$='#'&i
14865   IF sex%(i)=0:count=count+1:IF fprinter(l$&' '&full_name$(i)&' is of unknown sex'):EXIT i
14869   IF NOT qmark%(i,'/') AND NOT qmark%(i,'Z')
14873     FOR j=1,2
14877       SELect ON j
14881       =1:l=fa%(i)
14885         IF l>0:IF sex%(l)=2:mark l,11:count=count+1:IF fprinter('#'&l&' '&full_name$(l)&' is Female but listed as the Father of '&l$&' '&full_name$(i)&'!'):EXIT i
14889         IF l<0:IF sex%(-l)=sex%(i):mark ABS(l),11:mark i,11:count=count+1:IF fprinter('#'&(-l)&' '&full_name$(-l)&' is the same sex as their Spouse ('&l$&' '&full_name$(i)&')!'):EXIT i
14893         l=ABS(l)
14897       =2:l=ma%(i)
14901         IF l>0:IF sex%(l)=1:mark l,11:count=count+1:IF fprinter('#'&l&' '&full_name$(l)&' is Male but listed as the Mother of '&l$&' '&full_name$(i)&'!'):EXIT i
14905         IF l<0:IF sex%(-l)=sex%(i):mark ABS(l),11:mark i,11:count=count+1:IF fprinter('#'&i&' '&full_name$(-l)&' is the same sex as their Spouse ('&l$&' '&full_name$(i)&')!'):EXIT i
14909         l=ABS(l)
14913       END SELect
14917       IF l
14921         IF selected(l)
14925           IF selected(l)<>j
14929             l$='#'&l:mark l,11
14933             IF fprinter(l$&' '&full_name$(l)&' is both Mother and Father'):EXIT i
14937             count=count+1
14941           END IF
14945         ELSE
14949           selected(l)=j
14953         END IF
14957       END IF
14961     END FOR j
14965   END IF
14969   yob=yofb(i):l$='#'&i
14973   m=ma%(i):f=fa%(i)
14977   IF yob>99
14981     m$='0':yobm=0:yodm=0
14985     f$='0':yobf=0:yodf=0
14989     IF m>0:m$='#'&m:yobm=yofb(m):yodm=yofd%(m)
14993     IF f>0:f$='#'&f:yobf=yofb(f):yodf=yofd%(f)
14997     yod=yofd%(i)
15001     IF NOT qmark%(i,'/') AND NOT qmark%(i,'Z')
15005       IF yod>99:IF yod<yob:count=count+1:mark i,11:IF fprinter(l$&' has death date earlier than birth date'):EXIT i
15009       IF yod>99:IF yod-yob>100:count=count+1:mark i,11:IF fprinter(l$&' lived for over 100 years'):EXIT i
15013       IF f>0
15017         IF i<>f AND NOT qmark%(f,'/') AND NOT qmark%(f,'Z')
15021           IF yobf>99:IF (yob-yobf)>gen_gap OR (yob-yobf)<16:count=count+1:mark i,11:mark f,11:IF fprinter(l$&' and '&f$&' have an unlikely generation gap'):EXIT i
15025           IF yodf>99:IF yob>yodf+1:count=count+1:mark i,11:mark f,11:IF fprinter('Child '&l$&' born over 1 year after death of father '&f$):EXIT i
15029         END IF
15033       END IF
15037       IF m>0
15041         IF i<>m AND NOT qmark%(m,'/') AND NOT qmark%(m,'Z')
15045           IF yobm>99:IF (yob-yobm)>gen_gap OR (yob-yobm)<16:count=count+1:mark i,11:mark m,11:IF fprinter(l$&' and '&m$&' have an unlikely generation gap'):EXIT i
15049           IF yodm>99:IF yob>yodm+1:count=count+1:mark i,11:mark m,11:IF fprinter('Child '&l$&' born over 1 year after death of mother '&m$):EXIT i
15053         END IF
15057       END IF
15061     END IF
15065     IF yobm>99:IF yobf>99:IF ABS(yobm-yobf)>age_gap:IF NOT(qmark%(f,'V') AND qmark%(m,'V')):IF NOT qmark%(m,'/'):IF NOT qmark%(m,'Z'):IF NOT qmark%(f,'/'):IF NOT qmark%(f,'Z'):count=count+1:mark f,11:mark m,11:IF fprinter(m$&' and '&f$&' have an unlikely age difference'):EXIT i
15069   ELSE
15073     IF yob=0:IF m>0 OR f>0:count=count+1:mark i,11:IF fprinter(l$&' has no birth year or sequence number'):EXIT i
15077   END IF
15081   IF attach%(i) MOD 100=0 AND fa%(i)=0 AND ma%(i)=0 AND NOT qmark%(i,'/') AND NOT qmark%(i,'Z')
15085     count=count+1:l$='#'&i:mark i,11
15089     IF fprinter(l$&' has no connections to anyone else'):EXIT i
15093   END IF
15097 END FOR i
15101 IF NOT exit_flag
15105   printer ''
15109   x$=count:printer x$&' warnings found'
15113 END IF
15117 print_tails
15121 END DEFine
15125 :
15129 DEFine PROCedure births_deaths(jj,tol)
15133 birth=yofb(jj):death=yofd%(jj)
15137 IF birth<>INT(birth):birth=0
15141 IF birth>99:IF death>99:RETurn
15145 IF birth<100:IF death<100:death=this_year:birth=0:RETurn
15149 IF birth<100:birth=death-100:RETurn
15153 death=birth+100
15157 IF death>this_year:death=this_year
15161 END DEFine
15165 :
15169 DEFine FuNction get_date(chan,row,col,field)
15173 LOCal f,d$,i,j,m$,n$,cendat,m_loop
15177 f=1
15181 IF next_field<0:f=3
15185 REPeat cendat
15189   FOR i=3,7:AT #chan,row,col+i:PRINT #chan,'-'
15193   SELect ON f
15197     =1:get_field 3,chan,row,col,0,con_d$
15201        IF pick_field
15205          pick_field=0
15209          set_anchor -1,-1,menu_chan
15213          qual=get_opt(0,5,date_menu$,1,menu_chan,'',0,1)
15217          con_d$=extended_dates$(qual+1)&con_d$(2 TO 3)
15221          NEXT cendat
15225        END IF
15229        con_d$=con_d$&FILL$(' ',3):con_d$=con_d$(1 TO 3)
15233        j=1:FOR i=1 TO 3:IF con_d$(i)<>' ':j=i:EXIT i
15237        m$=con_d$(j TO)
15241        qual=(m$(1) INSTR extended_dates$)-1
15245        IF qual<0:qual=0
15249        i=1:n$='  '
15253        REPeat m_loop
15257          IF i>LEN(m$):EXIT m_loop
15261          IF m$(i) INSTR '0123456789'
15265            n$=m$(i)
15269            IF i=LEN(m$):n$=' '&n$:EXIT m_loop
15273            IF m$(i+1) INSTR '0123456789':n$=m$(i TO i+1):ELSE n$=' '&m$(i)
15277            EXIT m_loop
15281          END IF
15285          i=i+1
15289        END REPeat m_loop
15293        con_d$=extended_dates$(qual+1)&n$
15297        m$=con_d$(2 TO 3):con_d=0
15301        IF m$<>'  ':con_d=m$
15305        IF qual=4
15309          con_d=0:con_d$=extended_dates$(qual+1)
15313          i=0:IF n$<>'  ':i=n$
15317          m$=3*i:con_m$=month$(check_clock(m$))
15321        END IF
15325        AT #chan,row,col:PRINT #chan,con_d$
15329     =2:get_field 3,chan,row,col+4,4,con_m$
15333     =3:get_field 4,chan,row,col+8,10,con_y
15337   END SELect
15341   d$=con_y*1000+check_clock(con_m$)*50+con_d
15345   f=f+next_field
15349   IF (exit_flag OR next_page OR next_record OR f<1 OR f>3)
15353     IF NOT test_date:qual=5:AT #chan,row,col:PRINT #chan,extended_dates$(6)
15357     EXIT cendat
15361   END IF
15365 END REPeat cendat
15369 field=field+2*next_field
15373 FOR i=3,7:AT #chan,row,col+i:PRINT #chan,'-'
15377 RETurn d$
15381 END DEFine
15385 :
15389 DEFine FuNction upfield(f,min,max)
15393 f=f+next_field
15397 IF f<min:f=max
15401 IF f>max:f=min
15405 RETurn f
15409 END DEFine
15413 :
15417 DEFine FuNction full_name$(num)
15421 IF reverse_names
15425   RETurn family$(ftable%,num)&' '&given$(gtable%,num)&dates$(num)
15429 ELSE
15433   RETurn given$(gtable%,num)&' '&family$(ftable%,num)&dates$(num)
15437 END IF
15441 END DEFine
15445 :
15449 DEFine FuNction get_doc(recnum)
15453 LOCal i,j,gd_loop
15457 count=0:dmpos=0
15461 IF num_recs
15465   DIM selected(num_recs)
15469   i=search_array%(rec_id%,dmpos,recnum)
15473   IF i>0
15477     IF rec_link%(i):i=rec_pos(rec_link%(i)):recnum=rec_id%(i)
15481     dmpos=0:selected(i)=1:count=count+1
15485     REPeat gd_loop
15489       j=search_array%(rec_link%,dmpos,recnum)
15493       IF j<0:EXIT gd_loop
15497       selected(j)=1:count=count+1
15501       dmpos=j+1
15505     END REPeat gd_loop
15509   END IF
15513 END IF
15517 count=count-1
15521 IF count<0:er "Nothing found with specified record id",file_type$(file_type)&recnum
15525 sort_type=30:sort_recs
15529 RETurn count
15533 END DEFine
15537 :
15541 DEFine PROCedure surname_table
15545 LOCal len_s,blanks$,i,j,k,l,record$
15549 LOCal sntab
15553 dest$=get_dest$
15557 DIM selected(num_names)
15561 parents
15565 maxpow=numgens(maxpow)
15569 maxped=2^(maxpow+1)-2
15573 len_s=LEN(family$(ftable%,person))
15577 FOR i=1 TO num_names
15581   IF selected(i)
15585     IF LEN(family$(ftable%,i))>len_s:len_s=LEN(family$(ftable%,i))
15589   END IF
15593 END FOR i
15597 print_heads "Surnames"
15601 report_title$=''
15605 len_s=len_s+1:record$=''
15609 printer "Family Name Table for "&full_name$(person)
15613 k=2^maxpow
15617 FOR i=k-2 TO k/2 STEP -2
15621   IF fprinter(record$):EXIT i
15625   record$='':l=i
15629   REPeat sntab
15633     IF l/2<>INT(l/2):EXIT sntab
15637     blanks$=FILL$('-',len_s-1)&' '
15641     j=search_array%(selected,0,l)
15645     IF j>=0:blanks$=family$(ftable%,j)&FILL$(' ',len_s)
15649     record$=record$&blanks$(1 TO len_s)
15653     l=l/2
15657   END REPeat sntab
15661 END FOR i
15665 record$=record$&family$(ftable%,person)
15669 printer record$
15673 print_tails
15677 END DEFine
15681 :
15685 DEFine PROCedure print_out
15689 LOCal i,j
15693 IF count<0:RETurn
15697 report_title$=find_chris$&' '&find_sur$&' Year:'&find_year&' Markers:'&find_mark$&' Status:'&find_stat$(find_stat)
15701 print_heads 'Selected List'
15705 FOR i=1 TO num_names
15709   IF selected(i):get_name_length i,form
15713 END FOR i
15717 FOR j=0 TO count
15721   k=sort_table%(j)
15725   m$=k&markers$(k,0)
15729   IF find_year:IF yofb(k)>99:IF yofb(k)=INT(yofb(k)):age$=find_year-yofb(k):m$=m$&' Aged:'&age$
15733   IF fprinter(pad$(k,m$,form)):EXIT j
15737 END FOR j
15741 print_tails
15745 END DEFine
15749 :
15753 DEFine FuNction input_mark$
15757 LOCal i,j,flag,in_mark
15761 REPeat in_mark
15765   a$=stick_up$(1,'Markers:','',18,2)
15769   IF pick_field:put_marker(2)
15773   IF a$='':RETurn ''
15777   FOR j=1 TO LEN(a$)
15781     flag=0
15785     IF a$(j) INSTR char$:flag=1
15789     IF a$(j) INSTR user_char$:flag=1
15793     IF a$(j)=' ':IF j<>1:flag=1
15797     IF NOT flag:BEEP 1500,100:NEXT in_mark
15801   END FOR j
15805   EXIT in_mark
15809 END REPeat in_mark
15813 marker_list%=0:user_marker_list%=0
15817 FOR i=1 TO LEN(a$)
15821   IF a$(i)<>' '
15825     IF a$(i) INSTR char$:marker_list%=marker_list%+2^((a$(i) INSTR char$)-1)
15829     IF a$(i) INSTR user_char$:user_marker_list%=user_marker_list%+2^((a$(i) INSTR user_char$)-1)
15833   END IF
15837 END FOR i
15841 RETurn a$
15845 END DEFine
15849 :
15853 DEFine PROCedure get_device(f$)
15857 LOCal x
15861 x=LEN(f$)
15865 dir$=recs_dev$:file$=""
15869 SELect ON x
15873   =6 TO 40:IF "_" INSTR f$=5:dir$=f$(1 TO 5):file$=f$(6 TO)
15877            SELect ON x
15881              =9 TO 40:IF f$(3)="_":IF f$(8)="_":dir$=f$(1 TO 8):file$=f$(9 TO)
15885              =8:IF f$(3)="_":IF f$(8)="_":dir$=f$(1 TO 8)
15889            END SELect
15893   =5:IF '_' INSTR f$=5:dir$=f$(1 TO 5)
15897 END SELect
15901 END DEFine
15905 :
15909 DEFine PROCedure get_directory (pr_dev$)
15913 LOCal t$,xlen,fstart,dir_len,loop
15917 dir_len=LEN(dir$):fstart=LEN(dir$)
15921 REPeat loop
15925   DELETE recs_dev$&'tmp'
15929   OPEN_NEW #io_chan,recs_dev$&'tmp'
15933   DIR #io_chan,dir$
15937   CLOSE #io_chan
15941   OPEN_IN #io_chan,recs_dev$&'tmp'
15945   REPeat sub2
15949     sub_found=0
15953     IF EOF(#io_chan):EXIT sub2
15957     INPUT #io_chan,t$
15961     IF '->' INSTR t$
15965       xlen=LEN(t$)-3:IF xlen>0:IF t$(1 TO xlen)==pr_dev$(dir_len+1 TO dir_len+xlen):sub_found=1:fstart=dir_len+xlen+1:dir$=pr_dev$(1 TO fstart)
15969       IF sub_found:EXIT sub2
15973     END IF
15977   END REPeat sub2
15981   CLOSE #io_chan
15985   IF NOT sub_found:RETurn
15989 END REPeat loop
15993 END DEFine
15997 :
16001 DEFine PROCedure print_param2
16005 LOCal i,j,k,kk,x$,char_loop
16009 DIM char_code(9)
16013 k=show_menu(1,"Quit","A. preamble","B. postamble","C. condensed on","D. condensed off","E. expanded on","F. expanded off","G. MORE")
16017 SELect ON k
16021   =10:qwindow stat_chan:RETurn
16025   =20:x$=preamble$
16029   =30:x$=postamble$
16033   =40:x$=fount_type$(1,1)
16037   =50:x$=fount_type$(1,0)
16041   =60:x$=fount_type$(2,1)
16045   =70:x$=fount_type$(2,0)
16049   =80
16053      kk=show_menu(0,"Quit","A. end of line","B. top of form","C. line spacing","","","","","","")
16057      SELect ON kk
16061        =10:qwindow stat_chan:RETurn
16065        =20:x$=eol_char$:k=80
16069        =30:x$=tof$:k=90
16073        =40:IF LEN(line_space$)>2:IF line_space>0:line_space$(3)=CHR$(line_space)
16077            x$=line_space$:k=100
16081      END SELect
16085 END SELect
16089 j=LEN(x$)-1
16093 FOR i=0 TO j:char_code(i)=CODE(x$(i+1))
16097 field=0
16101 point_window -1,240,stat_chan,64*6+4,12
16105 PRINT #stat_chan,"Decimal character codes:"
16109 FOR i=0 TO 9:AT #stat_chan,0,25+4*i:PRINT #stat_chan,char_code(i)
16113 REPeat char_loop
16117   x$=char_code(field)
16121   get_field 3,stat_chan,0,25+field*4,1,x$
16125   IF x$<>10
16129     char_code(field)=x$
16133   ELSE
16137     BEEP 1500,100:NEXT char_loop
16141   END IF
16145   IF exit_flag:EXIT char_loop
16149   field=upfield(field,0,9)
16153 END REPeat char_loop
16157 qwindow stat_chan
16161 x$=''
16165 FOR i=0 TO 9:IF char_code(i)=0:EXIT i:ELSE x$=x$&CHR$(char_code(i))
16169 SELect ON k
16173   =20:preamble$=x$
16177   =30:postamble$=x$
16181   =40:fount_type$(1,1)=x$
16185   =50:fount_type$(1,0)=x$
16189   =60:fount_type$(2,1)=x$
16193   =70:fount_type$(2,0)=x$
16197   =80:eol_char$=x$
16201   =90:tof$=x$
16205   =100:line_space$=x$
16209       IF LEN(line_space$)>2:line_space=CODE(line_space$(3))
16213 END SELect
16217 END DEFine
16221 :
16225 DEFine PROCedure option_param
16229 LOCal k,kk,kkk,lr_col$
16233 k=show_menu(1,'Tree slot','Tolerances','Name Order','Units','Bar Symbol','Marriage Symbol','Startup person','Pick columns')
16237 SELect ON k
16241   =10:slot=stick_up$(0,'Slot (min 13, max 50):',slot,2,1)
16245       IF slot<13:slot=13
16249       IF slot>50:slot=50
16253       blanks$=FILL$(' ',slot)
16257   =20
16261       kkk=show_menu(0,'Quit','Search Years','Generation Gap','Age Difference','','','','')
16265       SELect ON kkk
16269         =10:RETurn
16273         =20:tol=stick_up$(0,'Search Year Tolerance:',tol,2,1)
16277         =30:gen_gap=stick_up$(0,'Generation Gap Tolerance:',gen_gap,3,1)
16281         =40:age_gap=stick_up$(0,'Age Difference Tolerance:',age_gap,3,1)
16285       END SELect
16289   =30:reverse_names$=stick_up$(0,'Family name first:',reverse_names$,3,0)
16293       IF reverse_names$=="yes":reverse_names=1:ELSE reverse_names=0
16297   =40:units$=stick_up$(0,'Geography units:',units$,5,0)
16301       IF units$=='km':units=1:ELSE units=1.609:units$='miles'
16305   =50:bar$=stick_up$(0,'Bar symbol:',bar$,1,0)
16309   =60:mar_char$=stick_up$(0,'Marriage symbol:',mar_char$,1,0)
16313   =70:start_person=stick_up$(0,'Startup person:',start_person,5,1)
16317   =80:IF lr_col=1:lr_col$='Single':ELSE lr_col$='Multi'
16321       lr_col$=stick_up$(0,'Single or Multi columns:',lr_col$,6,5)
16325       IF lr_col$=='Single':lr_col=1:ELSE lr_col=-1
16329 END SELect
16333 END DEFine
16337 :
16341 DEFine FuNction get_grid$(gr)
16345 LOCal ji,grid_num$,east,north,num
16349 IF gr>placenum:RETurn '      '
16353 num=grid_table(gr):grid_num$=num
16357 IF num=0:RETurn '      '
16361 grid_ref$='      '
16365 FOR ji=2,3:grid_ref$(ji+1)=grid_num$(ji)
16369 FOR ji=5,6:grid_ref$(ji)=grid_num$(ji)
16373 east=INT(num/100000):north=INT((num-(INT(num/1000)*1000))/100)
16377 SELect ON north
16381   =0 TO 4:IF east<5:grid_ref$(1)='S':ELSE grid_ref$(1)='T'
16385   =5 TO 9:grid_ref$(1)='N'
16389 END SELect
16393 SELect ON east
16397   =0,5:SELect ON north
16401      =0,5:grid_ref$(2)='V'
16405      =1,6:grid_ref$(2)='Q'
16409      =2,7:grid_ref$(2)='L'
16413      =3,8:grid_ref$(2)='F'
16417      =4,9:grid_ref$(2)='A'
16421      END SELect
16425   =1,6:SELect ON north
16429      =0,5:grid_ref$(2)='W'
16433      =1,6:grid_ref$(2)='R'
16437      =2,7:grid_ref$(2)='M'
16441      =3,8:grid_ref$(2)='G'
16445      =4,9:grid_ref$(2)='B'
16449      END SELect
16453   =2:SELect ON north
16457      =0,5:grid_ref$(2)='X'
16461      =1,6:grid_ref$(2)='S'
16465      =2,7:grid_ref$(2)='N'
16469      =3,8:grid_ref$(2)='H'
16473      =4,9:grid_ref$(2)='C'
16477      END SELect
16481   =3:SELect ON north
16485      =0,5:grid_ref$(2)='Y'
16489      =1,6:grid_ref$(2)='T'
16493      =2,7:grid_ref$(2)='O'
16497      =3,8:grid_ref$(2)='J'
16501      =4,9:grid_ref$(2)='D'
16505      END SELect
16509   =4:SELect ON north
16513      =0,5:grid_ref$(2)='Z'
16517      =1,6:grid_ref$(2)='U'
16521      =2,7:grid_ref$(2)='P'
16525      =3,8:grid_ref$(2)='K'
16529      =4,9:grid_ref$(2)='E'
16533      END SELect
16537 END SELect
16541 RETurn grid_ref$
16545 END DEFine
16549 :
16553 DEFine FuNction distance(a,b)
16557 LOCal northa,northb,easta,eastb,dn,de
16561 IF NOT a OR NOT b:RETurn -1
16565 IF a>placepos OR b>placepos:RETurn -1
16569 IF a=b:RETurn 0
16573 ga=grid_table(a):gb=grid_table(b)
16577 IF NOT ga OR NOT gb:RETurn -1
16581 easta=INT(ga/1000):eastb=INT(gb/1000)
16585 northa=ga-easta*1000:northb=gb-eastb*1000
16589 IF NOT northa OR NOT northb OR NOT easta OR NOT eastb:RETurn -1
16593 IF northa<>northb
16597   dn=(northa-northb)^2
16601 ELSE
16605   dn=0
16609 END IF
16613 IF easta<>eastb
16617   de=(easta-eastb)^2
16621 ELSE
16625   de=0
16629 END IF
16633 dist=SQRT(dn+de)
16637 RETurn INT(dist/units)+1
16641 END DEFine
16645 :
16649 DEFine FuNction decode_grid(r$)
16653 LOCal sq1$,sq2$,north,east
16657 IF LEN(r$) <>6:RETurn 0
16661 sq1$=r$(1):sq2$=r$(2)
16665 IF sq1$ INSTR 'SN'
16669   IF sq2$ INSTR 'AFLQV':east=0
16673   IF sq2$ INSTR 'BGMRW':east=1
16677   IF sq2$ INSTR 'CHNSX':east=2
16681   IF sq2$ INSTR 'DJOTY':east=3
16685   IF sq2$ INSTR 'EKPUZ':east=4
16689 END IF
16693 IF sq1$="T"
16697   IF sq2$ INSTR 'AFLQV':east=5
16701   IF sq2$ INSTR 'BGMRW':east=6
16705 END IF
16709 IF sq2$ INSTR 'ABCDE':north=4
16713 IF sq2$ INSTR 'FGHJK':north=3
16717 IF sq2$ INSTR 'LMNOP':north=2
16721 IF sq2$ INSTR 'QRSTU':north=1
16725 IF sq2$ INSTR 'VWXYZ':north=0
16729 IF sq1$='N':north=north+5
16733 RETurn (100*east+r$(3 TO 4))*1000+(100*north+r$(5 TO 6))
16737 END DEFine
16741 :
16745 DEFine FuNction get_locality(num)
16749 LOCal i,j,max_dist$,m,m$
16753 IF num=0 OR num=1
16757    m6 'Select central place'
16761    m$=PICK_table$(place_table$,len_place,placepos,'')
16765    origin=pick_num
16769    qwindow stat_chan
16773    IF origin=-1:RETurn 0
16777 END IF
16781 IF num=0 OR num=2
16785    m$="Distance in "&units$&" from "&place_table$(origin)&':'
16789    max_dist$=max_dist
16793    max_dist$=stick_up$(0,m$,max_dist$,4,1)
16797    max_dist=max_dist$
16801 END IF
16805 DIM birth_table(placepos),sort_table%(placepos)
16809 FOR i=1 TO placepos
16813   j=distance(origin,i)
16817   IF j<=max_dist AND j>=0
16821      birth_table(i)=j
16825      sort_table%(i)=i
16829    END IF
16833 END FOR i
16837 count=placepos
16841 do_sort birth_table
16845 start=0:finish=0
16849 FOR i=1 TO placepos:IF birth_table(i):start=i:EXIT i
16853 IF NOT start:RETurn 0
16857 finish=i+19:IF finish>placepos:finish=placepos
16861 RETurn 1
16865 END DEFine
16869 :
16873 DEFine PROCedure draw_map(opt)
16877 LOCal m,m$,p$,k,l,N,e,i
16881 LOCal big_loop,maxdist
16885 num=0
16889 REPeat big_loop
16893    point_window -1,0,res_chan,497,232
16897    CIRCLE #res_chan,50,50,50
16901    BLOCK #res_chan,1,230,316,0,colours%(res_chan,2)
16905    IF NOT get_locality(num):EXIT big_loop
16909    p$=place_table$(origin)&FILL$(' ',20)
16913    AT #res_chan,0,54:PRINT #res_chan,'No.';TO 58;'Place';TO 76;units$
16917    AT #res_chan,1,54:PRINT #res_chan,'0';TO 57;p$(1 TO 20)&' 0'
16921    east=INT(grid_table(origin)/1000)
16925    north=grid_table(origin)-east*1000
16929    count=2:maxdist=1
16933    FOR i=start TO finish
16937       j=sort_table%(i)
16941       e=INT(grid_table(j)/1000):N=grid_table(j)-e*1000
16945       IF ABS(e-east)>maxdist:maxdist=ABS(e-east)
16949       IF ABS(N-north)>maxdist:maxdist=ABS(N-north)
16953       p$=place_table$(j)&FILL$(' ',20)
16957       AT #res_chan,count,54:PRINT #res_chan,count-1;TO 57;p$(1 TO 20)&' '&birth_table(i)
16961       count=count+1
16965    END FOR i
16969    f=0:t=0:ti=1
16973    IF opt
16977       DIM selected(placepos)
16981       f=from_date:t=to_date
16985       ti=time_inc
16989    END IF
16993    FOR k=f TO t STEP ti
16997       FOR i=start TO finish
17001          j=sort_table%(i)
17005          e=INT(grid_table(j)/1000):N=grid_table(j)-e*1000
17009          e=25*(e-east)/maxdist+25
17013          N=22-(11*(N-north)/maxdist+11)
17017          IF opt
17021             selected(j)=selected(j)+time_span%(j,(k-f)/ti)
17025             AT #res_chan,N,e:PRINT #res_chan,i-start+1;"(";selected(j);")"
17029          ELSE
17033             AT #res_chan,N,e:PRINT #res_chan,i-start+1
17037          END IF
17041       END FOR i
17045       IF opt
17049          selected(origin)=selected(origin)+time_span%(origin,(k-f)/time_inc)
17053          AT #res_chan,11,25:PRINT #res_chan,origin;"(0)"
17057          AT #res_chan,0,0:PRINT #res_chan,from_date;' to ';k
17061          i=get_opt(0,1,stick2_menu$,2,menu_chan,'',0,1)
17065          IF i=1:EXIT k
17069       ELSE
17073          AT #res_chan,11,25:PRINT #res_chan,'0'
17077       END IF
17081    END FOR k
17085    k=get_opt(0,3,res_menu$,4,menu_chan,'',0,1)
17089    SELect ON k
17093       =0:num=2
17097       =1:num=1
17101       =2:num=3:SDP_DEV get_dest$:SDUMP #res_chan
17105       =3:EXIT big_loop
17109    END SELect
17113 END REPeat big_loop
17117 search_origin=origin:search_radius=max_dist
17121 IF search_origin<0:search_origin=0
17125 qwindow res_chan
17129 END DEFine
17133 :
17137 DEFine PROCedure setup_search
17141 from_date=1500:search_sur$='':search_chris$=''
17145 search_place$='':to_date=this_year
17149 search_type=9:search_type1=9
17153 mr=100:search_radius=0:search_origin=0
17157 search_com$='':search_source$='':search_stamp$=']'
17161 search_county=-1:search_sex=0:search_county$=''
17165 END DEFine
17169 :
17173 DEFine FuNction time_dist
17177 LOCal i,j,k
17181 IF NOT num_recs:RETurn 0
17185 time_inc=stick_up$(0,'Interval (years):',time_inc,2,1)
17189 m=0
17193 i=INT((to_date-from_date)/time_inc)+1
17197 IF i<0:RETurn 0
17201 DIM time_span%(placepos,i)
17205 FOR i=1 TO num_recs
17209    j=rec_ptable%(i)
17213    IF j
17217       d$=condat$(rec_exdate%(i),rec_date(i))
17221       IF con_y>=from_date AND con_y<=to_date
17225          k=(INT(con_y/time_inc)*time_inc-from_date)/time_inc
17229          time_span%(j,k)=time_span%(j,k)+1
17233          m=m+1:m6 'Events:'&m&' Year:'&con_y
17237       END IF
17241    END IF
17245 END FOR i
17249 qwindow stat_chan
17253 RETurn m
17257 END DEFine
17261 :
17265 DEFine PROCedure time_matrix
17269 LOCal yearsperpage,numpages,start,finish,i,j,k,m$,y$
17273 LOCal f$,t$
17277 IF pcw(3):RETurn
17281 f$=from_date:t$=to_date
17285 print_heads 'Place/Time Chart'
17289 report_title$=search_title$
17293 printer report_title$:printer ''
17297 yearsperpage=INT((page_width%(fount_type-1)-len_place)/5)
17301 numpages=INT(DIMN(time_span%,2)/yearsperpage)
17305 finish=-1
17309 FOR i=0 TO numpages
17313    m$=''
17317    start=finish+1:finish=start+yearsperpage-1
17321    IF finish>DIMN(time_span%,2):finish=DIMN(time_span%,2)-1
17325    IF start=DIMN(time_span%,2):EXIT i
17329    FOR j=start TO finish :y$=from_date+j*time_inc:m$=m$&y$&' '
17333    printer blanks$(1 TO len_place)&m$
17337    printer ''
17341    FOR j=1 TO placepos
17345       m$=place_table$(j)&FILL$(' ',len_place):m$=m$(1 TO len_place)
17349       FOR k=start TO finish:m$=m$&time_span%(j,k)&FILL$(' ',5-LEN(time_span%(j,k)))
17353       IF fprinter(m$):EXIT i
17357    END FOR j
17361    printer '':printer ''
17365 END FOR i
17369 print_tails
17373 END DEFine
17377 :
17381 DEFine PROCedure save_table(table_name$,id%,table_pos,table_file)
17385 LOCal i
17389 m6 'Saving Segment:'&file_type$(table_file)
17393 DELETE recs_dev$&file_type$(table_file)
17397 OPEN_NEW #io_chan,recs_dev$&file_type$(table_file)
17401 PRINT #io_chan,table_pos
17405 SELect ON table_file
17409    =15:PRINT #io_chan,len_sur
17413        table_sort 15,surname_table$,surpos,len_sur
17417    =16:PRINT #io_chan,len_chris
17421        table_sort 16,chris_table$,chrispos,len_chris
17425    =17:PRINT #io_chan,len_place
17429        table_sort 17,place_table$,placepos,len_place
17433    =18:PRINT #io_chan,len_com
17437        table_sort 18,comment_table$,commentpos,len_com
17441    =19:PRINT #io_chan,len_source
17445        table_sort 19,source_table$,sourcepos,len_source
17449 END SELect
17453 IF table_file=17
17457    FOR j=1 TO table_pos:i=sort_table%(j):PRINT #io_chan,id%(i):PRINT #io_chan,table_name$(i):PRINT #io_chan,grid_table(i):PRINT #io_chan,county_table%(i)
17461 ELSE
17465    FOR j=1 TO table_pos:i=sort_table%(j):PRINT #io_chan,id%(i):PRINT #io_chan,table_name$(i)
17469 END IF
17473 CLOSE #io_chan
17477 check_files
17481 qwindow stat_chan
17485 IF NOT order_flag%(table_file-15):load_table(table_file)
17489 END DEFine
17493 :
17497 DEFine PROCedure load_data
17501 LOCal i,j,record$
17505 IF NOT exists%(21):RETurn
17509 m6 "Loading Segment:"&file_type$(21)
17513 OPEN_IN #io_chan,recs_dev$&file_type$(21)
17517 IF NOT EOF(#io_chan)
17521   INPUT #io_chan,record$
17525   num_names=record$(1 TO (',' INSTR record$-1))
17529   person=record$(',' INSTR record$+1 TO)
17533   IF start_person<=0 OR start_person>num_names:start_person=person:ELSE person=start_person
17537   num_edits=0:max_names=num_names+room
17541   init_names
17545   FOR i=1 TO num_names
17549      GET #io_chan,i,fa%(i),ma%(i),yofb(i),yofd%(i),ftable%(i),mark%(i),user_mark%(i),gtable%(i)
17553   END FOR i
17557   CLOSE #io_chan
17561 END IF
17565 pick_field=0
17569 REMark FOR i=1 TO num_names
17573 REMark   IF ftable%(i)>surpos:ftable%(i)=add_table%(surname_table$,sur_id%,'*MISSING*',15)
17577 REMark   IF gtable%(i)>chrispos:gtable%(i)=add_table%(chris_table$,chris_id%,'*MISSING*',16)
17581 REMark length=LEN(given$(gtable%,i))+LEN(family$(ftable%,i))
17585 REMark IF length>sort_length:sort_length=length
17589 REMark END FOR i
17593 REMark sort_length=sort_length+1
17597 sort_length=len_sur+len_chris+1
17601 count_children
17605 print_family person
17609 Update_history
17613 qwindow stat_chan
17617 get_markers
17621 qwindow err_chan
17625 END DEFine
17629 :
17633 DEFine PROCedure load_table(table_file)
17637 LOCal i,l,j,table_pos,max_table
17641 IF NOT exists%(table_file):RETurn
17645 m6 "Loading Segment:"&file_type$(table_file)
17649 OPEN_IN #io_chan,recs_dev$&file_type$(table_file)
17653 IF EOF(#io_chan):qwindow stat_chan:CLOSE #io_chan:RETurn
17657 INPUT #io_chan,table_pos
17661 max_table=table_pos+room
17665 INPUT #io_chan,l
17669 IF l>max_len:max_len=l
17673 SELect ON table_file
17677    =15:len_sur=l:surnum=max_table:surpos=table_pos
17681        DIM surname_table$(max_table,l),sur_id%(max_table)
17685        FOR j=1 TO table_pos:INPUT #io_chan,sur_id%(j):INPUT #io_chan,surname_table$(j)
17689        order_flag%(0)=1
17693    =16:len_chris=l:chrisnum=max_table:chrispos=table_pos
17697        DIM chris_table$(max_table,l),chris_id%(max_table)
17701        FOR j=1 TO table_pos:INPUT #io_chan,chris_id%(j):INPUT #io_chan,chris_table$(j)
17705        order_flag%(1)=1
17709    =17:len_place=l:placenum=max_table:placepos=table_pos
17713        DIM place_table$(max_table,l),grid_table(max_table),county_table%(max_table),place_id%(max_table)
17717        FOR j=1 TO table_pos
17721           INPUT #io_chan,place_id%(j):INPUT #io_chan,place_table$(j):INPUT #io_chan,grid_table(j):INPUT #io_chan,county_table%(j)
17725           IF county_table%(j)<0:county_table%(j)=0
17729        END FOR j
17733        order_flag%(2)=1
17737    =18:len_com=l:commentnum=max_table:commentpos=table_pos
17741        DIM comment_table$(max_table,l),com_id%(max_table)
17745        FOR j=1 TO table_pos:INPUT #io_chan,com_id%(j):INPUT #io_chan,comment_table$(j)
17749        order_flag%(3)=1
17753    =19:len_source=l:sourcenum=max_table:sourcepos=table_pos
17757        DIM source_table$(max_table,l),source_id%(max_table)
17761        FOR j=1 TO table_pos:INPUT #io_chan,source_id%(j):INPUT #io_chan,source_table$(j)
17765        order_flag%(4)=1
17769 END SELect
17773 CLOSE #io_chan
17777 qwindow stat_chan
17781 END DEFine
17785 :
17789 DEFine PROCedure link_events(si)
17793 LOCal k,l
17797 IF point%(si):RETurn
17801 IF file_type<>20 AND file_type<>22:RETurn
17805 l=0
17809 IF search_array%(rec_ref%,0,si)>0 OR search_array%(rec_ref%,0,-si)>0
17813    FOR k=num_recs TO 0 STEP -1
17817       IF ABS(rec_ref%(k))=si:rec_event%(k)=l:l=k
17821    END FOR k
17825    point%(si)=l
17829 END IF
17833 END DEFine
17837 :
17841 DEFine PROCedure mark_events(jm)
17845 LOCal i,si
17849 IF NOT num_recs OR NOT num_names:RETurn
17853 FOR i=1 TO num_recs
17857    si=rec_ref%(i)
17861    IF si>0:mark si,jm
17865    IF si<0:mark si,14
17869 END FOR i
17873 END DEFine
17877 :
17881 DEFine PROCedure put_note(opt)
17885 LOCal field,a$,pr_loop,x$
17889 IF (file_type=20 AND opt) OR (file_type<>20 AND NOT opt):RETurn
17893 IF NOT get_recnum:RETurn
17897 pick_field=0
17901 IF NOT opt
17905    IF NOT num_names:RETurn
17909    type=get_note_type
17913    IF type<0:RETurn
17917    rec_link%(num_recs)=0
17921    rec_type%(num_recs)=type
17925    SELect ON type
17929       =1,2:od=yofb(person)*1000
17933       =3,0:od=0
17937       =4,5:od=yofd%(person)*1000
17941    END SELect
17945    rec_date(num_recs)=od
17949    rec_ftable%(num_recs)=ftable%(person)
17953    rec_ref%(num_recs)=person
17957    rec_relate%(num_recs)=sex%(person)*100+1
17961    rec_gtable%(num_recs)=gtable%(person)
17965    rec_stamp(num_recs)=DATE
17969    rec_id%(num_recs)=recnum
17973 ELSE
17977    copy_rec opt,recnum
17981    rec_ctable%(num_recs)=0
17985    rec_type%(num_recs)=7
17989 END IF
17993 qual=0
17997 rec_file%(num_recs)=20
18001 field=1
18005 point_window -1,-1,data_chan,(max_len+23)*6+4,92
18009 show_note type
18013 set_anchor outlnx/2-(3*(max_len+23)+2),82,table_chan
18017 REPeat pr_loop
18021    new_details
18025    d$=condat$(rec_exdate%(num_recs),rec_date(num_recs))
18029    SELect ON field
18033    =1:a$=place$(rec_ptable%,num_recs)
18037       get_field len_place,data_chan,4,19,5,a$
18041       rec_ptable%(num_recs)=add_table%(place_table$,place_id%,a$,17)
18045       AT #data_chan,4,20+LEN(a$):PRINT #data_chan,get_county$(num_recs)
18049    =2:a$=comment$(rec_ctable%,num_recs)
18053       get_field len_com,data_chan,5,19,0,a$
18057       rec_ctable%(num_recs)=add_table%(comment_table$,com_id%,a$,18)
18061    =3:a$=source$(rec_stable%,num_recs)
18065       get_field len_source,data_chan,6,19,0,a$
18069       rec_stable%(num_recs)=add_table%(source_table$,source_id%,a$,19)
18073    =4,5,6:rec_date(num_recs)=get_date(data_chan,7,19,field)
18077           rec_exdate%(num_recs)=qual
18081    END SELect
18085    IF exit_flag
18089       od=rec_date(num_recs)
18093       EXIT pr_loop
18097    END IF
18101    field=upfield(field,1,6)
18105 END REPeat pr_loop
18109 mark rec_ref%(num_recs),13
18113 qwindow stat_chan
18117 qwindow data_chan
18121 rec_edits=1
18125 END DEFine
18129 :
18133 DEFine PROCedure remove_x
18137 IF p1
18141   IF qmark%(p1,'X'):mark%(p1)=mark%(p1)-32
18145 END IF
18149 p1=0
18153 END DEFine
18157 :
18161 DEFine FuNction update_grid(num)
18165 LOCal gr$,i,gridref
18169 i=num:exit_flag=0
18173 REPeat gridref
18177    gr$=place_table$(num)
18181    IF num_county:gr$=gr$&' '&county$(county_table%(num))
18185    gr$=gr$&':'
18189    IF gr$='' OR gr$=' ':EXIT gridref
18193    gr$=stick_up$(2,gr$,get_grid$(num),6,2)
18197    IF exit_flag:RETurn 1
18201    IF gr$='':grid_table(num)=0:EXIT gridref
18205    IF gr$(1)=' ':grid_table(num)=0:EXIT gridref
18209    IF LEN(gr$)<6:BEEP 1500,100:NEXT gridref
18213    IF NOT gr$(1) INSTR 'NST' OR NOT gr$(2) INSTR 'ABCDEFGHJKLMNOPQRSTUVWXYZ':BEEP 1500,100:NEXT gridref
18217    FOR i=3 TO 6:IF NOT gr$(i) INSTR '0123456789':BEEP 1500,100:NEXT gridref
18221    grid_table(num)=decode_grid(gr$)
18225    table_edits=1
18229    EXIT gridref
18233 END REPeat gridref
18237 RETurn 0
18241 END DEFine
18245 :
18249 DEFine PROCedure reload
18253 pwait
18257 make_table
18261 get_params
18265 init_names:init_recs:num_names=0:person=0:Nxtrec=1:file_type=0
18269 surpos=0:chrispos=0:num_county=0
18273 DIM source_id%(sourcenum)
18277 FOR i=15 TO 19:load_table i
18281 load_county
18285 load_data
18289 load_spell
18293 pwait
18297 Link_spouses
18301 qwindow err_chan
18305 END DEFine
18309 :
18313 DEFine PROCedure setup_menu
18317 LOCal k,kk,set_loop,i,kkk
18321 REPeat set_loop
18325   set_anchor 20,30,menu_chan
18329   k=show_menu(0,'Quit',"Time Set","Spelling","Printer ½","Edit tables ½","Options ½",'Field lengths ½','Colours ½')
18333   SELect ON k
18337   =10:IF change_setup:save_params
18341     EXIT set_loop
18345   =20:i=stick_date(0,23)
18349   =30:make_table:asf
18353   =40:kk=show_menu(1,'Quit','Device','Baud rate','Layout','Codes','Title','','','')
18357     SELect ON kk
18361     =20:print_dev$=stick_up$(0,'Device:',print_dev$,40,0)
18365     =30:baud_rate=stick_up$(0,'Baud:',baud_rate,5,1)
18369       IF baud_rate:BAUD baud_rate
18373     =40:print_param
18377     =50:print_param2
18381     =60:user_title$=stick_up$(0,'Title:',user_title$,40,0)
18385     END SELect
18389     change_setup=1
18393   =50:kk=show_menu(1,'Quit','Given_names','Family names','Places','Comments','Sources','','')
18397     SELect ON kk
18401     =60:edit_table source_table$,19
18405     =50:edit_table comment_table$,18
18409     =40:kkk=show_menu(0,'Quit','Edit ½','add Grid refs','add Counties','Print','','','')
18413       SELect ON kkk
18417       =20:edit_table place_table$,17
18421       =30:get_grids
18425       =40:get_counties
18429       =50:list_tables place_table$,17
18433       END SELect
18437     =30:edit_table surname_table$,15
18441     =20:edit_table chris_table$,16
18445     END SELect
18449   =60:option_param:change_setup=1
18453   =70:dim_param
18457   =80:change_setup=1
18461     screen_param(0)
18465   END SELect
18469 END REPeat set_loop
18473 END DEFine
18477 :
18481 DEFine FuNction test_date
18485 LOCal m,N
18489 REMark Checks validity of month
18493 N=31:r=1:m=check_clock(con_m$)
18497 SELect ON m
18501   =2:N=28:IF INT(con_y/4)=con_y/4:N=29
18505      IF INT(con_y/100)=con_y/100:IF INT(con_y/400)<>con_y/400:N=28
18509   =1,3,5,7,8,10,12:N=31
18513   =4,6,9,11:N=30
18517   =0:N=31
18521 END SELect
18525 IF con_d>N OR con_y>this_year OR con_d<0:r=0
18529 IF NOT r:er "Date entered is not valid",'(Accepted and prefixed x)'
18533 RETurn r
18537 END DEFine
18541 :
18545 DEFine FuNction set_markers(mark_arr%)
18549 LOCal j,flag
18553 FOR j=1 TO num_names
18557    flag=0
18561    IF marker_list% AND (marker_list%&&mark%(j))=marker_list%:flag=1
18565    IF user_marker_list% AND (user_marker_list%&&user_mark%(j))=user_marker_list%:flag=flag+2
18569    IF marker_list% AND user_marker_list% AND flag<>3:flag=0
18573    IF qmark%(j,'/'):flag=0
18577    IF NOT mark_arr%(j):mark_arr%(j)=flag
18581 END FOR j
18585 RETurn 1
18589 END DEFine set_markers
18593 :
18597 DEFine PROCedure chron_sort
18601 LOCal i
18605 IF NOT num_recs:RETurn
18609 pwait
18613 DIM selected(num_recs)
18617 FOR i=1 TO num_recs:selected(i)=1
18621 sort_type=20
18625 sort_recs
18629 qwindow err_chan
18633 END DEFine chron_sort
18637 :
18641 DEFine FuNction status
18645 point_window -1,-1,data_chan,438,102
18649 PRINT #data_chan,"Table name"TO 20;"Used" TO 30;"Available" TO 40 ;"Percent" TO 50;"Field length"\\
18653 IF num_names:PRINT #data_chan,"Network data    NET"TO 20;num_names TO 30;max_names TO 40;INT(num_names*100/max_names);'%'
18657 IF file_type:PRINT #data_chan,"Loaded segment  "&file_type$(file_type) TO 20;(num_recs-num_del) TO 30;max_recs TO 40;INT((num_recs-num_del)*100/max_recs);'%'
18661 PRINT #data_chan
18665 PRINT #data_chan,"Family names    FAM"TO 20;surpos TO 30;surnum TO 40;INT(surpos*100/surnum);'%' TO 50;len_sur
18669 PRINT #data_chan,"Given names     GIV"TO 20;chrispos TO 30;chrisnum TO 40;INT(chrispos*100/chrisnum);'%' TO 50;len_chris
18673 PRINT #data_chan,"Place names     PLA"TO 20;placepos TO 30;placenum TO 40;INT(placepos*100/placenum);'%' TO 50;len_place
18677 PRINT #data_chan,"Comments        COM"TO 20;commentpos TO 30;commentnum TO 40;INT(commentpos*100/commentnum);'%' TO 50;len_com
18681 PRINT #data_chan,"Sources         SOU"TO 20;sourcepos TO 30;sourcenum TO 40;INT(sourcepos*100/sourcenum);'%' TO 50;len_source
18685 FOR i=0 TO 3:BLOCK #data_chan,1,100,117+60*i,0,colours%(data_chan,2)
18689 k=get_opt(0,1,stick2_menu$,2,menu_chan,'',0,1)
18693 qwindow data_chan
18697 RETurn k
18701 END DEFine status
18705 :
18709 DEFine FuNction pcw(sorted)
18713 LOCal i,k,pcw_loop,dest_type,form_menu
18717 exit_flag=0
18721 REPeat pcw_loop
18725    SELect ON sorted
18729       =0:num_opt=2
18733            form_menu=form+2
18737       =1:num_opt=3
18741            form_menu=form+2
18745       =2:num_opt=3
18749            form_menu=form_type/10-1
18753       =3:num_opt=1:form_menu=0
18757    END SELect
18761    IF dest$<>print_dev$:fount_type=1
18765    IF dest$='scr':fount_type=4
18769    DIM options$(3,52)
18773    options$(0)='Destination '&dest$
18777    options$(2)='Format      '&format$(form_menu)
18781    options$(1)='Typeface    '&type$(fount_type-1)
18785    options$(3)='Order       '&sorted$(sort_type/10-1)
18789    set_anchor pcwx,pcwy,menu_chan
18793    k=get_opt(0,num_opt,options$,1,menu_chan,pcw_menu$,1,1)
18797    SELect ON k
18801       =0:dest$=get_dest$
18805       =-1:IF form_type=10 AND sorted=2:order_cols
18809            EXIT pcw_loop
18813       =3:sort_type=sort_type+10:IF sort_type>30:sort_type=10
18817       =2:SELect ON sorted
18821              =0,1:IF form:form=0:ELSE form=1
18825              =2:IF form_type=10:form_type=20:ELSE form_type=10:form_menu=form_type/10-1
18829           END SELect
18833       =1:IF dest$=print_dev$
18837             fount_type=fount_type+1:IF fount_type>3:fount_type=1
18841          ELSE
18845             er 'Can only set typeface when destination is PRINTER',''
18849          END IF
18853       =-2:print_param:change_setup=1
18857       =-3:exit_flag=1:EXIT pcw_loop
18861    END SELect
18865 END REPeat pcw_loop
18869 RETurn exit_flag
18873 END DEFine pcw
18877 :
18881 DEFine PROCedure set_margin
18885 xpos=INT((69-sort_length-13)/2)
18889 IF xpos<6:xpos=6
18893 margin=xpos
18897 END DEFine set_margin
18901 :
18905 DEFine PROCedure zero_names(alter)
18909 attach%(alter)=0
18913 fa%(alter)=0
18917 ma%(alter)=0
18921 yofb(alter)=0
18925 yofd%(alter)=0
18929 ftable%(alter)=0
18933 gtable%(alter)=0
18937 mark%(alter)=0
18941 user_mark%(alter)=0
18945 END DEFine zero_names
18949 :
18953 DEFine PROCedure init_names
18957 DIM attach%(max_names),fa%(max_names),ma%(max_names),yofb(max_names),yofd%(max_names),ftable%(max_names),point%(max_names),mark%(max_names),gtable%(max_names),user_mark%(max_names)
18961 END DEFine init_names
18965 :
18969 DEFine FuNction set_rec(num)
18973 IF num>max_recs:er 'Maximum record limit hit','':RETurn 1
18977 rec_id%(num)=in_list%(0)
18981 rec_file%(num)=in_list%(1)
18985 rec_date(num)=in_date
18989 rec_link%(num)=in_list%(3)
18993 rec_stamp(num)=in_stamp
18997 rec_type%(num)=in_list%(5)
19001 rec_ref%(num)=in_list%(6)
19005 rec_ftable%(num)=in_list%(7)
19009 rec_stable%(num)=in_list%(8)
19013 rec_ptable%(num)=in_list%(9)
19017 rec_ctable%(num)=in_list%(10)
19021 rec_gtable%(num)=in_list%(11)
19025 rec_exdate%(num)=in_list%(12)
19029 rec_relate%(num)=in_list%(13)
19033 RETurn 0
19037 REMark *********
19041 IF rec_ftable%(num)>surpos:rec_ftable%(num)=add_table%(surname_table$,sur_id%,'*MISSING*',15)
19045 IF rec_gtable%(num)>chrispos:rec_gtable%(num)=add_table%(chris_table$,chris_id%,'*MISSING*',16)
19049 IF rec_ptable%(num)>placepos:rec_ptable%(num)=add_table%(place_table$,place_id%,'*MISSING*',17)
19053 IF rec_ctable%(num)>commentpos:rec_ctable%(num)=add_table%(comment_table$,com_id%,'*MISSING*',18)
19057 IF rec_stable%(num)>sourcepos:rec_stable%(num)=add_table%(source_table$,source_id%,'*MISSING*',19)
19061 RETurn 0
19065 REMark ***************
19069 END DEFine set_rec
19073 :
19077 DEFine FuNction next_parent(num,dmpos)
19081 ii=search_array%(fa%,dmpos,num)
19085 IF ii>0:dmpos=ii+1:sex=1:RETurn ii
19089 ii=search_array%(ma%,dmpos,num)
19093 IF ii>0:dmpos=ii+1:sex=2:RETurn ii
19097 sex=0:RETurn 0
19101 END DEFine next_parent
19105 :
19109 DEFine PROCedure add_gender(num)
19113 LOCal i,k,is,ks
19117 FOR i=1 TO num_names
19121    mark fa%(i),2
19125    mark ma%(i),6
19129 END FOR i
19133 IF NOT num:RETurn
19137 FOR is=1 TO num_names
19141    IF NOT qmark%(is,'M')
19145       IF NOT qmark%(is,'F')
19149          current_view=1:print_family is:ks=show_family(sex_menu$)
19153          SELect ON ks
19157             =-1:mark%(is)=mark%(is)+4
19161             =-2:mark%(is)=mark%(is)+64
19165             =-4:EXIT is
19169          END SELect
19173      END IF
19177    END IF
19181 END FOR is
19185 shut ft1_chan:current_view=0
19189 END DEFine add_gender
19193 :
19197 DEFine FuNction sex%(num)
19201 IF qmark%(num,'M'):RETurn 1
19205 IF qmark%(num,'F'):RETurn 2
19209 RETurn 0
19213 END DEFine sex%
19217 :
19221 DEFine PROCedure set_colours(chan,num)
19225 PAPER #chan,colours%(chan,0)
19229 INK #chan,colours%(chan,1)
19233 IF num:CLS #chan
19237 BORDER #chan,1,colours%(chan,2)
19241 END DEFine set_colours
19245 :
19249 DEFine PROCedure count_children
19253 LOCal i,m,f
19257 DIM attach%(max_names)
19261 FOR i=1 TO num_names
19265    f=fa%(i):m=ma%(i)
19269    IF f>0:attach%(f)=attach%(f)+1
19273    IF m>0:attach%(m)=attach%(m)+1
19277    IF f<0:attach%(-f)=attach%(-f)+100
19281    IF m<0:attach%(-m)=attach%(-m)+100
19285 END FOR i
19289 END DEFine count_children
19293 :
19297 DEFine PROCedure load_county
19301 LOCal i
19305 IF NOT exists%(24):DIM county$(0,3):RETurn
19309 OPEN_IN #ide_chan,recs_dev$&'COU'
19313 IF EOF(#ide_chan):CLOSE #ide_chan:RETurn
19317 INPUT #ide_chan,num_county
19321 DIM county$(num_county,3)
19325 FOR i=1 TO num_county:INPUT #ide_chan,county$(i)
19329 county$(0)='   '
19333 CLOSE #ide_chan
19337 END DEFine load_county
19341 :
19345 DEFine FuNction get_relate(num)
19349 LOCal k,kk,kkk,j,i
19353 DIM options$(8,14)
19357 k=get_opt(0,3,sex_menu$,4,menu_chan,'',0,1)+1:IF k>2:k=0
19361 DATA 'Related','Not related','Unknown'
19365 DATA parent$(k),child$(k),uncle$(k),nephew$(k),sibling$(k),'Cousin',rel_spouse$(k),'Grand>','Other'
19369 DATA parent$(k),child$(k),uncle$(k),nephew$(k),'Great Grand...'
19373 DATA parent$(k),child$(k),uncle$(k),nephew$(k)
19377 IF rec_link%(num)
19381    j=rec_pos(rec_link%(num))
19385    RESTORE 19361:FOR i=0 TO 2:READ options$(i)
19389    kk=get_opt(0,2,options$,3,menu_chan,'',0,1)
19393    SELect ON kk
19397        =0:RESTORE 19365:FOR i=0 TO 8:READ options$(i)
19401           set_anchor 30,30,menu_chan
19405           kkk=1+get_opt(0,8,options$,1,menu_chan,'',0,1)
19409           SELect ON kkk
19413              =1 TO 7:RETurn kkk+k*100+1
19417              =8:RESTORE 19369:FOR i=0 TO 4:READ options$(i)
19421                 kkk=1+get_opt(0,4,options$,5,menu_chan,'',0,1)
19425                 SELect ON kkk
19429                    =1 TO 4:RETurn kkk+k*100+1+10
19433                    =5:RESTORE 19373:FOR i=0 TO 3:READ options$(i)
19437                       kkk=1+get_opt(0,3,options$,4,menu_chan,'',0,1)
19441                       RETurn kkk+k*100+1+20
19445                 END SELect
19449              =9:RETurn -(2+k*100)
19453           END SELect
19457       =1:RETurn -(1+k*100)
19461       =2:RETurn k*100
19465    END SELect
19469 ELSE
19473    RETurn 1+k*100
19477 END IF
19481 END DEFine get_relate
19485 :
19489 DEFine FuNction relationship$(num)
19493 LOCal k,g,gg$,i
19497 SELect ON num
19501    =0,100,200:RETurn 'Unknown'
19505    =-1,-101,-201:RETurn 'No Relation'
19509    =-2,-102,-202:RETurn 'Relation'
19513 END SELect
19517 k=INT(num/100)
19521 gg$=''
19525 g=INT((num-k*100)/10)
19529 SELect ON g
19533    =1:gg$='Grand'
19537    =2:gg$='Great Grand'
19541 END SELect
19545 i=num-k*100-g*10
19549 SELect ON i
19553    =1:RETurn 'Subject'
19557    =2:RETurn gg$&parent$(k)
19561    =3:RETurn gg$&child$(k)
19565    =4:RETurn gg$&uncle$(k)
19569    =5:RETurn gg$&nephew$(k)
19573    =6:RETurn sibling$(k)
19577    =7:RETurn cousin$(k)
19581    =8:RETurn rel_spouse$(k)
19585 END SELect
19589 RETurn 'Unknown'
19593 END DEFine relationship$
19597 :
19601 DEFine FuNction rec_name$(num)
19605 LOCal mc$,ms$
19609 mc$=given$(rec_gtable%,num)
19613 ms$=family$(rec_ftable%,num)
19617 IF reverse_names:RETurn ms$&' '&mc$:ELSE RETurn mc$&' '&ms$
19621 END DEFine rec_name$
19625 :
19629 DEFine FuNction sex$(num)
19633 SELect ON num
19637    =100 TO 199,-101,-102:RETurn 'Male'
19641    =200 TO 299,-201,-202:RETurn 'Female'
19645 END SELect
19649 RETurn ''
19653 END DEFine sex$
19657 :
19661 DEFine PROCedure show_rec(max_field,recnum,h$)
19665 CLS #data_chan
19669 PRINT #data_chan,file_type$(file_type)&recnum;TO 19;h$
19673 PRINT #data_chan:PRINT #data_chan,"Given name(s)";TO 19;
19677 PRINT #data_chan,given$(rec_gtable%,num_recs)
19681 PRINT #data_chan,"Family name";TO 19;
19685 PRINT #data_chan,family$(rec_ftable%,num_recs)
19689 PRINT #data_chan,"Place";TO 19;
19693 PRINT #data_chan,place$(rec_ptable%,num_recs)&' '&get_county$(num_recs)
19697 PRINT #data_chan,"Comment";TO 19;
19701 PRINT #data_chan,comment$(rec_ctable%,num_recs)
19705 PRINT #data_chan,"Source reference";TO 19;
19709 PRINT #data_chan,source$(rec_stable%,num_recs)
19713 PRINT #data_chan,"Date";TO 19;condat$(rec_exdate%(num_recs),rec_date(num_recs))
19717 PRINT #data_chan,"Network number";TO 19;rec_ref%(num_recs)
19721 IF max_field<>9:PRINT #data_chan,"Age";TO 19;age
19725 BLOCK #data_chan,1,100,111,0,colours%(data_chan,2)
19729 END DEFine show_rec
19733 :
19737 DEFine PROCedure show_cen(num)
19741 CLS #data_chan
19745 PRINT #data_chan,file_type$(file_type)&recnum;
19749 SELect ON num
19753    =0:PRINT #data_chan,TO 19;"FIRST PERSON's Details"
19757    =1:PRINT #data_chan,TO 19;"NEXT PERSON..."
19761 END SELect
19765 PRINT #data_chan:PRINT #5,"Date";TO 19;condat$(0,census_date(year/10-1))
19769 PRINT #data_chan,"Place";TO 19;
19773 PRINT #data_chan,place$(rec_ptable%,num_recs)&' '&get_county$(num_recs)
19777 PRINT #data_chan,"Address";TO 19;ans$
19781 PRINT #data_chan,"Source Reference";TO 19;
19785 PRINT #data_chan,source$(rec_stable%,num_recs)
19789 PRINT #data_chan,"Given name(s)";TO 19;
19793 PRINT #data_chan,given$(rec_gtable%,num_recs)
19797 PRINT #data_chan,"Family name";TO 19;
19801 PRINT #data_chan,family$(rec_ftable%,num_recs)
19805 PRINT #data_chan,"Age";TO 19;age
19809 PRINT #data_chan,"Occupation";TO 19;occ$
19813 PRINT #data_chan,"Network number";TO 19;rec_ref%(num_recs)
19817 IF max_field=10
19821    PRINT #data_chan,"Place of Birth";TO 19;pob$
19825    PRINT #data_chan,"Condition";TO 19;con$
19829 ELSE
19833    PRINT #data_chan,"County of Birth";TO 19;pob$
19837 END IF
19841 BLOCK #data_chan,1,140,111,0,colours%(data_chan,2)
19845 END DEFine show_cen
19849 :
19853 DEFine PROCedure show_note(type)
19857 PRINT #data_chan,file_type$(file_type)&recnum;TO 19;"NOTE:"&note_type$(type)&" of #"&person
19861 PRINT #data_chan:PRINT #data_chan,"Given name(s)";TO 19;
19865 PRINT #data_chan,given$(rec_gtable%,num_recs)
19869 PRINT #data_chan,"Family name";TO 19;
19873 PRINT #data_chan,family$(rec_ftable%,num_recs)
19877 PRINT #data_chan,"Place";TO 19;
19881 PRINT #data_chan,place$(rec_ptable%,num_recs)&' '&get_county$(num_recs)
19885 PRINT #data_chan,"Note";TO 19;
19889 PRINT #data_chan,comment$(rec_ctable%,num_recs)
19893 PRINT #data_chan,"Source Reference";TO 19;
19897 PRINT #data_chan,source$(rec_stable%,num_recs)
19901 PRINT #data_chan,"Date";TO 19;condat$(rec_exdate%(num_recs),rec_date(num_recs))
19905 BLOCK #data_chan,1,90,111,0,colours%(data_chan,2)
19909 END DEFine show_note
19913 :
19917 DEFine FuNction get_text(rec)
19921 LOCal m$,opts,kk
19925 DIM options$(gotdocs,len_com)
19929 opts=0
19933 FOR kk=0 TO gotdocs
19937   m$=comment$(rec_ctable%,doc_table%(kk))
19941   IF 'TEXT=' INSTR m$=1:options$(opts)=m$:opts=opts+1
19945   IF 'IMAGE=' INSTR m$=1:options$(opts)=m$:opts=opts+1
19949 END FOR kk
19953 SELect ON opts
19957   =0:m6 'No existing file names'
19961      kk=-INT(show_menu(0,'add Text','add Image','Quit','','','','','')/10)
19965      qwindow stat_chan
19969   =REMAINDER :kk=get_opt(0,opts-1,options$,1,menu_chan,getext_menu$,1,1)
19973 END SELect
19977 exit_flag=0
19981 IF kk>=0
19985   IF 'TEXT=' INSTR options$(kk)=1
19989     m$=options$(kk)(6 TO LEN(options$(kk)))
19993     display_file 0,m$
19997   ELSE
20001     IF 'IMAGE=' INSTR options$(kk)=1
20005       m$=options$(kk)(7 TO LEN(options$(kk)))
20009       get_device(m$):get_directory m$
20013       IF NOT check_dir(file$,1,1)
20017         LOAD_SCREENX m$
20021         dump_screen
20025         clear_screen
20029       END IF
20033     END IF
20037   END IF
20041 ELSE
20045   IF NOT get_recnum:RETurn 0
20049   noQmenu=THING('Menus'):REMark Test for Qmenu
20053   SELect ON kk
20057     =-1
20061      IF noQmenu=0
20065        text_file$=FILE_SELECT$("Text File:",,recs_dev$,"",,,1,1)
20069        IF text_file$='':exit_flag=1
20073      ELSE
20077        text_file$=stick_up$(2,'Text file:',text_file$,40,0)
20081      END IF
20085      m$='TEXT='&text_file$
20089     =-2
20093      IF noQmenu=0
20097        image_file$=FILE_SELECT$("Image File:",,recs_dev$,"",,,1,1)
20101        IF image_file$='':exit_flag=1
20105      ELSE
20109        image_file$=stick_up$(2,'Image file:',image_file$,40,0)
20113      END IF
20117      m$='IMAGE='&image_file$
20121   END SELect
20125   IF kk=-3 OR exit_flag:RETurn 0
20129   copy_rec rec,recnum
20133   rec_ctable%(num_recs)=add_table%(comment_table$,com_id%,m$,18)
20137   rec_edits=1
20141   RETurn 1
20145 END IF
20149 RETurn 0
20153 END DEFine
20157 :
20161 DEFine FuNction sel_field(l_or_p)
20165 LOCal sel_menu$(6,6),i
20169 DIM options$(12,32)
20173 DATA 'OK','Reset','Quit',''
20177 DATA 'OK','Reset','reLoad','Quit'
20181 SELect ON l_or_p
20185    =0:m6 "LOAD Selection criteria   Blank=ALL":RESTORE 20173
20189    =1:m6 "DISPLAY Selection criteria   Blank=ALL":RESTORE 20177
20193 END SELect
20197 FOR i=0 TO 3:READ sel_menu$(i)
20201 options$(0)='Event Type :'&st$
20205 options$(1)='Given Name :'&search_chris$
20209 options$(2)='Family Name:'&search_sur$
20213 options$(3)='Place      :'&search_place$
20217 options$(4)='Area       :'&search_radius&' '&units$&' radius'
20221 options$(5)='County     :'&search_county$
20225 options$(6)='From Year  :'&from_date
20229 options$(7)='To Year    :'&to_date
20233 options$(8)='Max Records:'&mr
20237 options$(9)='Sex        :'&sex$(100*search_sex)
20241 options$(10)='Comment    :'&search_com$
20245 options$(11)='Source     :'&search_source$
20249 options$(12)='Update Date:['&search_stamp$
20253 set_anchor 170,72,menu_chan
20257 RETurn get_opt(1,12,options$,1,menu_chan,sel_menu$,1,1)
20261 END DEFine sel_field
20265 :
20269 DEFine PROCedure birth_brief
20273 LOCal i,j,k,bb_loop,bb_level,bb_lines,linpos
20277 LOCal maxline,maxlevel,l,m$,s
20281 load_records 22,0
20285 IF NOT num_recs OR exit_flag:RETurn
20289 IF report_setup(0):RETurn
20293 parents
20297 IF maxpow>9:maxpow=9
20301 IF dest$='scr':maxpow=3
20305 maxpow=numgens(maxpow)
20309 maxped=2^(maxpow+1)-2
20313 DIM b_brief%(maxped,5)
20317 print_heads "Birth Brief"
20321 report_title$="Birth Brief for "&full_name$(person)
20325 printer report_title$
20329 FOR i=1 TO num_names
20333    IF qmark%(i,'/'):selected(i)=0
20337    IF selected(i)<=maxped AND selected(i)<>0:b_brief%(selected(i),0)=i
20341 END FOR i
20345 b_brief%(0,0)=person:b_brief%(0,5)=0
20349 FOR i=0 TO maxped
20353    IF b_brief%(i,0)
20357       link_events(b_brief%(i,0))
20361       j=point%(b_brief%(i,0))
20365       REPeat bb_loop
20369          IF NOT j:EXIT bb_loop
20373          k=rec_type%(j)
20377          SELect ON k
20381             =1:b_brief%(i,1)=j
20385             =3:b_brief%(i,2)=j
20389             =4:b_brief%(i,3)=j
20393          END SELect
20397          j=rec_event%(j)
20401       END REPeat bb_loop
20405    END IF
20409 END FOR i
20413 maxlevel=0
20417 FOR i=1 TO maxped
20421       k=1
20425       REPeat bb_level
20429         IF i<=2^k-2:b_brief%(i,5)=k-1:EXIT bb_level
20433         k=k+1
20437       END REPeat bb_level
20441    IF k-1>maxlevel:maxlevel=k-1
20445 END FOR i
20449 j=maxped:linpos=(1+maxped/2)*9:maxline=0
20453 REPeat bb_lines
20457    FOR i=j TO j/2 STEP -1
20461       IF b_brief%(i,5)=maxlevel
20465          b_brief%(i,4)=linpos:linpos=linpos-9
20469       ELSE
20473          b_brief%(i,4)=b_brief%(i*2+1,4)+4
20477       END IF
20481    IF b_brief%(i,4)>maxline:maxline=b_brief%(i,4)
20485    END FOR i
20489    IF NOT j:EXIT bb_lines
20493    j=j/2-1
20497 END REPeat bb_lines
20501 maxline=maxline+9
20505 s=slot:IF dest$='scr':s=20
20509 FOR i=1 TO maxline
20513    m$=FILL$(' ',s*(maxlevel+1)+1)
20517    FOR j=0 TO maxped
20521       IF i>=b_brief%(j,4) AND i<b_brief%(j,4)+8
20525          k=i-b_brief%(j,4):l=b_brief%(j,5)*s+1
20529          IF NOT b_brief%(j,0)
20533             m$(l TO l+s)=FILL$('.',s-1)
20537          ELSE
20541             IF form
20545                IF k=0:k=1:ELSE IF k=1:k=0
20549             END IF
20553             SELect ON k
20557                =0:m$(l TO l+s-2)=given$(gtable%,b_brief%(j,0))
20561                =1:m$(l TO s+l-2)=family$(ftable%,b_brief%(j,0))
20565                =2:m$(l TO s+l-2)='B.'&condat$(rec_exdate%(b_brief%(j,1)),rec_date(b_brief%(j,1)))
20569                =3:m$(l TO l+s-2)=place$(rec_ptable%,b_brief%(j,1))
20573                =4:m$(l TO l+s-2)='M.'&condat$(rec_exdate%(b_brief%(j,2)),rec_date(b_brief%(j,2)))
20577                =5:m$(l TO l+s-2)=place$(rec_ptable%,b_brief%(j,2))
20581                =6:m$(l TO l+s-2)='D.'&condat$(rec_exdate%(b_brief%(j,3)),rec_date(b_brief%(j,3)))
20585                =7:m$(l TO l+s-2)=place$(rec_ptable%,b_brief%(j,3))
20589             END SELect
20593          END IF
20597       END IF
20601    END FOR j
20605    IF fprinter(m$):EXIT i
20609 END FOR i
20613 add_marker('B')
20617 print_tails
20621 END DEFine birth_brief
20625 :
20629 DEFine FuNction rec_pos(id)
20633 ij=search_array%(rec_id%,0,id)
20637 IF ij<0:ij=0
20641 RETurn ij
20645 END DEFine rec_pos
20649 :
20653 DEFine PROCedure table_sort(sort_flag,table_name$,tablepos,tablelen)
20657 LOCal i,j,lena,a$,ki,l
20661 i=tablelen:IF i>8:i=8
20665 DIM alpha_sort$(tablepos,i),sort_table%(tablepos)
20669 IF order_flag%(sort_flag-15)
20673    FOR i=0 TO tablepos:sort_table%(i)=i
20677 ELSE
20681    count=0
20685    FOR i=1 TO tablepos
20689       sort_table%(count)=i
20693       a$=table_name$(i):lena=LEN(a$):l=0
20697       IF lena>1
20701          FOR j=1 TO lena-1
20705             IF a$(j)=' '
20709                FOR ki=j TO lena-1:a$(ki)=a$(ki+1)
20713                l=l+1
20717             END IF
20721             ki=CODE(a$(j))
20725             IF ki<123 AND ki>96:a$(j)=CHR$(ki-32)
20729          END FOR j
20733          a$=a$(1 TO lena-l)
20737       END IF
20741       alpha_sort$(count)=a$
20745       count=count+1
20749    END FOR i
20753    do_sort$ alpha_sort$
20757 END IF
20761 END DEFine table_sort
20765 :
20769 DEFine PROCedure do_sort$(table$)
20773 LOCal i,d,e,b,temp,temp$,j
20777 LOCal sl1,sl2,sl3
20781 i=1
20785 REPeat sl1
20789   IF 2^i>count+1:EXIT sl1
20793   i=i+1
20797 END REPeat sl1
20801 j=2^i-1
20805 REPeat sl2
20809    j=INT(j/2)
20813    IF NOT j:EXIT sl2
20817    b=1:d=count-j+1:i=b
20821    REPeat sl3
20825       e=i+j-1
20829       IF table$(i-1)>table$(e)
20833          temp$=table$(e):table$(e)=table$(i-1)
20837          table$(i-1)=temp$
20841          temp=sort_table%(e):sort_table%(e)=sort_table%(i-1)
20845          sort_table%(i-1)=temp
20849          i=i-j
20853          IF i<1
20857             b=b+1
20861             IF b>d:EXIT sl3
20865             i=b
20869          END IF
20873          NEXT sl3
20877       END IF
20881       b=b+1
20885       IF b>d:EXIT sl3
20889       i=b
20893    END REPeat sl3
20897 END REPeat sl2
20901 END DEFine do_sort$
20905 :
20909 DEFine PROCedure start_pointer
20913 LOCal i
20917 OPEN #0,'con'
20921 OUTLN #0;outlnx,outlny,0,0
20925 OPEN #1,'con':OPEN #2,'con'
20929 MODE 4
20933 DIM chan_stat%(max_chan,2),wdefs(max_chan),anchor%(1)
20937 chan_stat%(data_chan,0)=100:chan_stat%(data_chan,1)=110
20941 chan_stat%(ft_chan,0)=12:chan_stat%(ft_chan,1)=6
20945 chan_stat%(ft1_chan,0)=256:chan_stat%(ft1_chan,1)=20
20949 chan_stat%(eve_chan,0)=300:chan_stat%(eve_chan,1)=20
20953 FOR i=stick_chan,sub_chan,table_chan,menu_chan:chan_stat%(i,0)=-1:chan_stat%(i,1)=-1
20957 anchor%(0)=87:anchor%(1)=142
20961 pointer_defs
20965 clear_screen
20969 END DEFine
20973 :
20977 DEFine PROCedure pointer_defs
20981 RESTORE 20989
20985 tree_sprite=RD_SPRT
20989 DATA 6,5,4
20993 DATA '     wwwwww'
20997 DATA '    waaaaaaw   '
21001 DATA '   waggggggaw   '
21005 DATA '   wagggggggggaw '
21009 DATA '  waggggggggggaw '
21013 DATA ' wagggggggagggggaw'
21017 DATA 'wagggagggagggggaw'
21021 DATA ' waggaagaggggaw  '
21025 DATA '  waggaagggaw    '
21029 DATA '     waaw        '
21033 DATA '     waaw        '
21037 DATA '    waaaaw       ',''
21041 END DEFine
21045 :
21049 DEFine FuNction RD_SPRT
21053 LOCal tmp_patt$(32,32)
21057 LOCal xs,ys, xo,yo, md, l
21061 xs=0:ys=-1:READ xo,yo,md
21065 REPeat l
21069   READ x$:IF x$='':EXIT l
21073   ys=ys+1:tmp_patt$(ys)=x$&FILL$(' ',32)
21077   IF LEN(x$)>xs:xs=LEN(x$)
21081 END REPeat l
21085 l=ALCHP(SPRSP(xs,ys+1))
21089 SPSET l,xo,yo,md,tmp_patt$(0 TO ys,1 TO xs)
21093 RETurn l
21097 END DEFine
21101 :
21105 DEFine FuNction show_menu(lev,a$,b$,c$,d$,e$,f$,g$,h$)
21109 LOCal i,k
21113 DIM options$(7,20)
21117 RESTORE 21121
21121 DATA a$,b$,c$,d$,e$,f$,g$,h$
21125 FOR i=0 TO 7
21129   READ options$(i)
21133   IF options$(i)='':i=i-1:EXIT i
21137 END FOR i
21141 SELect ON lev
21145   =1:set_anchor 0,0,sub_chan:k=get_opt(0,i,options$,1,sub_chan,'',0,1)*10+10
21149     shut menu_chan
21153   =0:set_anchor 0,0,menu_chan:k=get_opt(0,i,options$,1,menu_chan,'',0,1)*10+10
21157     anchor%(0)=-1:anchor%(1)=-1
21161 END SELect
21165 IF NOT '½' INSTR options$((k-10)/10):qwindow stat_chan
21169 RETurn k
21173 END DEFine
21177 :
21181 DEFine FuNction get_opt(no_close,num_options,opts$,ncols,chan,lilist$,lirows%,read_ptr)
21185 LOCal event,i,j,length,a$,height,disp_cols
21189 LOCal rownum,num_per_row,rowpos,nitems,lastcol,num_cols,newopts
21193 LOCal max_height,b$,max_opts,lilst,maxcols
21197 LOCal swdef%(3),wdef%(3),apw(0),c%,d%,e%,opts,cols
21201 IF num_options<0:RETurn 0
21203 TEST_MEMORY
21205 maxcols=INT(outlnx/6)-13
21209 IF NOT read_ptr:lirows%=0
21213 length=1:nitems=0:opts=num_options:cols=ncols
21217 FOR i=0 TO opts:IF LEN(opts$(i))>length:length=LEN(opts$(i))
21221 IF lirows%
21225   nitems=DIMN(lilist$)-3:DIM lflag%(nitems+3),lsize%(nitems+3,1)
21229   num_per_row=INT((nitems+1)/lirows%)-1
21233   menu_length=DIMN(lilist$,2)
21237   wdef%(0)=(menu_length*6+4)*(num_per_row+1)+3+num_per_row*4
21241   IF wdef%(0)<66:wdef%(0)=66
21245   lsize%(nitems+1,0)=wdef%(0)-46
21249   lsize%(nitems+2,0)=20
21253   lsize%(nitems+3,0)=22
21257 END IF
21261 lastcol=0:arrows=0
21265 SELect ON cols
21269 =1:IF opts>screen_length-1-lirows%:arrows=1
21273 =opts+1:IF length*opts>maxcols:arrows=2
21277 =-1:max_opts=screen_length-lirows%-1
21281   cols=INT((opts+1)*2/max_opts)+1
21285   IF cols*length>maxcols:cols=INT((opts+2)/max_opts)+1
21289   IF cols*length>maxcols:arrows=2
21293   FOR i=max_opts TO 1 STEP -1
21297     newopts=(INT(opts/cols)+1)*cols-1
21301     IF newopts-opts<=10 OR cols<=10:EXIT i
21305     cols=INT((opts+2)/i)+1
21309   END FOR i
21313   opts=newopts
21317   IF length>INT(maxcols/2):IF opts>max_opts:cols=1:arrows=1
21321 =-20 TO -4:cols=-cols
21325 END SELect
21329 sk$=FILL$(' ',opts+1)
21333 num_per_col=INT(opts/cols)
21337 DIM aflag%(num_per_col,cols-1),ct%(1,2)
21341 SELect ON chan
21345 =ft_chan,ft1_chan
21349   FOR i=0 TO opts
21353     IF (bar$ INSTR opts$(i) AND NOT '_' INSTR opts$(i)) OR 'No data' INSTR opts$(i) OR ''=opts$(i):aflag%(i,0)=16
21357   END FOR i
21361   IF NOT aflag%(subject-1,0):aflag%(subject-1,0)=128
21365 =data_chan:FOR i=1 TO opts:aflag%(i,0)=16
21369   aflag%(0,0)=128
21373 =tree_chan:aflag%(9,1)=128
21377 =stick_chan:wdef%(2)=10:wdef%(3)=30
21381 =menu_chan:IF cols<>1 OR (NOT lirows% AND NOT num_options):set_anchor outlnx/2-((length+1)*(opts+1)*6+4)/2,outlny-16,menu_chan
21385   sk$='':FOR i=0 TO opts:sk$=sk$&get_capital$(opts$(i))
21389 =sub_chan:sk$='':FOR i=0 TO opts:sk$=sk$&get_capital$(opts$(i))
21393 =eve_chan:colx=0:coly=0
21397   FOR i=0 TO opts
21401     IF '*Empty record*' INSTR opts$(i):aflag%(colx,coly)=16
21405     coly=coly+1:IF coly>cols-1:colx=colx+1:coly=0
21409   END FOR i
21413 END SELect
21417 ct%(0,0)=1
21421 num_cols=cols-1
21425 DIM iattr(3,3)
21429 iattr(0,0)=1
21433 iattr(0,1)=colours%(chan,2)
21437 iattr(2,0)=colours%(chan,0):iattr(1,0)=colours%(chan,0)
21441 iattr(2,1)=colours%(chan,1):iattr(1,1)=colours%(chan,2)
21445 iattr(3,0)=colours%(chan,1)
21449 iattr(3,1)=colours%(chan,0)
21453 DIM jus%(opts,1),type%(opts),strg$(opts,length),pspr(0),pblb(0),ppat(0),x_size%(num_cols,1),y_size%(num_per_col,1),se%(num_per_col,1)
21457 FOR i%=0 TO opts
21461   jus%(i%,0)=1
21465   type%(i%)=-256
21469 END FOR i%
21473 FOR i%=0 TO num_per_col
21477   se%(i%,0)=lastcol
21481   lastcol=lastcol+cols
21485   se%(i%,1)=lastcol
21489 END FOR i%
21493 FOR i%=0 TO num_per_col:y_size%(i%,0)=10:y_size%(i%,1)=10
21497 FOR i%=0 TO num_cols:x_size%(i%,0)=length*6+4:x_size%(i%,1)=length*6+8
21501 aolst=MK_AOL(iattr,jus%,sk$,type%,opts$,pspr(0),pblb(0),ppat(0))
21505 rwlst=MK_RWL(aolst,se%)
21509 x_aslst=MK_ASL(x_size%)
21513 y_aslst=MK_ASL(y_size%)
21517 FOR disp_cols=cols TO 0 STEP -1
21521   swdef%(0)=(length*6+4)*disp_cols+4+(disp_cols-1)*4
21525   IF swdef%(0)<=(outlnx-32):EXIT disp_cols
21529 END FOR disp_cols
21533 IF NOT disp_cols:er 'Cannot display data','':RETurn 0
21537 max_height=screen_length-lirows%-1
21541 IF arrows=1:max_height=max_height-1
21545 height=num_per_col:IF height>max_height:height=max_height
21549 swdef%(1)=(height+1)*10+2
21553 DIM wattr%(3)
21557 wattr%(0)=1
21561 wattr%(1)=1
21565 wattr%(2)=colours%(chan,1)
21569 wattr%(3)=colours%(chan,0)
21573 cdefx=0:cdefy=0:offx=0:offy=0
21577 SELect ON arrows
21581 =1:ct%(0,0)=1:ct%(1,2)=height+2:offy=6
21585   cdefy=MK_CDEF(1,colours%(chan,2),colours%(chan,2),colours%(chan,2))
21589   swdef%(1)=swdef%(1)+24
21593 =2:ct%(0,0)=1:ct%(1,2)=disp_cols:offx=12
21597   cdefx=MK_CDEF(1,colours%(chan,2),colours%(chan,2),colours%(chan,2))
21601   swdef%(0)=swdef%(0)+24
21605 END SELect
21609 lilst=0
21613 IF lirows%
21617   wdef%(1)=lirows%*11+2+14
21621   swdef%(3)=wdef%(1)
21625   DIM org%(nitems+3,1),jus%(nitems+3,1),type%(nitems+3)
21629   rownum=0
21633   sk$='':rowpos=0
21637   FOR i=0 TO nitems
21641     type%(i)=-256:jus%(i,0)=1:sk$=sk$&get_capital$(lilist$(i))
21645     lsize%(i,1)=10:lsize%(i,0)=menu_length*6+2
21649     org%(i,0)=6*rowpos*(menu_length+1)+2*rowpos+2:org%(i,1)=14+1+rownum*11
21653     rowpos=rowpos+1:IF rowpos>num_per_row:rowpos=0:rownum=rownum+1
21657   END FOR i
21661   FOR i=1 TO 3:type%(nitems+i)=-256:lsize%(nitems+i,1)=12:sk$=sk$&' '
21665   DIM sprite(0)
21669   type%(nitems+2)=-254:sprite(0)=6:lilist$(nitems+2)='ESC'
21673   lsize%(nitems+2,0)=20
21677   lsize%(nitems+3,0)=22
21681   lsize%(nitems+1,0)=wdef%(0)-46
21685   org%(nitems+1,0)=22:org%(nitems+1,1)=1
21689   org%(nitems+2,0)=2:org%(nitems+2,1)=1
21693   org%(nitems+3,0)=wdef%(0)-24:org%(nitems+3,1)=1:jus%(nitems+3,0)=1
21697   IF arrows=1:lsize%(nitems+1,0)=lsize%(nitems+1,0)+12:org%(nitems+3,0)=org%(nitems+3,0)+12
21701   IF lsize%(nitems+1,0)<swdef%(0)-46:lsize%(nitems+1,0)=swdef%(0)-46
21705   IF org%(nitems+3,0)<swdef%(0)-24:org%(nitems+3,0)=swdef%(0)-24
21709   lilst=MK_LIL(iattr,lsize%,org%,jus%,sk$,type%,lilist$,sprite(0),0,0)
21713 END IF
21717 IF wdef%(0)<swdef%(0)
21721   wdef%(0)=swdef%(0)
21725 ELSE
21729   offx=INT((wdef%(0)-swdef%(0))/2)
21733   swdef%(0)=wdef%(0)
21737 END IF
21741 wdef%(1)=wdef%(1)+swdef%(1)
21745 IF arrows=1:wdef%(0)=wdef%(0)+10
21749 IF arrows=2:wdef%(1)=wdef%(1)+6
21753 IF swdef%(0)/2<>swdef%(0) DIV 2:swdef%(0)=swdef%(0)-1
21757 IF swdef%(2)/2<>swdef%(2) DIV 2:swdef%(2)=swdef%(2)+1
21761 IF wdef%(0)/2<>wdef%(0) DIV 2:wdef%(0)=wdef%(0)-1
21765 IF wdef%(2)/2<>wdef%(2) DIV 2:wdef%(2)=wdef%(2)+1
21769 IF chan_stat%(chan,2)
21773   DR_ADRW wdefs(chan),0,aflag%,ct%
21777 ELSE
21781   apw(0)=MK_APPW(swdef%,wattr%,0,CHR$(9),cdefx,cdefy,offx,offy,x_aslst,y_aslst,0,0,rwlst)
21785   awlst=MK_AWL(apw)
21789   IF lirows%
21793     wdefs(chan)=MK_WDEF(wdef%,wattr%,tree_sprite,lilst,0,awlst)
21797     DR_PULD wdefs(chan),chan_stat%(chan,0),chan_stat%(chan,1),lflag%,aflag%,ct%
21801     draw_header chan
21805   ELSE
21809     wdefs(chan)=MK_WDEF(wdef%,wattr%,tree_sprite,0,0,awlst)
21813     DR_PULD wdefs(chan),chan_stat%(chan,0),chan_stat%(chan,1),aflag%,ct%
21817   END IF
21821   chan_stat%(chan,2)=1
21825 END IF
21829 IF NOT read_ptr:RETurn 0
21833 REPeat get_item%
21837   IF lirows%
21841     RD_PTR wdefs(chan),item%,wind%,c%,d%,e%,lflag%,aflag%,ct%
21845     IF item%=nitems+2:IF wind%=-1:c%=8
21849     IF item%=nitems+3:IF wind%=-1:c%=2
21853     IF item%=nitems+1:IF wind%=-1:c%=16
21857     IF wind%=-1:IF item%>=0:IF item%<=DIMN(lflag%):lflag%(item%)=0
21861     DR_LDRW wdefs(chan),lflag%
21865     draw_header chan
21869   ELSE
21873     RD_PTR wdefs(chan),item%,wind%,c%,d%,e%,aflag%,ct%
21877   END IF
21881   event=c%
21885   SELect ON event
21889   =128,64,1:IF item%<0:NEXT get_item%
21893     IF item%<opts:IF '*Empty record*' INSTR opts$(item%):NEXT get_item%
21897     EXIT get_item%
21901   =8:CH_WIN wdefs(chan)
21905   =4:shut chan:er 'Sorry, there is no on-line help','Please see the manual'
21909     RETurn get_opt(no_close,num_options,opts$,cols,chan,lilist$,lirows%,read_ptr)
21913   =2:IF lirows%:item%=nitems:wind%=-1:EXIT get_item%
21917   =16:change_setup=1
21921     set_anchor -1,-1,menu_chan:screen_param(chan):shut chan
21925     RETurn get_opt(no_close,num_options,opts$,cols,chan,lilist$,lirows%,read_ptr)
21929   =32:BT_SLEEP 'Button_sleep'
21933   END SELect
21937 END REPeat get_item%
21941 IF no_close:anchor%(0)=chan_stat%(chan,0)+d%:anchor%(1)=chan_stat%(chan,1)+e%
21945 IF item%>=0 AND item%<=DIMN(opts$)
21949   IF '½' INSTR opts$(item%):no_close=1
21953 END IF
21957 IF NOT no_close:shut chan
21961 IF NOT wind%:wind%=1
21965 IF wind%=-1:item%=item%+1
21969 RETurn item%*wind%
21973 END DEFine
21977 :
21981 DEFine FuNction PICK_table$(arr$,length,tcount,orig$)
21985 LOCal k,l,x$
21989 DIM options$(tcount+10,length+2)
21993 IF tcount<1:RETurn orig$
21997 IF (tcount/(screen_length+1))>10:DIM options$(tcount+INT(tcount/screen_length+1),length+2)
22001 FOR l=0 TO tcount:options$(l)=arr$(l)
22005 pick_num=get_opt(0,tcount,options$,lr_col,table_chan,pick_menu$,1,1)
22009 IF pick_num=-1:x$=orig$:ELSE x$=options$(pick_num)
22013 RETurn x$
22017 END DEFine
22021 :
22025 DEFine FuNction show_family(li_menu$)
22029 LOCal i,title,margin,type,pp,name$,view_num
22033 LOCal show_loop,k,kk,xpos
22037 LOCal pref$,return_flag,cancel_flag
22039 TEST_MEMORY
22041 return_flag=0:redraw_flag=0:cancel_flag=0
22045 IF NOT num_names
22049   IF warn('No Family network was loaded','Starting a new one','OK'):RETurn 1
22053   add(0)
22057   IF NOT num_names:RETurn 1
22061 END IF
22065 IF current_view:shut ft1_chan:return_flag=1
22069 REPeat show_loop
22073   FOR i=DIMN(screens%,2) TO 0 STEP -1
22077     IF screens%(current_view,i,1):EXIT i
22081   END FOR i
22085   IF i<=(screen_length-4) AND NOT current_view:i=screen_length-4:ELSE redraw_flag=1
22089   IF i<=7:i=7
22093   DIM options$(i+1,78)
22097   IF NOT current_view:set_margin: ELSE margin=6
22101   gen_gap%=0:ypos=2:title=2
22105   REPeat make_menu
22109     pp=0:title=title+1:ypos=ypos+1
22113     IF ypos>i:EXIT make_menu
22117     type=screens%(current_view,title,1)
22121     pp=screens%(current_view,title,0)
22125     pref$=' {'&pp&markers$(pp,0)&'}'
22129     IF '(System Name)' INSTR full_name$(pp)=1:options$(ypos-1)='':ypos=ypos-2:NEXT make_menu
22133     IF NOT pp AND type
22137       name$='No data for '&title$(title)
22141     ELSE
22145       SELect ON type
22149       =2,1:name$=full_name$(pp)&pref$
22153       =4:name$=bar$&'_'&full_name$(pp)&pref$
22157       =-1,3:name$=mar_char$&' '&full_name$(pp)&pref$
22161       =5:name$=bar$
22165         IF NOT current_view:name$=name$&FILL$(' ',sort_length+24)
22169       =0:name$=''
22173       END SELect
22177     END IF
22181     SELect ON type
22185     =5:xpos=margin:pp=0
22189       IF gen_gap%:xpos=xpos-3:gen_gap%=0
22193     =1,3:xpos=margin-3
22197     =2:xpos=margin-6:gen_gap%=1
22201     =-1,4:xpos=margin
22205     =0:xpos=0
22209     END SELect
22213     options$(ypos-1)=FILL$(' ',xpos)&name$
22217   END REPeat make_menu
22221   title=ypos
22225   IF chan_stat%(ft_chan,2) AND NOT current_view
22229     IF DIMN(options$,1)>=screen_length-2 OR redraw_flag
22233       redraw_flag=1
22237       shut ft_chan
22241       IF DIMN(options$,1)<screen_length-2:redraw_flag=0
22245     ELSE
22249       FOR i=0 TO DIMN(options$,1)
22253         CH_ITEM wdefs(ft_chan),0,i,-1,CHR$(0),options$(i)
22257       END FOR i
22261     END IF
22265   END IF
22269   SELect ON current_view
22273   =0:k=get_opt(1,title,options$,1,ft_chan,ft_menu$,2,1)
22277   =1:kk=get_opt(1,title,options$,1,ft1_chan,li_menu$,1,1)
22281     IF li_menu$(0)<>ft1_menu$(0):RETurn kk
22285     SELect ON kk
22289     =-1:k=-11
22293     =-2,-3:shut ft1_chan
22297       IF return_flag
22301         IF kk=-3:cancel_flag=1
22305         EXIT show_loop
22309       ELSE
22313         current_view=0
22317         IF kk=-2
22321           FOR i=0 TO max_child:screens%(0,i,0)=screens%(1,i,0)
22325           FOR i=0 TO max_child:screens%(0,i,1)=screens%(1,i,1)
22329         END IF
22333         NEXT show_loop
22337       END IF
22341     =1 TO title :k=kk
22345     =REMAINDER :NEXT show_loop
22349     END SELect
22353   END SELect
22357   SELect ON k
22361     =1 TO title
22365       REPeat no_sys%
22369         FOR yk%=1 TO options$(k,0)
22373           IF options$(k,yk%) INSTR 'abcdefghijklmnopqrstuvwxyz?':EXIT yk%
22377         NEXT yk%:EXIT no_sys%
22381         END FOR yk%
22385         FOR xk%=1 TO title
22389           pp=screens%(current_view,xk%+1,0):IF pp<=0:NEXT xk%:EXIT xk%
22393           pref$=' {'&pp&markers$(pp,0)&'}'
22397           tmp$=full_name$(pp)&pref$:tp%=LEN(tmp$):IF tp%=0:NEXT xk%:EXIT xk%
22401           FOR yk2%=1 TO tp%
22405             IF tmp$(yk2%) INSTR 'abcdefghijklmnopqrstuvwxyz?':EXIT yk2%
22409           NEXT yk2%:EXIT no_sys%
22413           END FOR yk2%
22417           FOR yk3%=yk2% TO tp%
22421           IF tmp$(yk2% TO tp%) INSTR options$(k)=yk%:k=xk%:EXIT no_sys%
22425         END FOR xk%
22429       END REPeat no_sys%
22433       print_family screens%(current_view,k+1,0)
22437       Update_history
22441     =-1:add(0)
22445     =-2:change
22449     =-3:remove:IF NOT num_names:EXIT show_loop
22453     =-4:add(1)
22457     =-5:print_family stick_up$(0,'Net no:',person,5,6)
22461         Update_history
22465     =-15:current_view=1
22469        FOR i=0 TO max_child:screens%(1,i,0)=screens%(0,i,0)
22473        FOR i=0 TO max_child:screens%(1,i,1)=screens%(0,i,1)
22477     =-20:IF current_view:shut ft1_chan: ELSE shut ft_chan
22481        EXIT show_loop
22485     =-6:marker_menu
22489     =-7:index
22493     =-8:integrity
22497     =-9:display_file 1,list_file$
22501     =-11:find_name(0)
22505          Update_history
22509     =-10:IF p1:kk=show_menu(0,'Mark new subject','Show relationship','','','','','',''):ELSE kk=10
22513       relate kk/10
22517     =-12:IF loadin_segment:IF num_recs:id_menu person
22521     =-19:kk=show_menu(0,'Quit','Family group','Marked families','','','','','')
22525        SELect ON kk
22529        =20:hard_copy
22533        =30:operate_markers(20):current_view=0
22537        END SELect
22541     =-13:kk=show_menu(0,'Quit','Ancestors','Pedigree ½','Birth Brief','Family Table','','','')
22545        SELect ON kk
22549        =20:ancestors
22553        =30:pedigree
22557        =40:birth_brief
22561        =50:surname_table
22565        END SELect
22569     =-14:start_tree
22573     =-18:expand_notes
22577     =-16:kk=-1
22581        IF hist_pos<max_history
22585          IF history%(hist_pos+1):kk=INT((show_menu(0,'Back','Forward','','','','','','')-15)/5)
22589        END IF
22593        hist_pos=hist_pos+kk
22597        IF hist_pos<1:hist_pos=1
22601        print_family history%(hist_pos)
22605     =-17:show_notes
22609     =0:EXIT show_loop
22613     END SELect
22617   IF current_view:shut ft1_chan
22621 END REPeat show_loop
22625 RETurn cancel_flag
22629 END DEFine
22633 :
22637 DEFine PROCedure init_menus
22641 LOCal i,c$,q$,o$
22645 DIM ft_menu$(22,6),eve_menu$(4,5),pick_menu$(3,6),stick2_menu$(4,6),match_menu$(8,6),print_menu$(5,6),main_menu$(5,10),find_menu$(5,6),find2_menu$(5,6),page_list$(6,6),segments$(13,26),pcw_menu$(5,6),ok_menu$(3,3),ft1_menu$(5,6),ft_res$(4,6),ft_mark$(6,4),tree_menu$(11,8),getext_menu$(5,9),doc_menu$(5,6),getrec_menu$(7,6),rep_menu$(3,6),report_menu$(12,9),upd_menu$(9,6),note_menu$(5,5),ti_menu$(1,5),dest_menu$(5,7),sex_menu$(6,7),ident_menu$(4,8),baby_menu$(4,9),wedding_menu$(4,14),bap_menu$(2,6),another$(1,11),date_menu$(5,7),select_menu$(5,5),census_menu$(2,14),ide_menu$(2,15),map_menu$(1,4),inform_menu$(1,9),res_menu$(3,6)
22649 q$='Quit':o$='OK':c$='Cancel'
22653 RESTORE 22653
22657 DATA 'Radius','Centre','Dump',o$
22661 FOR i=0 TO 3:READ res_menu$(i)
22665 DATA 'Informant',q$
22669 FOR i=0 TO 1:READ inform_menu$(i)
22673 DATA 'Dump','Quit'
22677 FOR i=0 TO 1:READ map_menu$(i)
22681 DATA 'Generate matches','Match from file',q$
22685 FOR i=0 TO 2:READ ide_menu$(i)
22689 DATA 'next Person','next Household',q$
22693 FOR i=0 TO 2:READ census_menu$(i)
22697 DATA 'Go to','Print',q$
22701 FOR i=0 TO 2:READ select_menu$(i)
22705 DATA 'Exact','Circa','After','Before','Quarter','Invalid'
22709 FOR i=0 TO 5:READ date_menu$(i)
22713 DATA 'next Person',q$
22717 FOR i=0 TO 1:READ another$(i)
22721 DATA 'Father','Mother','Informant','Other',q$
22725 FOR i=0 TO 4:READ baby_menu$(i)
22729 DATA "Groom's Father","Bride's Father",'Witness','Other',q$
22733 FOR i=0 TO 4:READ wedding_menu$(i)
22737 DATA 'Continue','Repeat','Next doc','Save',q$
22741 FOR i=0 TO 4:READ ident_menu$(i)
22745 DATA 'Father','Mother',q$
22749 FOR i=0 TO 2:READ bap_menu$(i)
22753 DATA 'Male','Female','Unknown',q$
22757 FOR i=0 TO 3:READ sex_menu$(i)
22761 DATA 'Screen','Printer','File'
22765 FOR i=0 TO 2:READ dest_menu$(i)
22769 DATA q$,'View'
22773 FOR i=0 TO 1:READ ti_menu$(i)
22777 DATA 'Add','Print',q$
22781 FOR i=0 TO 2:READ note_menu$(i)
22785 DATA 'Add','Link','Print','Column','Rows','Save',q$
22789 FOR i=0 TO 6:READ upd_menu$(i)
22793 DATA 'Print','Distance','Area map','Time-span','Matrix','File','Column','Order','Rows',q$
22797 FOR i=0 TO 9:READ report_menu$(i)
22801 DATA 'Family','View','Search',q$
22805 FOR i=0 TO 3:READ rep_menu$(i)
22809 DATA 'Select','Add','Link','Print',q$
22813 FOR i=0 TO 4:READ getrec_menu$(i)
22817 DATA 'Top','Bottom','Left','Right','Select','Annotate','FileTree','Print',q$
22821 FOR i=0 TO 8:READ tree_menu$(i)
22825 DATA 'Add','Change','Delete','Join','Go to','Marker'
22829 DATA 'Index','Verify','File'
22833 DATA 'Xref','Select','Link','Report','Tree','Window'
22837 DATA 'Back','Notes','Events','Print',q$
22841 FOR i=0 TO 19:READ ft_menu$(i)
22845 DATA 'Select',o$,q$
22849 FOR i=0 TO 2:READ ft1_menu$(i)
22853 DATA 'Select',q$
22857 FOR i=0 TO 1:READ ft_res$(i)
22861 DATA 'Yes','No','All',q$
22865 FOR i=0 TO 3:READ ft_mark$(i)
22869 DATA 'Print',q$
22873 FOR i=0 TO 1:READ eve_menu$(i)
22877 DATA c$
22881 READ pick_menu$(0)
22885 DATA o$,c$
22889 FOR i=0 TO 1:READ stick2_menu$(i)
22893 DATA "No","Yes",'Maybe','Print','Select',q$
22897 FOR i=0 TO 5:READ match_menu$(i)
22901 DATA 'Scroll','Page','Line',q$
22905 FOR i=0 TO 3:READ print_menu$(i)
22909 DATA 'Family Net','Research','Parameters','Save','reLoad',q$
22913 FOR i=0 TO 5:READ main_menu$(i)
22917 DATA o$,'Pick',c$
22921 FOR i=0 TO 2:READ find_menu$(i)
22925 DATA 'Next','Pick',c$
22929 FOR i=0 TO 2:READ find2_menu$(i)
22933 DATA 'Print','View',q$
22937 FOR i=0 TO 2:READ doc_menu$(i)
22941 DATA 'Family','Change','Delete','Remark','Print','View',q$
22945 FOR i=0 TO 6:READ page_list$(i)
22949 DATA 'Civil Register Births','Civil Register Marriages','Civil Register Deaths','Parish Register Baptisms','Parish Registers Marriages','Parish Registers Burials','Census Returns','Wills','IGI Baptisms','IGI Marriages','Monuments','Other Sources','Notes (Family network)'
22953 FOR i=0 TO 12:READ segments$(i)
22957 DATA o$,'Layout',c$
22961 FOR i=0 TO 2:READ pcw_menu$(i)
22965 DATA o$
22969 READ ok_menu$(0)
22973 DATA 'add Text','add Image',q$
22977 FOR i=0 TO 2:READ getext_menu$(i)
22981 END DEFine
22985 :
22989 DEFine PROCedure expand_notes
22993 LOCal note_loop,expand_loop,evenum,inum,k,i
22997 REPeat note_loop
23001   evenum=note_menu
23005   SELect ON evenum
23009     =-1:print_recs(3)
23013     =-2: EXIT note_loop
23017     =0 TO gotdocs
23021       REPeat expand_loop
23025         inum=doc_table%(evenum)
23029         k=show_page(-1,-1,inum,ti_menu$,1)
23033         SELect ON k
23037           =0:shut data_chan:EXIT expand_loop
23041           =1:show_text(inum)
23045         END SELect
23049       END REPeat expand_loop
23053  END SELect
23057 END REPeat note_loop
23061 qwindow stat_chan
23065 END DEFine
23069 :
23073 DEFine FuNction rec_field(k)
23077 DIM options$(10,65)
23081 options$(0)='Date           '&condat$(rec_exdate%(k),rec_date(k))
23085 options$(4)='Network number '&rec_ref%(k)
23089 options$(2)='Given name     '&given$(rec_gtable%,k)
23093 options$(3)='Family name    '&family$(rec_ftable%,k)
23097 options$(5)='Place          '&place$(rec_ptable%,k)
23101 options$(6)='Comment        '&comment$(rec_ctable%,k)
23105 options$(7)='Source         '&source$(rec_stable%,k)
23109 options$(1)='Event type     '&note_type$(rec_type%(k))
23113 options$(9)='Sex            '&sex$(rec_relate%(k))
23117 options$(8)='Relationship   '&relationship$(rec_relate%(k))
23121 options$(10)='Doc number     '&rec_link%(k)
23125 RETurn get_opt(0,10,options$,1,table_chan,pick_menu$,1,1)
23129 END DEFine
23133 :
23137 DEFine FuNction stick_up$(opt,prefix$,name$,length,type)
23141 LOCal k,n$,l,t
23145 n$=name$:l=length:t=type
23149 DIM options$(0,l+LEN(prefix$))
23153 set_anchor 0,0,stick_chan
23157 options$(0)=prefix$&n$&FILL$(' ',l)
23161 SELect ON opt
23165    =0:k=get_opt(1,0,options$,1,stick_chan,ok_menu$,1,1)
23169    =1:k=get_opt(1,0,options$,1,stick_chan,find_menu$,1,1)
23173    =2:k=get_opt(1,0,options$,1,stick_chan,stick2_menu$,1,1)
23177 END SELect
23181 pick_field=0
23185 SELect ON k
23189    =0:OPEN #stick_chan,'con_'
23193       DR_AWDF #stick_chan,wdefs(stick_chan),0:set_colours stick_chan,1
23197       AT #stick_chan,0,INT(offx/6):PRINT #stick_chan,prefix$
23201       get_field l,stick_chan,0,LEN(prefix$)+INT(offx/6),t,n$
23205       CLOSE #stick_chan
23209    =-2:pick_field=data_chan:exit_flag=1
23213    =-3:exit_flag=1
23217 END SELect
23221 shut stick_chan
23225 RETurn n$
23229 END DEFine
23233 :
23237 DEFine PROCedure point_window(x%,y%,chan,xsize%,ysize%)
23241 LOCal wdef%(3),wattr%(3),xpos%,ypos%,apw(0),awlst
23245 IF NOT chan_stat%(chan,2)
23249   wattr%(0)=1
23253   wattr%(1)=1
23257   wattr%(2)=colours%(chan,1)
23261   wattr%(3)=colours%(chan,0)
23265   wdef%(0)=xsize%:wdef%(1)=ysize%
23269   IF x%=-1:xpos%=INT((outlnx-xsize%)/2):ELSE xpos%=x%
23273   IF y%=-1:ypos%=INT((outlny-ysize%)/2):ELSE ypos%=y%
23277   IF chan=back_chan:wattr%(0)=0
23281   apw(0)=MK_APPW(wdef%,wattr%,0,'')
23285   awlst=MK_AWL(apw)
23289   wdefs(chan)=MK_WDEF(wdef%,wattr%,tree_sprite,0,0,awlst)
23293   OPEN #chan,'con_'
23297   DR_PULD wdefs(chan),xpos%,ypos%
23301   DR_AWDF #chan,wdefs(chan),0
23305   chan_stat%(chan,2)=2
23309 END IF
23313 set_colours chan,1
23317 END DEFine
23321 :
23325 DEFine PROCedure start_tree
23329 LOCal k
23333 IF current_tree
23337   k=show_menu(0,'Quit','Generate','Load','Show #'&current_tree,'','','','')
23341 ELSE
23345   k=show_menu(0,'Quit','Generate','Load','','','','','')
23349 END IF
23353 SELect ON k
23357   =20:IF NOT tree:show_tree
23361   =30:IF NOT get_tree:show_tree
23365   =40:show_tree
23369 END SELect
23373 END DEFine
23377 :
23381 DEFine FuNction ft_field(k)
23385 LOCal f$,m$,g$
23389 DIM options$(6,65)
23393 options$(0)='Given name     '&given$(gtable%,k)
23397 options$(1)='Family name    '&family$(ftable%,k)
23401 options$(2)='Year of Birth  '&yofb(k)&' '&year_text$(0,k)
23405 options$(3)='Year of Death  '&yofd%(k)&' '&year_text$(1,k)
23409 options$(4)='Parents Details ...'
23413 options$(5)='Spouse Details  ...'
23417 g$='Unknown':IF qmark%(k,'M'):g$='Male'
23421 IF qmark%(k,'F'):g$='Female'
23425 IF qmark%(k,'M'):IF qmark%(k,'F'):g$='Unknown'
23429 options$(6)='Sex            '&g$
23433 RETurn get_opt(0,6,options$,1,table_chan,ok_menu$,1,1)
23437 END DEFine
23441 :
23445 DEFine FuNction year_text$(num,pos)
23449 LOCal yob,yod
23453 SELect ON num
23457   =0:yob=yofb(pos)
23461      IF NOT yob:RETurn 'Unknown'
23465      IF yob<100:RETurn 'Sequence'
23469      IF yob<>INT(yob):RETurn 'Sequence'
23473      RETurn 'Birth Year'
23477   =1:yod=yofd%(pos)
23481      IF yod=-1:RETurn 'Living'
23485      IF NOT yod:RETurn 'Unknown'
23489      RETurn 'Death Year'
23493 END SELect
23497 END DEFine
23501 :
23505 DEFine PROCedure add_fields
23509 LOCal pr_loop,field,max_field,length,a$,a,b
23513 length=len_chris:IF len_sur>len_chris:length=len_sur
23517 point_window -1,-1,data_chan,6*(length+17),42
23521 PRINT #data_chan,"Given name    ";given$(gtable%,alter)
23525 PRINT #data_chan,"Family name   ";family$(ftable%,alter)
23529 PRINT #data_chan,"Year of Birth ";yofb(alter)
23533 PRINT #data_chan,"Year of Death ";yofd%(alter)
23537 new_details
23541 field=1:max_field=4
23545 set_anchor outlnx/2-(3*(length+17)),103,table_chan
23549 REPeat pr_loop
23553   SELect ON field
23557     =1:a$=given$(gtable%,alter)
23561        get_field len_chris,data_chan,0,14,-1,a$
23565        gtable%(alter)=add_table%(chris_table$,chris_id%,a$,16)
23569     =2:a$=family$(ftable%,alter)
23573        get_field len_sur,data_chan,1,14,2,a$
23577        ftable%(alter)=add_table%(surname_table$,sur_id%,a$,15)
23581     =3:get_field 7,data_chan,2,14,1,yofb(alter)
23585     =4:get_field 7,data_chan,3,14,1,yofd%(alter)
23589   END SELect
23593   IF exit_flag:EXIT pr_loop
23597   field=upfield(field,1,max_field)
23601 END REPeat pr_loop
23605 qwindow data_chan
23609 a=LEN(given$(gtable%,alter))
23613 b=LEN(family$(ftable%,alter))
23617 IF (a+b)>=sort_length:sort_length=a+b+1
23621 IF a+b=0:remove_person alter,0:alter=subj:REMark Ignore blank entries
23625 qwindow stat_chan
23629 END DEFine
23633 :
23637 DEFine PROCedure draw_header(chan)
23641 LOCal i,xs%
23645 OPEN #head_chan,'scr'
23649 DR_LWDF #head_chan,wdefs(chan),nitems+1
23653 xs%=lsize%(nitems+1,0)
23657 IF xs%>WINDTAB(head_chan,4):xs%=WINDTAB(head_chan,4)
23661 IF xs%>2:FOR i=0 TO 10 STEP 2:BLOCK #head_chan,xs%-2,1,0,i,colours%(chan,1)
23665 IF xs%>=108
23669    STRIP #head_chan,colours%(chan,0):INK #head_chan,colours%(chan,1)
23673    AT #head_chan,0,INT(xs%/12)-(LEN(chan_title$(chan))+7)/2-1:PRINT #head_chan,chan_title$(chan)&' Window'
23677 END IF
23681 CLOSE #head_chan
23685 END DEFine
23689 :
23693 DEFine PROCedure shut(chan)
23697 IF NOT chan_stat%(chan,2):RETurn
23701 DR_UNST wdefs(chan)
23705 chan_stat%(chan,2)=0
23709 END DEFine
23713 :
23717 DEFine PROCedure clear_screen
23721 point_window 0,0,back_chan,outlnx-4,outlny-2
23725 set_colours back_chan,1
23729 FOR i=0 TO 10 STEP 2:BLOCK #back_chan,outlnx-8,1,0,i,colours%(back_chan,2)
23733 AT #back_chan,0,(outlnx/12)-10:PRINT #back_chan,"Genealogist V"&qlg_ver$
23737 END DEFine
23741 :
23745 DEFine PROCedure set_anchor(x%,y%,chan)
23749 IF chan<>menu_chan
23753   IF x%=-1:x%=outlnx/2
23757   IF y%=-1:y%=outlny/2
23761 END IF
23765 IF x%:IF y%:anchor%(0)=x%:anchor%(1)=y%
23769 chan_stat%(chan,0)=anchor%(0)
23773 chan_stat%(chan,1)=anchor%(1)
23777 END DEFine
23781 :
23785 DEFine PROCedure mark(l,num)
23789 LOCal k
23793 IF NOT l:RETurn
23797 k=ABS(l)
23801 IF NOT (2^num&&mark%(k)):mark%(k)=mark%(k)+2^num
23805 END DEFine
23809 :
23813 DEFine PROCedure pwait
23817 LOCal hour,min,temp$
23821 point_window -1,-1,err_chan,63,45
23825 CIRCLE #err_chan,50,50,50
23829 LINE #err_chan,0,50 TO 100,50
23833 LINE #err_chan,50,0 TO 50,100
23837 INK #err_chan,colours%(err_chan,0):FILL #err_chan,1
23841 CIRCLE #err_chan,50,50,30
23845 INK #err_chan,colours%(err_chan,2):FILL #err_chan,0
23849 temp$=DATE$
23853 hour=temp$(13 TO 14):min=temp$(16 TO 17)
23857 IF hour>12:hour=hour-12
23861 hour=hour+min/60
23865 min=RAD(min*6)
23869 hour=RAD(hour*30)
23873 LINE #err_chan,50,50 TO 50+SIN(min)*50,50+COS(min)*50
23877 LINE #err_chan,50,50 TO 50+SIN(hour)*40,50+COS(hour)*40
23881 END DEFine
23885 :
23889 DEFine PROCedure qwindow(chan)
23893 shut chan
23897 CLOSE #chan
23901 END DEFine
23905 :
23909 DEFine FuNction qmark%(num,a$)
23913 LOCal l
23917 l=a$ INSTR char$
23921 IF 2^(l-1)&&mark%(num):IF l:RETurn 1
23925 l=a$ INSTR user_char$
23929 IF 2^(l-1)&&user_mark%(num):IF l:RETurn 2
23933 RETurn 0
23937 END DEFine
23941 :
23945 DEFine FuNction list_recs(no_close,doc_table%,num,menu$,list_form)
23949 LOCal si,j,nc,a$,b$,i,numc
23953 LOCal c$
23957 IF NOT chan_stat%(eve_chan,2)
23961   pwait
23965   set_anchor -1,-1,table_chan
23969   SELect ON list_form
23973     =0:DIM list_options$(num+10,sort_length+7)
23977     =1:DIM list_options$(num+10,len_place+7)
23981     =2:DIM list_options$(num+10,len_com+7)
23985     =3:DIM list_options$(num+10,len_source+7)
23989     =4:DIM list_options$(num+10,72):res_length
23993   END SELect
23997   FOR j=0 TO num
24001     si=doc_table%(j)
24005     IF rec_id%(si)
24009       SELect ON list_form
24013         =0:b$=rec_name$(si)
24017         =1:b$=place$(rec_ptable%,si)
24021         =2:b$=comment$(rec_ctable%,si)
24025         =3:b$=source$(rec_stable%,si)
24029         =4:b$='':numc=7
24033            FOR i=1 TO DIMN(rank%)
24037              a$=get_rank$(i,si):IF NOT d:EXIT i
24041              numc=numc+d+1
24045              IF numc>72:EXIT i
24049              a$=a$&FILL$(' ',d):a$=a$(1 TO d)
24053              b$=b$&' '&a$
24057            END FOR i
24061       END SELect
24065       a$=condat$(0,rec_date(si)):a$=a$(LEN(a$)-3 TO)
24069       IF file_type=22 AND rec_ref%(si)<0:a$=a$&' ?'
24073       c$=note_type$(rec_type%(si))
24077       list_options$(j)=c$(1 TO 2)&a$&' '&b$
24081     ELSE
24085       IF DIMN(list_options$(2))>21
24089         list_options$(j)='        *Empty record*'
24093       ELSE
24097         list_options$(j)='*Empty record*'
24101       END IF
24105     END IF
24109   END FOR j
24113   qwindow err_chan
24117 END IF
24121 nc=1:IF DIMN(menu$)>9:nc=2
24125 set_anchor outlnx,30,eve_chan
24129 RETurn get_opt(no_close,num,list_options$,lr_col,eve_chan,menu$,nc,1)
24133 END DEFine
24137 :
24141 DEFine FuNction numgens(maxpow)
24145 RETurn stick_up$(0,'Generations:',maxpow,2,1)
24149 END DEFine
24153 :
24157 DEFine FuNction check_rec
24161 LOCal i,total_count,j
24165 total_count=32:count=0
24169 FOR i=1 TO num_recs
24173   IF search_county$=get_county$(i) OR search_county=-1
24177     IF search_sex=INT(rec_relate%(i)/100) OR NOT search_sex
24181       IF INT(rec_date(i)/1000)>=from_date OR NOT rec_date(i)
24185         IF INT(rec_date(i)/1000)<=to_date
24189           IF search_type=9 OR search_type=rec_type%(i) OR search_type1=rec_type%(i) OR (search_type=8 AND NOT rec_link%(i))
24193             IF search_stamp$=']' OR (search_stamp$ INSTR stamp$(rec_stamp(i)))
24197               selected(i)=32
24201             END IF
24205           END IF
24209         END IF
24213       END IF
24217     END IF
24221   END IF
24225 END FOR i
24229 search_table surname_table$,sur_id%,surpos,rec_ftable%,search_sur$,15
24233 search_table chris_table$,chris_id%,chrispos,rec_gtable%,search_chris$,16
24237 search_table place_table$,place_id%,placepos,rec_ptable%,search_place$,17
24241 search_table comment_table$,com_id%,commentpos,rec_ctable%,search_com$,18
24245 search_table source_table$,source_id%,sourcepos,rec_stable%,search_source$,19
24249 spelling_check rec_ftable%,search_sur$,0
24253 maiden_names 1,search_sur$
24257 search_area
24261 FOR i=1 TO num_recs
24265    IF selected(i)=total_count:count=count+1:ELSE selected(i)=0
24269    IF count=max_recs
24273       IF i<num_recs:FOR j=i+1 TO num_recs:selected(j)=0
24277       EXIT i
24281    END IF
24285 END FOR i
24289 IF NOT count:er "No records are selected",""
24293 RETurn count
24297 END DEFine
24301 :
24305 DEFine FuNction select_docs
24309 LOCal i,j
24313 DIM selected(num_recs)
24317 j=check_rec:IF NOT j:RETurn 3
24321 DIM doc_table%(j-1):j=0
24325 FOR i=1 TO num_recs:IF selected(i):doc_table%(j)=i:j=j+1
24329 gotdocs=j-1
24333 RETurn 0
24337 END DEFine
24341 :
24345 DEFine PROCedure show_notes
24349 LOCal note_loop,j,kk,k,show_loop
24353 load_records 20,0
24357 IF exit_flag:RETurn
24361 IF recs_file$<>recs_dev$&'NOT':RETurn
24365 REPeat note_loop
24369   gotdocs=-1
24373   IF num_recs
24377     j=0:FOR i=1 TO num_recs:IF ABS(rec_ref%(i))=person:j=j+1
24381     IF j
24385       DIM doc_table%(j-1):j=0
24389       FOR i=1 TO num_recs:IF ABS(rec_ref%(i))=person:doc_table%(j)=i:j=j+1
24393       gotdocs=j-1
24397       IF gotdocs>=0:kk=list_recs(0,doc_table%,gotdocs,note_menu$,2)
24401     END IF
24405   END IF
24409   IF gotdocs=-1:IF warn('No notes for this person','do you want to ADD','Add'):kk=-3:ELSE kk=-1
24413   SELect ON kk
24417     =0 TO gotdocs
24421       REPeat show_loop
24425         k=show_page(-1,-1,doc_table%(kk),ti_menu$,1)
24429         SELect ON k
24433           =1:shut ft_chan:IF get_text(doc_table%(kk)):EXIT show_loop
24437           =0:EXIT show_loop
24441         END SELect
24445       END REPeat show_loop
24449     =-1:put_note(0)
24453     =-2:print_recs(3)
24457     =-3:EXIT note_loop
24461   END SELect
24465 END REPeat note_loop
24469 END DEFine
24473 :
24477 DEFine PROCedure show_text(inum)
24481 LOCal m$
24485 m$=comment$(rec_ctable%,inum)
24489 IF 'TEXT=' INSTR m$=1:display_file 0,m$(6 TO)
24493 IF 'IMAGE=' INSTR m$=1
24497   m$=m$(7 TO)
24501   get_device(m$):get_directory m$
24505   IF NOT check_dir(file$,1,1)
24509     LOAD_SCREENX m$
24513     dump_screen
24517     clear_screen
24521   END IF
24525 END IF
24529 END DEFine
24533 :
24537 DEFine FuNction get_dest$
24541 LOCal kk,a$
24545 DIM options$(0,40)
24549 options$(0)=list_file$&FILL$(' ',40)(1 TO 40)
24553 kk=get_opt(1,0,options$,1,stick_chan,dest_menu$,1,1)
24557 SELect ON kk
24561    =-1:eol$='':lm$='':fount_type=4:a$='scr'
24565    =-2:eol$=eol_char$:lm$=FILL$(' ',lm):a$=print_dev$
24569        IF fount_type=4:fount_type=1
24573    =0,-3:eol$='':lm$='':fount_type=1
24577       OPEN #stick_chan,'con_'
24581       DR_AWDF #stick_chan,wdefs(stick_chan),0:set_colours stick_chan,1
24585       get_field 40,stick_chan,0,0,0,list_file$
24589       CLOSE #stick_chan
24593       a$=list_file$
24597 END SELect
24601 shut stick_chan
24605 RETurn a$
24609 END DEFine get_dest$
24613 :
24617 DEFine PROCedure copy_rec(opt,recnum)
24621    rec_type%(num_recs)=rec_type%(opt)
24625    rec_ftable%(num_recs)=rec_ftable%(opt)
24629    IF rec_link%(opt)
24633       rec_link%(num_recs)=rec_link%(opt)
24637    ELSE
24641       rec_link%(num_recs)=rec_id%(opt)
24645    END IF
24649    rec_date(num_recs)=rec_date(opt)
24653    rec_stamp(num_recs)=DATE
24657    rec_id%(num_recs)=recnum
24661    rec_file%(num_recs)=rec_file%(opt)
24665    rec_gtable%(num_recs)=rec_gtable%(opt)
24669    rec_ptable%(num_recs)=rec_ptable%(opt)
24673    rec_stable%(num_recs)=rec_stable%(opt)
24677    rec_ctable%(num_recs)=rec_ctable%(opt)
24681    rec_ref%(num_recs)=rec_ref%(opt)
24685    rec_relate%(num_recs)=rec_relate%(opt)
24689    rec_exdate%(num_recs)=rec_exdate%(opt)
24693 END DEFine copy_rec
24697 :
24701 DEFine PROCedure set_table(sort_flag)
24705 SELect ON sort_flag
24709    =15:table_pos=surpos:table_max=surnum:table_len=len_sur
24713    =16:table_pos=chrispos:table_max=chrisnum:table_len=len_chris
24717    =17:table_pos=placepos:table_max=placenum:table_len=len_place
24721    =18:table_pos=commentpos:table_max=commentnum:table_len=len_com
24725    =19:table_pos=sourcepos:table_max=sourcenum:table_len=len_source
24729 END SELect
24733 END DEFine set_table
24737 :
24741 DEFine FuNction stick_date(k,opt)
24745 LOCal i,kk,temp$
24749 DIM options$(0,opt)
24753 i=k
24757 SELect ON opt
24761    =12:options$(0)=d$
24765    =23:temp$=DATE$
24769        options$(0)=DAY$&temp$(9 TO 11)&temp$(5 TO 9)&temp$(1 TO 4)&temp$(12 TO 17)&' '
24773 END SELect
24777 kk=get_opt(1,0,options$,1,stick_chan,ok_menu$,1,1)
24781 IF NOT kk
24785    OPEN #stick_chan,'con_'
24789    DR_AWDF #stick_chan,wdefs(stick_chan),0:set_colours stick_chan,1
24793    next_field=1
24797    SELect ON opt
24801       =12:i=get_date(stick_chan,0,0,0)
24805       =23:change_clock
24809    END SELect
24813    CLOSE #stick_chan
24817 END IF
24821 shut stick_chan
24825 RETurn i
24829 END DEFine
24833 :
24837 DEFine PROCedure search_table(table_name$,id%,table_pos,recs%,a$,sort_flag)
24841 LOCal i,k,dmpos,s_loop,j,l,m,search_init
24845 LOCal b$,lb
24849 IF a$='' OR a$=' ':RETurn
24853 IF search_radius AND search_origin AND sort_flag=17:RETurn
24857 j=2^(sort_flag-15)
24861 search_init=0
24865 b$=a$:lb=LEN(b$):IF b$(lb)='*':search_init=1:b$=b$(1 TO lb-1)
24869 FOR i=1 TO table_pos
24873    l=b$ INSTR table_name$(i):m=table_name$(i) INSTR b$
24877    IF l OR m AND table_name$(i)<>''
24881       IF (search_init AND l=1) OR NOT search_init
24885          dmpos=0
24889          REPeat s_loop
24893             k=search_array%(recs%,dmpos,id%(i))
24897             IF k<0 OR k>DIMN(selected):EXIT s_loop
24901             selected(k)=selected(k)+j
24905             dmpos=k+1
24909          END REPeat s_loop
24913       END IF
24917    END IF
24921 END FOR i
24925 total_count=total_count+j
24929 END DEFine search_table
24933 :
24937 DEFine PROCedure spelling_check(recs%,search$,opt)
24941 LOCal i,j,k,l,s_loop,dmpos,m
24945 IF search$='' OR search$=' ':RETurn
24949 IF search$(LEN(search$))='*':RETurn
24953 IF spell<10:RETurn
24957 FOR i=0 TO spell-10 STEP 10
24961    FOR j=1 TO 10
24965       l=search_array%(sur_id%,0,spelling%(i+j))
24969       IF l<=0:EXIT j
24973       IF search$ INSTR surname_table$(l) OR surname_table$(l) INSTR search$
24977          FOR m=1 TO 10
24981             l=search_array%(sur_id%,0,spelling%(i+m))
24985             IF NOT l:EXIT m
24989             SELect ON opt
24993                =0:dmpos=0
24997                   REPeat s_loop
25001                      k=search_array%(recs%,dmpos,sur_id%(l))
25005                      IF k<0:EXIT s_loop
25009                      IF NOT (1&&selected(k)):selected(k)=selected(k)+1
25013                      dmpos=k+1
25017                   END REPeat s_loop
25021                 =1:IF NOT (1&&selected(l)):selected(l)=selected(l)+1
25025             END SELect
25029          END FOR m
25033       END IF
25037    END FOR j
25041 END FOR i
25045 END DEFine spelling_check
25049 :
25053 DEFine PROCedure select_table(table_name$,id%,table_pos,a$,sort_flag)
25057 LOCal i,j,b$,search_init,lb
25061 j=2^(sort_flag-15)
25065 IF search_radius AND search_origin AND sort_flag=17
25069    FOR i=1 TO table_pos
25073       k=distance(i,search_origin)
25077       IF k>=0 AND k<=search_radius
25081          selected(id%(i))=selected(id%(i))+j
25085       END IF
25089    END FOR i
25093 ELSE
25097    IF a$=' ':a$=''
25101    IF a$=''
25105       FOR i=0 TO table_pos:selected(i)=selected(i)+j
25109    ELSE
25113       search_init=0
25117       b$=a$:lb=LEN(b$):IF b$(lb)='*':search_init=1:b$=b$(1 TO lb)
25121       IF search_init
25125          FOR i=1 TO table_pos
25129             IF b$ INSTR table_name$(i)=1 AND table_name$(i)<>''
25133                selected(id%(i))=selected(id%(i))+j
25137             END IF
25141          END FOR i
25145       ELSE
25149          FOR i=1 TO table_pos
25153             IF (b$ INSTR table_name$(i) OR table_name$(i) INSTR b$) AND table_name$(i)<>''
25157                selected(id%(i))=selected(id%(i))+j
25161             END IF
25165          END FOR i
25169       END IF
25173    END IF
25177 END IF
25181 END DEFine select_table
25185 :
25189 DEFine FuNction get_rank$(ik,j)
25193 LOCal l,a$
25197 l=rank%(ik)
25201 SELect ON l
25205    =0:a$='':d=0
25209    =1:a$=note_type$(rec_type%(j)):d=9
25213    =2:a$=file_type$(rec_file%(j))&rec_id%(j):d=8
25217    =3:a$=condat$(rec_exdate%(j),rec_date(j)):d=12
25221    =4:a$=given$(rec_gtable%,j):d=m_chris
25225    =5:a$=family$(rec_ftable%,j):d=m_sur
25229    =6:a$=place$(rec_ptable%,j):d=m_place
25233    =7:a$=get_county$(j):d=3
25237    =8:a$=comment$(rec_ctable%,j):d=m_com
25241    =9:a$=source$(rec_stable%,j):d=m_source
25245    =10:a$=stamp$(rec_stamp(j)):d=13
25249    =11:a$=rec_ref%(j):d=5
25253    =12:a$=relationship$(rec_relate%(j)):d=16
25257 END SELect
25261 RETurn a$
25265 END DEFine get_rank$
25269 :
25273 DEFine PROCedure setup_find
25277 find_sur$='':find_chris$='':find_mark$='':find_year=0:find_stat=0
25281 END DEFine setup_find
25285 :
25289 DEFine PROCedure maiden_names(opt,search$)
25293 LOCal i
25297 IF search$='' OR search$=' ':RETurn
25301 IF search$(LEN(search$))='*':RETurn
25305 SELect ON opt
25309    =0:FOR i=1 TO num_names
25313          IF (selected(i)&&1) AND ma%(i) AND selected(i)>0
25317             IF NOT (selected(ABS(ma%(i)))&&1):selected(ABS(ma%(i)))=-(selected(ABS(ma%(i)))+1)
25321          END IF
25325       END FOR i
25329       FOR i=1 TO num_names:selected(i)=ABS(selected(i))
25333    =1:FOR i=1 TO num_recs
25337          IF NOT (selected(i)&&1) AND rec_type%(i)=3 AND rec_relate%(i)=208
25341             IF (selected(rec_pos(rec_link%(i)))&&1):selected(i)=selected(i)+1
25345          END IF
25349       END FOR i
25353 END SELect
25357 END DEFine maiden_names
25361 :
25365 DEFine PROCedure status_check
25369 LOCal i
25373 SELect ON find_stat
25377 =0:RETurn
25381 =1:FOR i=1 TO num_names
25385     IF fa%(i)=0:IF ma%(i)=0:selected(i)=selected(i)+64:mark i,3
25389   END FOR i
25393 =2:FOR i=1 TO num_names
25397     IF check_parent(ma%)=1 OR check_parent(fa%)=1:selected(i)=selected(i)+64:mark i,3
25401   END FOR i
25405 =3:FOR i=1 TO num_names
25409     IF check_parent(ma%)<1:IF check_parent(fa%)<1:selected(i)=selected(i)+64:mark i,3
25413   END FOR i
25417 END SELect
25421 total_count=total_count+64
25425 END DEFine
25429 :
25433 DEFine FuNction check_parent(arr%)
25437 LOCal x
25441 x=search_array%(arr%,0,i)
25445 IF x>0:IF '(System Name)' INSTR full_name$(x):x=0
25449 IF x>0:RETurn 1
25453 x=search_array%(arr%,0,-i)
25457 IF x>0:IF '(System Name)' INSTR full_name$(x):x=1
25461 IF x>0:RETurn -1
25465 RETurn 0
25469 END DEFine
25473 :
25477 DEFine FuNction search_title$
25481 LOCal m$
25485 m$=''
25489 IF search_chris$<>'' OR search_sur$<>'':IF reverse_names:m$=m$&'Name:'&search_sur$&' '&search_chris$:ELSE m$=m$&'Name:'&search_chris$&' '&search_sur$
25493 m$=m$&' Years:'&f$&'-'&t$
25497 m$=m$&' Event:'&note_type$(search_type)
25501 IF search_sex:m$=m$&' Sex:'&search_sex
25505 IF search_radius AND search_origin:m$=m$&' Place:'&search_radius&' '&units$&' around '&search_place$:ELSE IF search_place$<>'':m$=m$&' Place:'&search_place$
25509 IF search_county$<>'':m$=m$&' County:'&search_county$
25513 IF search_com$<>'':m$=m$&' Comment:'&search_com$
25517 IF search_source$<>'':m$=m$&' Source:'&search_source$
25521 IF search_stamp$<>']':m$=m$&' Stamp:'&search_stamp$
25525 RETurn m$
25529 END DEFine search_title$
25533 :
25537 DEFine PROCedure dump_screen
25541 IF get_opt(0,1,map_menu$,2,menu_chan,'',0,1):RETurn
25545 SDP_DEV get_dest$
25549 SDUMP
25553 END DEFine
25557 :
25561 DEFine PROCedure start_search
25565 big_table=1
25569 IF surpos>big_table:big_table=surpos
25573 IF chrispos>big_table:big_table=chrispos
25577 IF placepos>big_table:big_table=placepos
25581 IF commentpos>big_table:big_table=commentpos
25585 IF sourcepos>big_table:big_table=sourcepos
25589 DIM selected(big_table)
25593 select_table surname_table$,sur_id%,surpos,search_sur$,15
25597 select_table chris_table$,chris_id%,chrispos,search_chris$,16
25601 select_table place_table$,place_id%,placepos,search_place$,17
25605 select_table comment_table$,com_id%,commentpos,search_com$,18
25609 select_table source_table$,source_id%,sourcepos,search_source$,19
25613 spelling_check '',search_sur$,1
25617 END DEFine
25621 :
25625 DEFine FuNction get_capital$(message$)
25629 LOCal a$,j,b$
25633 a$=' '
25637 FOR j=1 TO LEN(message$)
25641    b$=message$(j)
25645    IF CODE(b$)>=65 AND CODE(b$)<=90:a$=b$:EXIT j
25649 END FOR j
25653 RETurn a$
25657 END DEFine
25661 :
25665 DEFine PROCedure get_distance
25669 LOCal a$,b$,j,num,i
25673 a$=PICK_table$(place_table$,len_place,placepos,'')
25677 num=pick_num
25681 IF num<1:RETurn
25685 m6 "Distance from: "&a$&' TO'
25689 b$=PICK_table$(place_table$,len_place,placepos,'')
25693 j=pick_num
25697 qwindow stat_chan
25701 IF j<1:RETurn
25705 i=distance(num,j)
25709 IF i>=0
25713    point_window -1,-1,data_chan,438,32
25717    PRINT #data_chan,"The distance from "&a$&' - '&get_grid$(num)
25721    PRINT #data_chan,"               to "&b$&' - '&get_grid$(j)
25725    PRINT #data_chan,"is approximately ";i;" "&units$
25729    resume:qwindow data_chan
25733 ELSE
25737    er 'Cannot compute distance','Check grid references'
25741 END IF
25745 END DEFine
25749 :
25753 DEFine PROCedure get_grids
25757 LOCal i,c$
25761 IF NOT placepos:er 'No Place table exists','':RETurn
25765 m6 'Enter grid ref in the format TQ1234'
25769 FOR i=1 TO placepos
25773    c$=""
25777    IF num_county:c$=county$(county_table%(i))
25781    IF place_table$(i)<>'' AND place_table$(i)<>' ' AND c$<>' -'
25785       IF NOT grid_table(i):IF update_grid(i):EXIT i
25789    END IF
25793 END FOR i
25797 qwindow stat_chan
25801 END DEFine
25805 :
25809 DEFine PROCedure get_counties
25813 LOCal i,a$
25817 IF NOT num_county:er 'No COU counties file was loaded','':RETurn
25821 IF NOT placepos:er 'No Place table exists','':RETurn
25825 set_anchor 30,20,table_chan
25829 FOR i=1 TO placepos
25833    a$=place_table$(i)
25837    IF a$<>'' AND a$<>' ' AND NOT county_table%(i)
25841       m6 'Select county for '&a$
25845       a$=PICK_table$(county$,3,num_county,'')
25849       IF pick_num<0:EXIT i
25853       county_table%(i)=pick_num
25857       table_edits=1
25861    END IF
25865 END FOR i
25869 shut table_chan
25873 qwindow stat_chan
25877 END DEFine get_counties
25881 :
25885 DEFine PROCedure list_tables(table_name$,sort_flag)
25889 LOCal a$,i,c$
25893 set_table(sort_flag)
25897 IF pcw(3):RETurn
25901 IF column$=='on':column_flag=1:column_width=table_len
25905 IF sort_flag=17:column_width=column_width+11
25909 print_heads "Table Listing"
25913 report_title$="Table Listing"
25917 FOR i=1 TO table_pos
25921    a$=table_name$(i)&FILL$(' ',table_len)
25925    IF sort_flag=17
25929       c$=''
25933       IF num_county:c$=' '&county$(county_table%(i))
25937       IF fprinter(a$(1 TO table_len)&c$&' '&get_grid$(i)):EXIT i
25941    ELSE
25945       IF fprinter(table_name$(i)):EXIT i
25949    END IF
25953 END FOR i
25957 print_tails
25961 END DEFine list_tables
25965 :
25969 DEFine FuNction family$(table%,num)
25973 RETurn lookup_table$(surname_table$,15,sur_id%,table%,num)
25977 END DEFine family$
25981 :
25985 DEFine FuNction given$(table%,num)
25989 RETurn lookup_table$(chris_table$,16,chris_id%,table%,num)
25993 END DEFine given$
25997 :
26001 DEFine FuNction place$(table%,num)
26005 RETurn lookup_table$(place_table$,17,place_id%,table%,num)
26009 END DEFine place$
26013 :
26017 DEFine FuNction comment$(table%,num)
26021 RETurn lookup_table$(comment_table$,18,com_id%,table%,num)
26025 END DEFine comment$
26029 :
26033 DEFine FuNction source$(table%,num)
26037 RETurn lookup_table$(source_table$,19,source_id%,table%,num)
26041 END DEFine source$
26045 :
26049 DEFine PROCedure search_area
26053 LOCal i,k,dmpos,s_loop
26057 IF NOT search_radius OR NOT search_origin:RETurn
26061 FOR i=1 TO placepos
26065    k=distance(i,search_origin)
26069    IF k>=0 AND k<=search_radius
26073       dmpos=0
26077       REPeat s_loop
26081          k=search_array%(rec_ptable%,dmpos,place_id%(i))
26085          IF k<0 OR k>DIMN(selected):EXIT s_loop
26089          selected(k)=selected(k)+4
26093          dmpos=k+1
26097       END REPeat s_loop
26101    END IF
26105 END FOR i
26109 total_count=total_count+4
26113 END DEFine search_area
26117 :
26121 DEFine FuNction get_county$(num)
26125 LOCal k
26129 IF NOT num_county:RETurn ''
26133 IF num<1 OR num>num_recs:RETurn ''
26137 k=search_array%(place_id%,1,rec_ptable%(num))
26141 IF k<=0 OR k>placepos:RETurn ''
26145 IF county_table%(k)<0 OR county_table%(k)>DIMN(county$):RETurn ''
26149 RETurn county$(county_table%(k))
26153 END DEFine county$
26157 :
26161 DEFine PROCedure update_groom
26165 LOCal a$
26169 IF next_rel=208 AND comment$(rec_ctable%,num_recs-1)<>mar_char$
26173    a$=mar_char$&s2$&" "&comment$(rec_ctable%,num_recs-1)
26177    rec_ctable%(num_recs-1)=add_table%(comment_table$,com_id%,a$,18)
26181 END IF
26185 END DEFine update_groom
26189 :
26193 DEFine FuNction search_array%(array,start%,string)
26197 LOCal iar%
26201 RETurn INARRAY%(array,start%,string)
26205 REMark rest is for sms2 which crashes in inarray%
26209 REMark too slow to make general
26213 IF start%>DIMN(array):RETurn -2
26217 FOR iar%=start% TO DIMN(array)
26221    IF array(iar%)=string:RETurn iar%
26225 END FOR iar%
26229 RETurn -1
26233 END DEFine
26237 :
26241 DEFine PROCedure LOAD_SCREENX (scr_name$)
26245 sys$=VER$
26249 IF sys$=='HBA'
26253   OPEN #io_chan,scr_name$
26257   s=SCR_BASE
26261   FOR l=0 TO 255
26265     FOR z=0 TO 31
26269       LGET #io_chan,w:POKE_L s,w:s=s+4
26273     END FOR z
26277     s=s+SCR_LLEN-128
26281   END FOR l
26285   CLOSE #io_chan
26289 ELSE
26293   LBYTES scr_name$,131072
26297 END IF
26301 END DEFine
26305 :
26309 DEFine PROCedure Link_spouses
26313 LOCal i
26317 REMark Ensure all married people have a Child / System Child!!
26321 m6 'Checking Links Between Spouses'
26325 FOR i=1 TO num_names
26329   IF '*DELETED*' INSTR family$(ftable%,i):IF NOT '(System Name)' INSTR full_name$(i):IF fa%(i)<>0:IF ma%(i)<>0:zero_names(i):rec_edits=1:NEXT i:EXIT i
26333   IF family$(ftable%,i)='':IF given$(gtable%,i)='':zero_names(i):ftable%(i)=add_table%(surname_table$,sur_id%,"*DELETED*",15):rec_edits=1:NEXT i:EXIT i
26337   IF ma%(i)<0:spouse2=-ma%(i):ELSE spouse2=0
26341   IF fa%(i)<0:spouse2=-fa%(i)
26345   IF spouse2=0:NEXT i:EXIT i
26349   pch=add_system_child(i,spouse2):IF pch=0:RETurn
26353   IF pch=1:rec_edits=1
26357 END FOR i
26361 IF rec_edits:rec_edits=warn("Family Tree Updated","Please SAVE file","")
26365 qwindow stat_chan
26369 END DEFine
26373 :
26377 DEFine FuNction find_slot
26381 LOCal i%,i2%,s1,s2
26385 s1=0
26389 REPeat all_deleted
26393   i%=search_array%(surname_table$,s1,'*DELETED*' )
26394   s1=i%+1
26397   IF i%<=0:EXIT all_deleted
26401   i%=sur_id%(i%)
26405   IF i%<=0:EXIT all_deleted
26409   s2=0
26413   REPeat all_links
26417     i2%=search_array%(ftable%,s2,i%)
26421     IF i2%<=0:EXIT all_links:ELSE s2=i2%+1
26425     IF '(System Name)' INSTR full_name$(i2%)=0:RETurn i2%
26429   END REPeat all_links
26437 END REPeat all_deleted
26441 IF num_names<max_names
26445   num_names=num_names+1:RETurn num_names
26449 END IF
26453 er "Cannot add another NAME","SAVE and RELOAD to increase limit"
26457 RETurn 0
26461 END DEFine
26465 :
26469 DEFine FuNction find_child(sp1,sp2)
26473 LOCal tp%,j%,xa$(40)
26477 IF sp1<=0 OR sp2<=0:RETurn 0
26481 xa$=full_name$(sp1)
26485 IF '(System Name)' INSTR xa$ OR '*DELETED*' INSTR xa$:RETurn 0
26489 xa$=full_name$(sp2)
26493 IF '(System Name)' INSTR xa$ OR '*DELETED*' INSTR xa$:RETurn 0
26497 tp%=0
26501 REPeat lp1%
26505   j%=search_array%(fa%,tp%,sp1)
26509   IF j%<0:EXIT lp1%
26513   IF ma%(j%)=sp2:RETurn j%
26517   tp%=j%+1
26521 END REPeat lp1%
26525 tp%=0
26529 REPeat lp2%
26533   j%=search_array%(ma%,tp%,sp1)
26537   IF j%<0:EXIT lp2%
26541   IF fa%(j%)=sp2:RETurn j%
26545   tp%=j%+1
26549 END REPeat lp2%
26553 RETurn -1
26557 END DEFine
26561 :
26565 DEFine FuNction find_system_child(sp1,sp2)
26569 LOCal j%
26573 j%=find_child(sp1,sp2)
26577 IF j%>0:IF '(System Name)' INSTR full_name$(j%):RETurn j%
26581 RETurn 0
26585 END DEFine
26589 :
26593 DEFine PROCedure list_persons
26597 LOCal j,k,a$,b$,nm$
26601 REMark Produce a list of everyone who is in the data
26605 IF fprinter ('Network ID  Details of Person'):RETurn
26609 FOR j=0 TO num_names
26613   IF selected(j)
26617     b$=j
26621     SELect ON form
26625       =0:nm$=given$(gtable%,j)&' '&family$(ftable%,j)&dates$(j)
26629       =1:nm$=family$(ftable%,j)&FILL$(' ',len_sur-LEN(family$(ftable%,j))+1)&given$(gtable%,j)&dates$(j)
26633     END SELect
26637     a$=b$&FILL$('.',12-LEN(b$))&nm$
26641     IF exit_flag:EXIT j
26645     IF fprinter(a$):EXIT j
26649   END IF
26653 END FOR j
26657 END DEFine
26661 :
26665 DEFine PROCedure update_parents(k)
26669 LOCal f$,m$,g$,kk,mumdad,oldfa%,oldma%
26673 oldfa%=fa%(k):oldma%=ma%(k):newfa%=oldfa%:newma%=oldma%
26677 IF oldfa%<0:oldfa%=0:newfa%=0
26681 IF oldma%<0:oldma%=0:newma%=0
26685 REPeat Xloop
26689   DIM options$(1,65)
26693   alter=k
26697   f$='Father ':m$='Mother '
26701   IF fa%(k)<0
26705     options$(0)=f$&' Unknown':j=add_system_child(k,ABS(fa%(k))):fa%(k)=0
26709   ELSE
26713     options$(0)=f$&' #      '&newfa%&' '&full_name$(newfa%)
26717     IF newfa%=0:options$(0)=f$&' Unknown'
26721   END IF
26725   IF ma%(k)<0
26729     options$(1)=m$&' Unknown':j=add_system_child(k,ABS(ma%(k))):ma%(k)=0
26733   ELSE
26737     options$(1)=m$&' #      '&newma%&' '&full_name$(newma%)
26741     IF newma%=0:options$(1)=m$&' Unknown'
26745   END IF
26749   kk=get_opt(0,1,options$,1,table_chan,ok_menu$,1,1)
26753   SELect ON kk
26757     =0:x=newfa%:newfa%=stick_up$(0,'Father:',x,6,6)
26761     =1:x=newma%:newma%=stick_up$(0,'Mother:',x,6,6)
26765    =-1:mumdad=0
26769        IF newfa%=alter OR newma%=alter:er "Father or Mother network no same as subject","":mumdad=1
26773        IF newfa%<0:er "Invalid Network ID For Father","":mumdad=1
26777        IF newma%<0:er "Invalid Network ID For Mother","":mumdad=1
26781        IF newfa%<>0:IF newfa%=newma%:er "Father and Mother have the same number!","":mumdad=1
26785        IF mumdad:fa%(alter)=newfa%:ma%(alter)=newma%:NEXT Xloop
26789        IF oldfa%<>newfa% OR oldma%<>newma%
26793          j=find_child(newma%,newfa%)
26797          IF j>0
26801            IF '(System Name)' INSTR full_name$(j)
26805              remove_person j,1
26809            ELSE
26813              IF oldfa%<>newfa%:attach%(newfa%)=attach%(newfa%)+1
26817              IF oldma%<>newma%:attach%(newma%)=attach%(newma%)+1
26821            END IF
26825          ELSE
26829            attach%(newfa%)=attach%(newfa%)+101
26833            attach%(newma%)=attach%(newma%)+101
26837          END IF
26841          fa%(alter)=newfa%:ma%(alter)=newma%
26845          IF oldfa%>0:attach%(oldfa%)=attach%(oldfa%)-1
26849          IF oldma%>0:attach%(oldma%)=attach%(oldma%)-1
26853          IF oldfa%>=0:IF oldma%>=0:IF find_child(oldfa%,oldma%)<=0:attach%(oldfa%)=attach%(oldfa%)-100:attach%(oldma%)=attach%(oldma%)-100
26857          IF attach%(oldfa%)<0:attach%(oldfa%)=attach%(oldfa%)+100
26861          IF attach%(oldma%)<0:attach%(oldma%)=attach%(oldma%)+100
26865          IF oldfa%>0:IF oldma%>0:j=add_system_child(oldfa%,oldma%)
26869        END IF
26873        RETurn
26877   END SELect
26881 END REPeat Xloop
26885 END DEFine
26889 :
26893 DEFine PROCedure update_spouse(k)
26897 LOCal Xloop,j,i%,oldx
26901 IF sex%(k)=2:m$='Husband ':ELSE m$='Wife    '
26905 IF sex%(k)=2:f$='Husband:':ELSE f$='Wife:'
26909 IF fa%(k)<0:j=add_system_child(ABS(fa%(k)),k):fa%(k)=0
26913 IF ma%(k)<0:j=add_system_child(ABS(ma%(k)),k):ma%(k)=0
26917 REPeat Xloop
26921   DIM options$(10,65),spouse_no%(10)
26925   sp_no=-1
26929   FOR i%=1 TO num_names
26933     IF find_child(k,i%)>0:sp_no=sp_no+1:options$(sp_no)=m$&'#'&i%&' '&full_name$(i%):spouse_no%(sp_no)=i%:IF sp_no=10:EXIT i%
26937   END FOR i%
26941   IF sp_no=-1:er 'This person is not married','':RETurn
26945   kk=get_opt(0,sp_no,options$,1,table_chan,ok_menu$,1,1)
26949   SELect ON kk
26953     =0 TO sp_no:x=spouse_no%(kk):oldx=x:x=stick_up$(0,f$,x,6,6)
26957                 IF x<>oldx
26961                   j=find_system_child(oldx,k)
26965                   IF j>0
26969                     ma%(j)=0:fa%(j)=0:attach%(oldx)=attach%(oldx)-101
26973                     zero_names(j):attach%(k)=attach%(k)-101
26977                     mark j,7
26981                     ftable%(j)=add_table%(surname_table$,sur_id%,"*DELETED*",15)
26985                     gtable%(j)=add_table%(chris_table$,chris_id%,"",16)
26989                   ELSE
26993                     IF j=0:IF find_child(oldx,k)>0:er 'Cannot remove connection to #'&oldx,'# '&find_child(oldx,k)&' listed as their child'
26997                   END IF
27001                   IF x>0
27005                     IF x=k:er "Spouse has same Network no as subject","":NEXT Xloop
27009                     already_spouse=0
27013                     FOR i%=0 TO sp_no:IF spouse_no%(i%)=x:IF i%<>kk:already_spouse=1:EXIT i%
27017                     IF NOT already_spouse
27021                       j=add_system_child(x,k)
27025                       spouse_no%(kk)=x
27029                     END IF
27033                   END IF
27037                 END IF
27041     =-1:RETurn
27045   END SELect
27049 END REPeat Xloop
27053 END DEFine
27057 :
27061 DEFine FuNction add_system_child(sp1,sp2)
27065 LOCal j,pch
27069 j=find_child(sp1,sp2)
27073 IF j<0
27077   pch=find_slot
27081   IF pch<=0:RETurn 0
27085   IF sex%(sp1)=1:fa%(pch)=sp1:ma%(pch)=sp2:ELSE fa%(pch)=sp2:ma%(pch)=sp1
27089   gtable%(pch)=add_table%(chris_table$,chris_id%,'(System Name)',16)
27093   attach%(sp1)=attach%(sp1)+101:attach%(sp2)=attach%(sp2)+101
27097   yofb(pch)=99999
27101   RETurn 1
27105 END IF
27109 RETurn -1
27113 END DEFine
27117 :
27121 DEFine PROCedure add_child(parent,subj,alter)
27125 j1=find_system_child(subj,parent)
27129 IF j1=0
27133   attach%(parent)=attach%(parent)+1
27137   IF sex%(parent)=1:fa%(alter)=parent:ELSE ma%(alter)=parent
27141 ELSE
27145   IF NOT old
27149     ftable%(j1)=0:gtable%(j1)=0:yofb(j1)=0:yofd%(j1)=0
27153     IF alter=num_names:IF full_name$(alter)=' ':num_names=num_names-1
27157     mark%(j1)=0:user_mark%(j1)=0:alter=j1
27161   ELSE
27165     zero_names(j1)
27169     mark j1,7
27173     ftable%(j1)=add_table%(surname_table$,sur_id%,"*DELETED*",15)
27177     gtable%(j1)=add_table%(chris_table$,chris_id%,"",16)
27181   END IF
27185   attach%(subj)=attach%(subj)-1
27189   IF NOT qmark%(alter,'M'):IF NOT qmark%(alter,'F'):mark%(alter)=mark%(alter)+m
27193 END IF
27197 END DEFine
30973 :
30977 DEFine PROCedure DRAW_sprt (ch,x1,y1)
30978 LOCal tmp_patt$(32,32),i%,x0
30979 LOCal xs,ys, xo,yo, md, l
30981 RESTORE 31989
31061 xs=0:ys=-1:READ xo,yo,md
31065 REPeat l
31069   READ x$:IF x$='':EXIT l
31073   ys=ys+1:tmp_patt$(ys)=x$&FILL$(' ',32)
31077   IF LEN(x$)>xs:xs=LEN(x$)
31087 END REPeat l
31092 x0=x1
31097 FOR i%=0 TO ys
31107   FOR l=0 TO xs
31117     xo=CODE(tmp_patt$(i%,l))
31127     SELect ON xo
31137       =CODE('w'):BLOCK #ch,1,1,x1,y1,7
31138       =CODE('r'):BLOCK #ch,1,1,x1,y1,2
31139       =CODE('g'):BLOCK #ch,1,1,x1,y1,4
31140       =CODE('a'):BLOCK #ch,1,1,x1,y1,0
31150     END SELect
31160     x1=x1+1
31170   END FOR l
31180   y1=y1+1:x1=x0
31190 END FOR i%
31200 END DEFine
31210 :
31220 DEFine PROCedure TEST_MEMORY
31225 LOCal xmem
31230 IF exiting=1:RETurn
31240 xmem=FREE_MEM
31245 IF xmem>=125*1024:RETurn
31246 exiting=1
31250 er 'Program Short of memory','Attempting to save existing data'
31260 save_recs
31270 STOP
31280 END DEFine
31290 :
31300 DEFine PROCedure Update_history
31301 LOCal i%
31302 IF current_view:RETurn
31305 IF hist_pos<max_history
31310   hist_pos=hist_pos+1
31320 ELSE
31330   FOR i%=0 TO hist_pos-1:history%(i%)=history%(i%+1)
31335 END IF
31340 history%(hist_pos)=person
31350 END DEFine
31360 :
31989 DATA 32,32,4
31993 DATA 'wwwwwwwwwwwwwwwwwwwwwwwwwwwwww'
31994 DATA 'wggggggggggggggwrrrrrrrrrrwwww'
31995 DATA 'wggggggggggggggwrrrrrrrrrwwwrw'
31996 DATA 'wggggggggggggggwrrrrrrrrwwwrrw'
31997 DATA 'wggggggggggggggwrrrrrrrwwwrrrw'
32001 DATA 'wggggggggggggggwrrrrrrwwwwrrrw'
32002 DATA 'wggggggggggggggwrrrrrwwwrrrrrw'
32003 DATA 'wggggggggggggggwrrrrwwwrrrrrrw'
32004 DATA 'wggggggggggggggwrrrwwwrrrrrrrw'
32005 DATA 'wggggggggggggggwrrwwwrrrrrrrrw'
32006 DATA 'wggggggggggggggwrwwwrrrrrrrrrw'
32007 DATA 'wggggggggggggggwwwwrrrrrrrrrrw'
32008 DATA 'wggggggggggggggwwwrrrrrrrrrrrw'
32009 DATA ' wwwwwwwwwwwwwwwwwwwwwwwwwwww'
32013 DATA ' wrrrrrrrrrrrwwwggggggggggggw'
32014 DATA '  wrrrrrrrrrwwwwggggggggggggw'
32015 DATA '  wrrrrrrrrwwwrwggggggggggggw'
32016 DATA '   wrrrrrrwwwrrwgggggggggggw'
32017 DATA '   wrrrrrwwwrrrwgggggggggggw'
32018 DATA '    wrrrwwwrrrrwggggggggggw'
32019 DATA '    wrrwwwrrrrrwggggggggggw'
32020 DATA '     wwwwrrrrrrwgggggggggw'
32021 DATA '      wwrrrrrrrwggggggggw'
32022 DATA '       wrrrrrrrwgggggggw'
32023 DATA '        wrrrrrrwggggggw'
32024 DATA '         wwrrrrwggggww'
32025 DATA '           wrrrwgggw'
32026 DATA '            wwrwgww'
32027 DATA '              www'
32034 DATA ''
